<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mestre ‚Äî A √öltima Dose</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-texture: url('assets/dashboard.jpg'); /* Se n√£o tiver, vai usar a cor s√≥lida */
            --bg-dark: #140d0a; 
            --panel-bg: rgba(30, 20, 15, 0.95);
            --border-color: #8b6914;
            --text-main: #e6dccf;
            --gold: #ffcc80;
            --red: #d32f2f;
            --green: #388e3c;
            --shadow: 0 4px 20px rgba(0,0,0,0.8);
        }

        body {
            background-color: var(--bg-dark);
            background-image: var(--bg-texture);
            background-size: cover;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: 'Courier Prime', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* T√çTULO PRINCIPAL */
        h1 {
            font-family: 'Rye', serif;
            color: var(--gold);
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            width: 100%;
            max-width: 1200px;
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 30px;
            background: linear-gradient(to right, transparent, rgba(139, 105, 20, 0.2), transparent);
        }

        /* GRID PRINCIPAL */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 25px;
            width: 100%;
            max-width: 1400px;
        }

        /* ESTILO DOS PAIN√âIS */
        .panel-container {
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            padding: 20px;
            border-radius: 4px;
            box-shadow: var(--shadow);
            position: relative;
        }

        /* Detalhe nos cantos dos pain√©is (Cantoneiras) */
        .panel-container::before {
            content: '';
            position: absolute; top: -2px; left: -2px; width: 15px; height: 15px;
            border-top: 2px solid var(--gold); border-left: 2px solid var(--gold);
        }
        .panel-container::after {
            content: '';
            position: absolute; bottom: -2px; right: -2px; width: 15px; height: 15px;
            border-bottom: 2px solid var(--gold); border-right: 2px solid var(--gold);
        }

        h3 {
            font-family: 'Rye';
            margin: 0 0 20px 0;
            color: var(--gold);
            text-shadow: 1px 1px 0 #000;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px dashed #555;
            padding-bottom: 10px;
        }

        /* TABELA DE JOGADORES */
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        
        th {
            text-align: left;
            font-family: 'Rye';
            color: #aaa;
            padding: 10px 15px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        /* Linha do Jogador (Card look) */
        tbody tr {
            background: rgba(255, 255, 255, 0.03);
            transition: transform 0.2s, background 0.2s;
        }
        tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        td {
            padding: 15px;
            border-top: 1px solid rgba(139, 105, 20, 0.3);
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }
        
        /* Bordas arredondadas nas laterais da linha */
        td:first-child { border-left: 4px solid var(--border-color); border-radius: 6px 0 0 6px; }
        td:last-child { border-right: 1px solid rgba(139, 105, 20, 0.3); border-radius: 0 6px 6px 0; }

        .char-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--gold);
            text-shadow: 1px 1px 0 #000;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-ok { background: rgba(56, 142, 60, 0.2); color: #66bb6a; border: 1px solid #388e3c; }
        .status-bad { background: rgba(211, 47, 47, 0.2); color: #ef5350; border: 1px solid #d32f2f; }
        .status-neutral { color: #888; font-style: italic; }

        /* BOT√ïES GERAIS */
        .gm-btn {
            width: 100%;
            padding: 12px;
            font-family: 'Rye';
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            margin-bottom: 10px;
            transition: all 0.2s;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        .gm-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .gm-btn:active { transform: translateY(1px); box-shadow: none; }

        .btn-day { background: #263238; color: #fff; border: 1px solid #455a64; }
        .btn-damage { background: #5d1010; color: #ffcccc; border: 1px solid #8b0000; }
        .btn-roll { background: #5d4037; color: #ffcc80; border: 1px solid #8d6e63; }
        
        .btn-mini-xp {
            background: linear-gradient(45deg, #ffb300, #ff6f00);
            color: #2b1b12;
            border: 1px solid #ff6f00;
            font-family: 'Rye';
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .btn-mini-xp:hover { transform: scale(1.1); box-shadow: 0 0 10px #ffb300; }

        .btn-edit-mini {
            background: transparent; border: none; color: #aaa; cursor: pointer;
            font-size: 1rem; transition: color 0.2s;
        }
        .btn-edit-mini:hover { color: #fff; }

        /* CONTROLES E INPUTS */
        .gm-select {
            width: 100%; padding: 10px; margin-bottom: 10px;
            background: rgba(0,0,0,0.3); color: var(--gold);
            border: 1px solid #5d4037; font-family: 'Rye';
            cursor: pointer;
        }

        /* SPLIT ROW */
        .split-row { display: flex; gap: 15px; width: 100%; margin-bottom: 20px; }
        .split-item { flex: 1; display: flex; flex-direction: column; }

        /* REL√ìGIO E NPC */
        .widget-box {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid rgba(139, 105, 20, 0.2);
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .clock-visual {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 4px solid #3e2723;
            margin: 10px auto;
            box-shadow: inset 0 0 10px #000;
            transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #npc-result {
            background: url('assets/npcalea.jpg') no-repeat center; /* Opcional */
            background-size: cover;
            background-color: #eaddcf; /* Cor de papel */
            color: #3e2723; /* Texto escuro */
            padding: 10px;
            border-radius: 2px;
            min-height: 90px;
            font-size: 0.95rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            transform: rotate(-1deg);
        }

        /* LOG */
        .log-box {
            background: #000;
            color: #4caf50; /* Verde terminal retro */
            font-family: 'Courier Prime', monospace;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            border: 2px solid #333;
            border-radius: 4px;
            font-size: 0.85rem;
            text-align: left;
            margin-top: auto;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        .log-entry { margin-bottom: 6px; border-bottom: 1px dashed #222; padding-bottom: 4px; }
        .log-time { color: #666; margin-right: 8px; font-size: 0.75rem; }

        /* MODAIS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(2px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-xp {
            background: url('assets/paper-bg.jpg') center/cover;
            background-color: #eaddcf;
            padding: 30px;
            border: 8px solid #2b1b12;
            width: 95%; max-width: 500px;
            text-align: left; color: #2b1b12;
            box-shadow: 0 0 60px rgba(0,0,0,1);
            border-radius: 2px;
        }
        .modal-xp h2 {
            font-family: 'Rye'; margin: 0 0 20px 0;
            border-bottom: 2px solid #2b1b12;
            padding-bottom: 10px; text-align: center; color: #2b1b12;
        }
        
        .xp-question {
            display: flex; align-items: flex-start; gap: 10px;
            margin-bottom: 10px; padding: 12px;
            background: rgba(255,255,255,0.4);
            border: 1px solid rgba(43, 27, 18, 0.2);
            border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .xp-question:hover { background: rgba(255,255,255,0.8); border-color: #2b1b12; }
        .xp-question input { margin-top: 4px; accent-color: #2b1b12; width: 18px; height: 18px; }
        .xp-question label { font-family: 'Courier Prime'; font-size: 1rem; cursor: pointer; line-height: 1.3; flex: 1; font-weight: bold; }
        
        .xp-actions { display: flex; gap: 15px; margin-top: 25px; }
        .btn-confirm-xp { flex: 2; background: #2e7d32; color: #fff; padding: 15px; font-family: 'Rye'; border: 2px solid #1b5e20; cursor: pointer; font-size: 1.1rem; }
        .btn-cancel-xp { flex: 1; background: #5d4037; color: #fff; padding: 15px; font-family: 'Rye'; border: 2px solid #3e2723; cursor: pointer; font-size: 1.1rem; }
        
        .btn-lvl-set {
            flex: 1; background: #3e2723; color: #ffcc80; border: 1px solid #5d4037;
            cursor: pointer; padding: 8px 0; font-family: 'Rye'; font-size: 0.9rem;
        }
        .btn-lvl-set:hover { background: #5d4037; color: #fff; }

        /* === PAINEL DO BANDO === */
        .bando-panel { margin-top: 25px; }
        .bando-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .bando-tab {
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #5d4037;
            color: #aaa;
            font-family: 'Rye';
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px 4px 0 0;
        }
        .bando-tab:hover { color: var(--gold); }
        .bando-tab.active {
            background: var(--panel-bg);
            color: var(--gold);
            border-color: var(--gold);
            border-bottom-color: transparent;
        }
        .bando-content {
            display: none;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border: 1px solid #5d4037;
            border-radius: 0 4px 4px 4px;
        }
        .bando-content.active { display: block; }
        
        .bando-input {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #5d4037;
            color: var(--text-main);
            font-family: 'Courier Prime';
            border-radius: 4px;
            box-sizing: border-box;
        }
        .bando-input:focus { outline: none; border-color: var(--gold); }
        .bando-input-small { width: 120px; text-align: center; }
        
        .bando-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        .bando-label {
            font-family: 'Rye';
            color: var(--gold);
            min-width: 100px;
        }
        
        .bando-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .bando-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border: 1px solid #5d4037;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .bando-item:hover { border-color: var(--gold); }
        .bando-item-info { flex: 1; }
        .bando-item-name { color: var(--gold); font-weight: bold; }
        .bando-item-sub { color: #888; font-size: 0.85rem; }
        .bando-item-actions { display: flex; gap: 5px; }
        
        .btn-bando {
            padding: 8px 15px;
            font-family: 'Rye';
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .btn-bando-add { background: #2e7d32; color: #fff; border-color: #1b5e20; }
        .btn-bando-add:hover { background: #388e3c; }
        .btn-bando-save { background: #1565c0; color: #fff; border-color: #0d47a1; }
        .btn-bando-save:hover { background: #1976d2; }
        .btn-bando-del { background: #c62828; color: #fff; border-color: #b71c1c; padding: 5px 10px; }
        .btn-bando-del:hover { background: #d32f2f; }
        .btn-bando-edit { background: #5d4037; color: #ffcc80; border-color: #3e2723; padding: 5px 10px; }
        .btn-bando-edit:hover { background: #6d4c41; }

        .status-select {
            padding: 5px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #5d4037;
            color: var(--text-main);
            font-family: 'Courier Prime';
            border-radius: 4px;
        }

        /* RESPONSIVIDADE */
        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .split-row { flex-direction: row; } 
        }
        @media (max-width: 600px) {
            .split-row { flex-direction: column; }
            td { display: block; text-align: right; border-left: none !important; border-right: none !important; border-bottom: 1px dashed #444; }
            td::before { content: attr(data-label); float: left; font-weight: bold; color: #aaa; font-family: 'Rye'; }
            td:first-child { text-align: center; border-bottom: 2px solid var(--gold); }
            td:first-child::before { display: none; }
            .bando-tabs { flex-wrap: wrap; }
            .bando-tab { font-size: 0.75rem; padding: 8px 12px; }
        }
    </style>
</head>
<body>

    <h1>‚ú¶ DASHBOARD DO MESTRE ‚ú¶</h1>

    <div class="dashboard-grid">
        
        <div class="panel-container">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #555; padding-bottom:10px; margin-bottom:20px;">
                <h3 style="margin:0; border:none; padding:0;">Bando Reunido</h3>
                <span style="font-size:0.8rem; color:#666;">Status em Tempo Real</span>
            </div>
            
            <table id="players-table">
                <thead>
                    <tr>
                        <th style="width:30%">Nome</th>
                        <th>N√≠vel (XP)</th>
                        <th>Vitas</th>
                        <th>Condi√ß√£o</th>
                        <th style="width:100px">A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="players-body">
                    <tr><td colspan="5" style="text-align:center; padding:30px;">Procurando fugitivos na rede...</td></tr>
                </tbody>
            </table>

            <!-- PAINEL DE GERENCIAMENTO DO BANDO -->
            <div class="bando-panel">
                <h3>üè¥ Gerenciar Bando</h3>
                
                <div class="bando-tabs">
                    <button class="bando-tab active" onclick="showBandoTab('geral')">Geral</button>
                    <button class="bando-tab" onclick="showBandoTab('membros')">Membros</button>
                    <button class="bando-tab" onclick="showBandoTab('noticias')">Not√≠cias</button>
                    <button class="bando-tab" onclick="showBandoTab('melhorias')">Melhorias</button>
                </div>

                <!-- ABA: GERAL (Honra e Caixa) -->
                <div class="bando-content active" id="tab-geral">
                    <div class="bando-row">
                        <span class="bando-label">‚öñÔ∏è Honra:</span>
                        <input type="range" id="bando-honra" min="-100" max="100" value="0" 
                               style="flex:1;" oninput="document.getElementById('honra-valor').textContent = this.value">
                        <span id="honra-valor" style="min-width:40px; text-align:center; font-weight:bold;">0</span>
                    </div>
                    <div class="bando-row">
                        <span class="bando-label">üí∞ Caixa:</span>
                        <input type="number" id="bando-caixa" class="bando-input bando-input-small" value="0" step="0.01">
                    </div>
                    <button class="btn-bando btn-bando-save" onclick="salvarDadosBando()" style="width:100%; margin-top:10px;">
                        üíæ Salvar Altera√ß√µes
                    </button>
                </div>

                <!-- ABA: MEMBROS DO BANDO -->
                <div class="bando-content" id="tab-membros">
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="novo-membro-nome" class="bando-input" placeholder="Nome do NPC" style="flex:2;">
                        <input type="text" id="novo-membro-funcao" class="bando-input" placeholder="Fun√ß√£o" style="flex:1;">
                        <button class="btn-bando btn-bando-add" onclick="adicionarMembro()">+ Add</button>
                    </div>
                    <div class="bando-list" id="lista-membros">
                        <p style="text-align:center; color:#666;">Carregando...</p>
                    </div>
                </div>

                <!-- ABA: NOT√çCIAS -->
                <div class="bando-content" id="tab-noticias">
                    <div style="margin-bottom:15px;">
                        <input type="text" id="nova-noticia-titulo" class="bando-input" placeholder="T√≠tulo da manchete" style="margin-bottom:10px;">
                        <textarea id="nova-noticia-conteudo" class="bando-input" placeholder="Conte√∫do da not√≠cia..." rows="3"></textarea>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input type="text" id="nova-noticia-data" class="bando-input" placeholder="Data (ex: 12 de Mar√ßo, 1899)" style="flex:1;">
                            <button class="btn-bando btn-bando-add" onclick="adicionarNoticia()">+ Publicar</button>
                        </div>
                    </div>
                    <div class="bando-list" id="lista-noticias">
                        <p style="text-align:center; color:#666;">Carregando...</p>
                    </div>
                </div>

                <!-- ABA: MELHORIAS -->
                <div class="bando-content" id="tab-melhorias">
                    <div class="bando-list" id="lista-melhorias">
                        <p style="text-align:center; color:#666;">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel-container controls-panel" style="display:flex; flex-direction:column; gap:15px;">
            
            <div>
                <h3>Ciclo & Sobreviv√™ncia</h3>
                <p style="font-size: 0.8rem; color: #888; margin-top:-10px; margin-bottom:10px;">
                    Consome recursos e aplica dano de Fome.
                </p>
                <button class="gm-btn btn-day" onclick="virarODia()">üåô Encerrar o Dia</button>
            </div>

            <div class="split-row">
                
                <div class="split-item widget-box">
                    <span style="font-family:'Rye'; color:var(--gold); font-size:0.9rem;">TENS√ÉO</span>
                    
                    <input type="text" id="clock-title" placeholder="Amea√ßa..." 
                           style="width:100%; background:transparent; border:none; border-bottom:1px solid #555; font-family:'Courier Prime'; text-align:center; color:#fff; font-size:0.9rem; margin-top:5px;">
                    
                    <div class="clock-visual" id="clock-visual" style="background:conic-gradient(#8b0000 0% 0%, transparent 0% 100%);"></div>
                    
                    <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                        <button class="gm-btn" style="padding:2px 10px; margin:0; width:auto; font-size:1.2rem; background:#333;" onclick="resetClock()">‚Ü∫</button>
                        <span id="clock-status" style="font-family:'Rye'; font-size:1.2rem; color:#fff;">0/6</span>
                        <button class="gm-btn" style="padding:2px 10px; margin:0; width:auto; font-size:1.2rem; background:#d32f2f;" onclick="updateClock(1)">+</button>
                    </div>
                </div>

                <div class="split-item widget-box">
                    <span style="font-family:'Rye'; color:var(--gold); font-size:0.9rem;">VIVENTE</span>
                    <div id="npc-result">
                        <span style="opacity:0.6;">Gerar NPC...</span>
                    </div>
                    <button class="gm-btn btn-roll" style="margin:0; padding:8px;" onclick="gerarNPC()">üë§ Novo</button>
                </div>

            </div>

            <div>
                <h3>Caos & Destrui√ß√£o</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="alvo-avaria" class="gm-select" style="margin:0; width: auto; flex: 2;">
                        <option value="random">üé≤ Aleat√≥rio</option>
                    </select>
                    <button class="gm-btn btn-damage" style="margin:0; flex:1;" onclick="causarAvaria()">üß• Avaria</button>
                </div>
                <button class="gm-btn btn-roll" onclick="rolarEncontro()">üé≤ Rolar Encontro (d6)</button>
            </div>

            <div class="log-box" id="gm-log">
                <div class="log-entry">> Sistema iniciado.</div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="modal-edit-xp">
        <div class="modal-xp" style="border-color: #3e2723; background-color: #1a1411; color: #e6dccf;">
            <h2 style="color:#ffcc80; border-color:#5d4037;">üõ†Ô∏è Ajuste Manual</h2>
            <p style="text-align:center;">Editando: <b id="edit-target-name" style="color:#ffcc80;">...</b></p>
            
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:5px; margin-bottom:15px; text-align:center;">
                <label style="display:block; color:#aaa; font-size:0.8rem; margin-bottom:5px;">XP ATUAL</label>
                <input type="number" id="input-manual-xp" style="width:100px; padding:10px; font-family:'Rye'; font-size:2rem; text-align:center; background:transparent; color:#ffcc80; border:none; border-bottom:2px solid #5d4037;">
            </div>

            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px; margin-bottom:20px;">
                <button onclick="setNivelManual(1)" class="btn-lvl-set">Lv.1</button>
                <button onclick="setNivelManual(2)" class="btn-lvl-set">Lv.2</button>
                <button onclick="setNivelManual(3)" class="btn-lvl-set">Lv.3</button>
                <button onclick="setNivelManual(4)" class="btn-lvl-set">Lv.4</button>
                <button onclick="setNivelManual(5)" class="btn-lvl-set">Lv.5</button>
                <button onclick="setNivelManual(6)" class="btn-lvl-set">Lv.6</button>
            </div>

            <div class="xp-actions">
                <button class="btn-cancel-xp" onclick="document.getElementById('modal-edit-xp').style.display='none'">Cancelar</button>
                <button class="btn-confirm-xp" onclick="salvarManualXP()">Salvar Altera√ß√£o</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-xp">
        <div class="modal-xp">
            <h2>Sess√£o Encerrada</h2>
            <p style="text-align:center; margin-bottom:20px; font-family:'Courier Prime'; font-size:1.1rem;">
                Avaliando o desempenho de: <br><b id="xp-target-name" style="font-size:1.4rem; color:#8b0000;">...</b>
            </p>
            
            <div class="xp-question" onclick="toggleCheck('xp1')">
                <input type="checkbox" id="xp1">
                <label for="xp1">1. Terminou a sess√£o vivo?</label>
            </div>
            <div class="xp-question" onclick="toggleCheck('xp2')">
                <input type="checkbox" id="xp2">
                <label for="xp2">2. Terminou com mais dinheiro?</label>
            </div>
            <div class="xp-question" onclick="toggleCheck('xp3')">
                <input type="checkbox" id="xp3">
                <label for="xp3">3. Ajudou o bando de alguma forma?</label>
            </div>
            <div class="xp-question" onclick="toggleCheck('xp4')">
                <input type="checkbox" id="xp4">
                <label for="xp4">4. Resolveu o problema de algu√©m?</label>
            </div>
            <div class="xp-question" onclick="toggleCheck('xp5')">
                <input type="checkbox" id="xp5">
                <label for="xp5">5. Terminou com alguma Carta de Sina?</label>
            </div>

            <div class="xp-actions">
                <button class="btn-cancel-xp" onclick="fecharModalXP()">Cancelar</button>
                <button class="btn-confirm-xp" onclick="confirmarXP()">Confirmar Pontos</button>
            </div>
        </div>
    </div>

    <script>
        let allPlayers = [];
        let xpSession = { targetId: null, targetName: null };

        // 1. CARREGAR DADOS
        async function fetchPlayers() {
            const { data, error } = await client.from('Fichas').select('*').order('nome_personagem');
            if (error) { log(`Erro: ${error.message}`); return; }
            allPlayers = data;
            renderTable();
            atualizarSelectAlvos();
        }

        // 2. RENDERIZAR TABELA (ATUALIZADO COM VISUAL NOVO)
        function renderTable() {
            const tbody = document.getElementById('players-body');
            tbody.innerHTML = '';

            allPlayers.forEach(player => {
                const attr = player.atributos || {};
                const rec = attr.recursos || { racoes: 0, alimentadoHoje: false, faminto: false };
                const vest = attr.vestimentas || [];
                const avarias = vest.filter(v => v.estado && v.estado !== 'bom').length;
                
                // N√≠vel e XP
                const xpAtual = attr.xp || 0;
                let nivel = 1;
                if(xpAtual >= 10) nivel = 2;
                if(xpAtual >= 20) nivel = 3;
                if(xpAtual >= 30) nivel = 4;
                if(xpAtual >= 45) nivel = 5;
                if(xpAtual >= 65) nivel = 6;

                // Status Visual
                let statusHtml = "";
                
                if (rec.alimentadoHoje) {
                    statusHtml += '<span class="status-badge status-ok">Cheio</span>';
                } else {
                    statusHtml += '<span class="status-badge status-neutral">Vazio</span>';
                }

                if (rec.faminto) {
                    statusHtml += ' <span class="status-badge status-bad" title="Limite de Dor reduzido para 3">‚ö†Ô∏è FR√ÅGIL</span>';
                }

                if(avarias > 0) statusHtml += ` <span style="font-size:0.8rem; color:#aaa; margin-left:5px;">üß• -${avarias}</span>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Nome" class="char-name">${player.nome_personagem}</td>
                    <td data-label="N√≠vel">
                        <span style="color:#fff; font-weight:bold;">Lv.${nivel}</span> 
                        <span style="color:#666; font-size:0.8rem;">(${xpAtual} XP)</span>
                        <button class="btn-edit-mini" onclick="abrirEditManual('${player.id}', '${player.nome_personagem}', ${xpAtual})">‚úèÔ∏è</button>
                    </td>
                    <td data-label="Vitas">
                        <span style="color:#d32f2f;">üíÄ ${attr.vida || 0}</span> 
                        <span style="color:#666;">|</span> 
                        <span style="color:#ffcc80;">ü©∏ ${attr.dor || 0}</span>
                    </td>
                    <td data-label="Status">${statusHtml}</td>
                    <td data-label="A√ß√£o">
                        <button class="btn-mini-xp" onclick="abrirModalXP('${player.id}', '${player.nome_personagem}')">‚òÖ DAR XP</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- L√ìGICA DO REL√ìGIO DE TENS√ÉO ---
        let clockValue = 0;
        const clockMax = 6; 

        function updateClock(amount) {
            clockValue += amount;
            if(clockValue < 0) clockValue = 0;
            if(clockValue > clockMax) clockValue = clockMax;

            document.getElementById('clock-status').innerText = `${clockValue}/${clockMax}`;
            
            const percentage = (clockValue / clockMax) * 100;
            const color = clockValue >= clockMax ? '#d32f2f' : '#8b0000';
            
            document.getElementById('clock-visual').style.background = 
                `conic-gradient(${color} 0% ${percentage}%, transparent ${percentage}% 100%)`;

            if(clockValue === clockMax) {
                log(`‚ö†Ô∏è TENS√ÉO M√ÅXIMA! O rel√≥gio encheu.`);
            }
        }

        function resetClock() {
            clockValue = 0;
            updateClock(0);
            document.getElementById('clock-title').value = '';
        }

        // --- GERADOR DE NPC (VERS√ÉO BRASIL PROFUNDO) ---
        const nomesH = [
            "Ti√£o", "Z√©", "Severino", "Jesu√≠no", "Tonho", "Jurandir", "Chico", "Raimundo", "Basti√£o", "Lau", 
            "Inoc√™ncio", "Aderbal", "Gumercindo", "Juvenal", "Tib√∫rcio", "Ezequiel", "Isa√≠as", "Jeremias",
            "Euclides", "Herm√≥genes", "Valdomiro", "Oleg√°rio", "Firmino", "Justino", "C√≠cero", "Expedito",
            "Dami√£o", "Cosme", "Ven√¢ncio", "Gaud√™ncio", "Epaminondas", "Floriano", "Belchior", "Virgulino",
            "Salustiano", "Agostinho", "Bento", "Vicente", "Otac√≠lio", "Deocleciano", "Le√¥ncio", "Ambr√≥sio",
            "Hon√≥rio", "Janu√°rio", "Virg√≠lio", "Manoel", "Joaquim", "Ant√¥nio", "Pedro", "L√°zaro", "Dimas"
        ];

        const nomesM = [
            "Maria", "Das Dores", "Socorro", "C√≠cera", "Luzia", "Dona Benta", "Rosinha", "Filinha", "Quit√©ria", 
            "Toinha", "Concei√ß√£o", "Aparecida", "F√°tima", "Lourdes", "Gra√ßa", "Merc√™s", "Amparo", "Piedade",
            "Generosa", "Blandina", "Filomena", "Carmelita", "Zulmira", "Etelvina", "Belarmina", "Santina",
            "Jovelina", "Ernestina", "Jandira", "Iracema", "Moema", "Francisca", "Chica", "Benedita",
            "Ant√¥nia", "Raimunda", "Josefa", "Severina", "Tereza", "Eul√°lia", "Hort√™ncia", "Margarida",
            "Violante", "Dad√°", "Sinh√°", "Mo√ßa", "Zefa", "Bi√°", "Donana", "Zez√©"
        ];
        
        const apelidos = [
            "da Peixeira", "do Fac√£o", "Valente", "Corta-Vento", "Treme-Terra", "Boca-de-Fogo", "Gatilho",
            "Chumbo-Grosso", "Sangue-Bom", "M√£o-de-On√ßa", "Quebra-Osso", "Fura-Bucho", "Sete-Vidas",
            "Beira-Rio", "da Venda", "P√©-de-Serra", "do Brejo", "da Caatinga", "do Crato", "do Norte",
            "da Mata", "da Encruzilhada", "do Po√ßo", "da Serra", "das Almas",
            "Gavi√£o", "Cobra-Verde", "Tatu", "Bode", "On√ßa", "Asa-Branca", "Sabi√°", "Corisco", "Ventania",
            "Trov√£o", "Jararaca", "Cascavel", "Lobo", "Raposo", "Pre√°", "Calango",
            "Caolho", "Manco", "Gigante", "Pequeno", "Seco", "Ruivo", "Galego", "Preto", "Caboclo",
            "Zarolho", "Mudo", "Surdo", "Cego", "Aleijadinho", "Dedo-Mole", "P√©-Leve",
            "dos Anjos", "do Santo", "da Cruz", "Rezadore", "Milagreiro", "do Ter√ßo", "Padreco", "Beato",
            "do Diabo", "Tinhoso", "Alma-Penada", "Corpo-Fechado",
            "Ferreira", "Batista", "Alves", "Silva", "Santos", "Oliveira", "Souza", "Lima",
            "Ferreiro", "Vaqueiro", "Tropeiro", "Cigano", "Doutor", "Capit√£o", "Sargento"
        ];
            
        const tracos = [
            "Masca fumo de corda o tempo todo.", "Limpa as unhas com a ponta da peixeira.", "Usa um chap√©u de couro com furo de bala.",
            "Tem um dente de ouro na frente.", "Carrega um ter√ßo enrolado no punho.", "Tem uma cicatriz feia que repuxa a boca.",
            "Usa √≥culos com uma lente trincada.", "Tem as m√£os calejadas e sujas de terra.", "Veste um gib√£o de couro surrado.",
            "Tem marcas de var√≠ola no rosto.", "Falta um peda√ßo da orelha esquerda.", "Tem o rosto queimado de sol.",
            "Anda descal√ßo, mas carrega botas no ombro.", "Usa um len√ßo vermelho encardido no pesco√ßo.", "Tem tatuagem de santa desbotada no bra√ßo.",
            "Carrega um bornal cheio de ervas.", "Tem o olho esquerdo branco (cego).", "Usa an√©is roubados em v√°rios dedos.",
            "Cheira forte a cacha√ßa e fumo.", "Tem a pele coberta de poeira da estrada.", "Reza baixinho sem parar.",
            "Tosse seca e feia (t√≠sica).", "Cospe no ch√£o a cada frase.", "N√£o para de olhar para os lados.",
            "Fala sussurrando, como se tivesse medo.", "Tem um tique nervoso no olho.", "Ri alto e fora de hora.",
            "Fala arrastado, com muita calma.", "Gagueja quando fica nervoso.", "Brinca com uma moeda de prata entre os dedos.",
            "Est√° sempre afiando uma faca.", "Fala olhando para o horizonte, nunca nos olhos.", "Faz o sinal da cruz toda vez que ouve um barulho.",
            "As m√£os tremem sem parar.", "Cantarola uma moda de viola triste.", "Tem um cachorro magro que n√£o sai de perto.",
            "Fala em enigmas e ditados populares.", "Parece estar sempre com sono.", "Tem pavio curto e se irrita f√°cil.",
            "Chama todo mundo de 'doutor' ou 'patr√£o'."
        ];
        
        const segredos = [
            "Fugindo de um Coronel vingativo.", "Matou o pr√≥prio irm√£o por causa de terra.", "√â um desertor da vol√¢ncia (pol√≠cia).",
            "Roubou as esmolas da igreja local.", "√â informante de um bando de cangaceiros.", "Ajudou a queimar uma fazenda vizinha.",
            "Tem uma recompensa pela cabe√ßa no estado vizinho.", "Matou um homem por engano em uma briga.", "Foi o √∫nico sobrevivente de um massacre.",
            "Esconde um passado como jagun√ßo famoso.", "Sabe onde o bando enterrou o butim.", "Carrega pepitas de ouro costuradas na bainha da cal√ßa.",
            "Tem o mapa de um veio d'√°gua secreto.", "Guarda a escritura roubada de uma fazenda.", "Achou uma arma muito valiosa e escondeu.",
            "Sabe a senha para entrar no esconderijo dos bandidos.", "Deve uma fortuna para o agiota da cidade.", "Est√° guardando dinheiro para fugir para a capital.",
            "Viu uma assombra√ß√£o na estrada ontem √† noite.", "Fez um pacto na encruzilhada e se arrependeu.", "Acredita que est√° amaldi√ßoado a nunca dormir.",
            "Est√° infectado com uma doen√ßa contagiosa.", "Est√° esperando um milagre para curar um filho.", "Diz que ouve a voz do Diabo no vento.",
            "Carrega um amuleto feito de osso humano.", "Sabe quem envenenou o gado da regi√£o.", "√â filho bastardo do homem mais rico da cidade.",
            "Est√° apaixonado(a) pela pessoa errada.", "Finge ser cego ou mudo para ouvir conversas.", "Sabe que o padre n√£o √© quem diz ser.",
            "Tem vis√µes do futuro quando bebe.", "Acredita ser a reencarna√ß√£o de um santo."
        ];

        // --- L√ìGICA DE ALEATORIEDADE AVAN√áADA (BARALHO) ---
        const sacolas = {};

        function pegarItemUnico(listaOriginal, nomeCategoria) {
            if (!sacolas[nomeCategoria] || sacolas[nomeCategoria].length === 0) {
                sacolas[nomeCategoria] = [...listaOriginal];
                for (let i = sacolas[nomeCategoria].length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [sacolas[nomeCategoria][i], sacolas[nomeCategoria][j]] = [sacolas[nomeCategoria][j], sacolas[nomeCategoria][i]];
                }
            }
            return sacolas[nomeCategoria].pop();
        }

        function gerarNPC() {
            const isHomem = Math.random() > 0.5;
            const listaNomes = isHomem ? nomesH : nomesM;
            const chaveGenero = isHomem ? 'nomesH' : 'nomesM';
            
            const nome = pegarItemUnico(listaNomes, chaveGenero);
            const sobrenome = pegarItemUnico(apelidos, 'apelidos');
            const traco = pegarItemUnico(tracos, 'tracos');
            const segredo = pegarItemUnico(segredos, 'segredos');

            const html = `
                <div style="text-align:center;">
                    <b style="color:#3e2723; font-size:1.1rem; font-family:'Rye'; text-transform:uppercase; display:block; margin-bottom:5px;">${nome} ${sobrenome}</b>
                    <div style="font-size:0.85rem; color:#333; margin-bottom:5px; line-height:1.2;">üëÅÔ∏è ${traco}</div>
                    <div style="font-size:0.8rem; color:#d32f2f; font-weight:bold; font-style:italic;">ü§´ ${segredo}</div>
                </div>
            `;
            
            document.getElementById('npc-result').innerHTML = html;
            log(`üë§ NPC: ${nome} ${sobrenome} gerado.`);
        }

        // --- L√ìGICA DO MESTRE PARA VIRAR O DIA (FRAGILIDADE) ---
        async function virarODia() {
            if(!confirm("Encerrar o dia?\n\n- Quem comeu: Remove Fragilidade e zera Dor.\n- Quem N√ÉO comeu: Fica FR√ÅGIL (Max Dor 3) e ganha +1 Dor.")) return;
            
            log("--- A NOITE CAIU ---");
            
            for (let player of allPlayers) {
                let attr = player.atributos;
                if (!attr.recursos) attr.recursos = { racoes: 0, alimentadoHoje: false, faminto: false };
                
                let msg = "";
                
                if (attr.recursos.alimentadoHoje) {
                    attr.recursos.alimentadoHoje = false;
                    attr.recursos.faminto = false;
                    attr.dor = 0; 
                    msg = `‚úÖ ${player.nome_personagem}: Descansado e Forte (Max Dor 6).`;
                } else {
                    attr.recursos.faminto = true; 
                    attr.dor = (attr.dor || 0) + 1;
                    
                    if (attr.dor >= 3) {
                        attr.dor = 0;
                        if (attr.vida > 0) {
                            attr.vida = attr.vida - 1;
                            msg = `ü©∏ ${player.nome_personagem}: Fome bateu 3 de Dor -> DANO (-1 Vida)`;
                        } else {
                            msg = `üíÄ ${player.nome_personagem}: COLAPSO DE FOME.`;
                        }
                    } else {
                        msg = `‚ö†Ô∏è ${player.nome_personagem}: Com Fome e Fr√°gil (+1 Dor).`;
                    }
                }
                
                log(msg);
                await client.from('Fichas').update({ atributos: attr }).eq('id', player.id);
            }
            log("--- NOVO DIA INICIADO ---");
        }

        // TABELA DE XP
        const XP_POR_NIVEL = { 1: 0, 2: 10, 3: 20, 4: 30, 5: 45, 6: 65 };
        let editSession = { id: null };

        function abrirEditManual(id, nome, xpAtual) {
            editSession.id = id;
            document.getElementById('edit-target-name').innerText = nome;
            document.getElementById('input-manual-xp').value = xpAtual;
            document.getElementById('modal-edit-xp').style.display = 'flex';
        }

        function setNivelManual(nivel) {
            document.getElementById('input-manual-xp').value = XP_POR_NIVEL[nivel];
        }

        async function salvarManualXP() {
            const novoXP = parseInt(document.getElementById('input-manual-xp').value) || 0;
            const player = allPlayers.find(p => p.id == editSession.id);
            if(player) {
                const attr = player.atributos;
                attr.xp = novoXP;
                await client.from('Fichas').update({ atributos: attr }).eq('id', player.id);
                log(`üõ†Ô∏è AJUSTE: ${player.nome_personagem} definido para ${novoXP} XP.`);
                document.getElementById('modal-edit-xp').style.display = 'none';
            }
        }

        function abrirModalXP(id, nome) {
            xpSession.targetId = id;
            xpSession.targetName = nome;
            document.getElementById('xp-target-name').innerText = nome;
            for(let i=1; i<=5; i++) document.getElementById(`xp${i}`).checked = false;
            document.getElementById('modal-xp').style.display = 'flex';
        }

        function fecharModalXP() { document.getElementById('modal-xp').style.display = 'none'; }
        function toggleCheck(id) {} // Opcional se for clicar no label

        async function confirmarXP() {
            let totalXP = 0;
            for(let i=1; i<=5; i++) if(document.getElementById(`xp${i}`).checked) totalXP++;
            if(totalXP === 0 && !confirm("Confirmar 0 XP?")) return;
            const player = allPlayers.find(p => p.id == xpSession.targetId);
            if(player) {
                const attr = player.atributos;
                attr.xp = (attr.xp || 0) + totalXP;
                await client.from('Fichas').update({ atributos: attr }).eq('id', player.id);
                log(`üåü XP: ${player.nome_personagem} ganhou +${totalXP} XP.`);
                fecharModalXP();
            }
        }

        function atualizarSelectAlvos() {
            const select = document.getElementById('alvo-avaria');
            const valorAtual = select.value;
            select.innerHTML = '<option value="random">üé≤ Aleat√≥rio (Sorte)</option>';
            allPlayers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id; opt.innerText = p.nome_personagem;
                select.appendChild(opt);
            });
            if (valorAtual && valorAtual !== 'random') select.value = valorAtual;
        }

        async function causarAvaria() {
            if (allPlayers.length === 0) return;
            const targetId = document.getElementById('alvo-avaria').value;
            let targetPlayer = (targetId === 'random') ? allPlayers[Math.floor(Math.random() * allPlayers.length)] : allPlayers.find(p => p.id == targetId);
            if (!targetPlayer) return;
            const attr = targetPlayer.atributos;
            if (!attr.vestimentas) return log("Sem roupas.");
            const valid = attr.vestimentas.map((v, i) => ({ ...v, i })).filter(v => v.nome && v.estado !== 'destruido');
            if (valid.length === 0) return log("Tudo destru√≠do!");
            const chosen = valid[Math.floor(Math.random() * valid.length)];
            const estados = ['bom', 'usado', 'rasgado', 'destruido'];
            const nextState = estados[estados.indexOf(chosen.estado || 'bom') + 1] || 'destruido';
            attr.vestimentas[chosen.i].estado = nextState;
            log(`üí• ${targetPlayer.nome_personagem}: ${chosen.nome} -> ${nextState.toUpperCase()}`);
            await client.from('Fichas').update({ atributos: attr }).eq('id', targetPlayer.id);
        }

        function rolarEncontro() {
            const tab = ["Sil√™ncio...", "Rastros de animal.", "Mudan√ßa no Clima.", "Viajante perdido.", "Ru√≠nas antigas.", "‚ö†Ô∏è EMBOSCADA!"];
            log(`üé≤ (d6): ${tab[Math.floor(Math.random() * 6)]}`);
        }

        function log(msg) {
            const box = document.getElementById('gm-log');
            box.innerHTML = `<div class="log-entry"><span class="log-time">[${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}]</span> ${msg}</div>` + box.innerHTML;
        }

        // =====================================================
        // FUN√á√ïES DE GERENCIAMENTO DO BANDO
        // =====================================================

        // Alternar abas
        function showBandoTab(tabName) {
            document.querySelectorAll('.bando-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.bando-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="showBandoTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Carregar dados gerais do bando
        async function carregarDadosBando() {
            try {
                const { data, error } = await client.from('bando').select('*').single();
                if (error) throw error;
                if (data) {
                    document.getElementById('bando-honra').value = data.honra || 0;
                    document.getElementById('honra-valor').textContent = data.honra || 0;
                    document.getElementById('bando-caixa').value = data.caixa || 0;
                }
            } catch (err) {
                log('‚ö†Ô∏è Tabela "bando" n√£o encontrada');
            }
        }

        // Salvar dados gerais
        async function salvarDadosBando() {
            const honra = parseInt(document.getElementById('bando-honra').value);
            const caixa = parseFloat(document.getElementById('bando-caixa').value);
            
            try {
                // Tenta atualizar, se n√£o existir, insere
                const { data: existing } = await client.from('bando').select('id').single();
                
                if (existing) {
                    await client.from('bando').update({ honra, caixa }).eq('id', existing.id);
                } else {
                    await client.from('bando').insert({ honra, caixa });
                }
                log(`‚úÖ Bando atualizado: Honra ${honra}, Caixa $${caixa.toFixed(2)}`);
            } catch (err) {
                log(`‚ùå Erro ao salvar: ${err.message}`);
            }
        }

        // Carregar membros do bando
        async function carregarMembros() {
            try {
                const { data, error } = await client.from('membros_bando').select('*').order('nome');
                if (error) throw error;
                
                const lista = document.getElementById('lista-membros');
                if (!data || data.length === 0) {
                    lista.innerHTML = '<p style="text-align:center; color:#666;">Nenhum membro cadastrado</p>';
                    return;
                }
                
                lista.innerHTML = data.map(m => `
                    <div class="bando-item">
                        <div class="bando-item-info">
                            <div class="bando-item-name">${m.nome}</div>
                            <div class="bando-item-sub">${m.funcao || 'Sem fun√ß√£o'} | ${m.descricao || 'Sem descri√ß√£o'}</div>
                        </div>
                        <select class="status-select" onchange="atualizarStatusMembro(${m.id}, this.value)">
                            <option value="vivo" ${m.status === 'vivo' ? 'selected' : ''}>Saud√°vel</option>
                            <option value="ferido" ${m.status === 'ferido' ? 'selected' : ''}>Ferido</option>
                            <option value="procurado" ${m.status === 'procurado' ? 'selected' : ''}>Procurado</option>
                        </select>
                        <div class="bando-item-actions">
                            <button class="btn-bando btn-bando-edit" onclick="editarMembro(${m.id})">‚úèÔ∏è</button>
                            <button class="btn-bando btn-bando-del" onclick="removerMembro(${m.id}, '${m.nome}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('lista-membros').innerHTML = '<p style="color:#d32f2f;">Erro ao carregar membros</p>';
            }
        }

        async function adicionarMembro() {
            const nome = document.getElementById('novo-membro-nome').value.trim();
            const funcao = document.getElementById('novo-membro-funcao').value.trim();
            
            if (!nome) return alert('Digite o nome do membro');
            
            try {
                await client.from('membros_bando').insert({ nome, funcao, status: 'vivo', ativo: true });
                document.getElementById('novo-membro-nome').value = '';
                document.getElementById('novo-membro-funcao').value = '';
                carregarMembros();
                log(`‚úÖ Membro adicionado: ${nome}`);
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`);
            }
        }

        async function atualizarStatusMembro(id, status) {
            await client.from('membros_bando').update({ status }).eq('id', id);
            log(`üìù Status atualizado`);
        }

        async function removerMembro(id, nome) {
            if (!confirm(`Remover "${nome}" do bando?`)) return;
            await client.from('membros_bando').delete().eq('id', id);
            carregarMembros();
            log(`üóëÔ∏è ${nome} removido do bando`);
        }

        function editarMembro(id) {
            const descricao = prompt('Digite a descri√ß√£o do membro:');
            if (descricao !== null) {
                client.from('membros_bando').update({ descricao }).eq('id', id).then(() => {
                    carregarMembros();
                    log('‚úÖ Descri√ß√£o atualizada');
                });
            }
        }

        // Carregar not√≠cias
        async function carregarNoticias() {
            try {
                const { data, error } = await client.from('noticias').select('*').order('criado_em', { ascending: false });
                if (error) throw error;
                
                const lista = document.getElementById('lista-noticias');
                if (!data || data.length === 0) {
                    lista.innerHTML = '<p style="text-align:center; color:#666;">Nenhuma not√≠cia publicada</p>';
                    return;
                }
                
                lista.innerHTML = data.map(n => `
                    <div class="bando-item">
                        <div class="bando-item-info">
                            <div class="bando-item-name">üì∞ ${n.titulo}</div>
                            <div class="bando-item-sub">${n.data_jornal || 'Sem data'}</div>
                        </div>
                        <div class="bando-item-actions">
                            <button class="btn-bando btn-bando-del" onclick="removerNoticia(${n.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('lista-noticias').innerHTML = '<p style="color:#d32f2f;">Erro ao carregar not√≠cias</p>';
            }
        }

        async function adicionarNoticia() {
            const titulo = document.getElementById('nova-noticia-titulo').value.trim();
            const conteudo = document.getElementById('nova-noticia-conteudo').value.trim();
            const data_jornal = document.getElementById('nova-noticia-data').value.trim();
            
            if (!titulo || !conteudo) return alert('Preencha t√≠tulo e conte√∫do');
            
            try {
                await client.from('noticias').insert({ titulo, conteudo, data_jornal });
                document.getElementById('nova-noticia-titulo').value = '';
                document.getElementById('nova-noticia-conteudo').value = '';
                document.getElementById('nova-noticia-data').value = '';
                carregarNoticias();
                log(`üì∞ Not√≠cia publicada: ${titulo}`);
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`);
            }
        }

        async function removerNoticia(id) {
            if (!confirm('Remover esta not√≠cia?')) return;
            await client.from('noticias').delete().eq('id', id);
            carregarNoticias();
            log('üóëÔ∏è Not√≠cia removida');
        }

        // Carregar melhorias
        async function carregarMelhorias() {
            try {
                const { data, error } = await client.from('melhorias').select('*').order('custo');
                if (error) throw error;
                
                // Busca votos
                let votos = [];
                try {
                    const { data: votosData } = await client.from('votos_melhorias').select('*');
                    votos = votosData || [];
                } catch (e) { }
                
                const lista = document.getElementById('lista-melhorias');
                if (!data || data.length === 0) {
                    lista.innerHTML = '<p style="text-align:center; color:#666;">Nenhuma melhoria cadastrada</p>';
                    return;
                }
                
                lista.innerHTML = data.map(m => {
                    const status = m.status || 'bloqueada';
                    const statusColor = { bloqueada: '#888', disponivel: '#ffcc80', adquirida: '#4caf50' };
                    const votosDestaMelhoria = votos.filter(v => v.melhoria_id === m.id);
                    const votosHtml = votosDestaMelhoria.length > 0 
                        ? `<div style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;">
                            ${votosDestaMelhoria.map(v => `<span style="background:rgba(255,204,128,0.2); border:1px solid #ffcc80; padding:2px 6px; border-radius:10px; font-size:0.75em; color:#ffcc80;">${v.nome_personagem}</span>`).join('')}
                           </div>`
                        : '';
                    return `
                    <div class="bando-item">
                        <div class="bando-item-info">
                            <div class="bando-item-name">${m.icone || '‚öôÔ∏è'} ${m.nome} ${votosDestaMelhoria.length > 0 ? `<span style="color:#ffcc80; font-size:0.8em;">(${votosDestaMelhoria.length} voto${votosDestaMelhoria.length > 1 ? 's' : ''})</span>` : ''}</div>
                            <div class="bando-item-sub">${m.descricao || ''} | Custo: $${m.custo}</div>
                            ${votosHtml}
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px; align-items:flex-end;">
                            <select class="status-select" style="color: ${statusColor[status]};" onchange="alterarStatusMelhoria(${m.id}, this.value)">
                                <option value="bloqueada" ${status === 'bloqueada' ? 'selected' : ''}>üîí Bloqueada</option>
                                <option value="disponivel" ${status === 'disponivel' ? 'selected' : ''}>üîì Dispon√≠vel</option>
                                <option value="adquirida" ${status === 'adquirida' ? 'selected' : ''}>‚úÖ Adquirida</option>
                            </select>
                            ${votosDestaMelhoria.length > 0 ? `<button class="btn-bando btn-bando-del" style="font-size:0.7em; padding:3px 8px;" onclick="limparVotos(${m.id})">üóëÔ∏è Limpar votos</button>` : ''}
                        </div>
                    </div>
                `}).join('');
            } catch (err) {
                document.getElementById('lista-melhorias').innerHTML = '<p style="color:#d32f2f;">Erro ao carregar melhorias</p>';
            }
        }

        async function limparVotos(melhoriaId) {
            if (!confirm('Limpar todos os votos desta melhoria?')) return;
            await client.from('votos_melhorias').delete().eq('melhoria_id', melhoriaId);
            carregarMelhorias();
            log('üóëÔ∏è Votos limpos');
        }

        async function alterarStatusMelhoria(id, novoStatus) {
            console.log('Alterar status melhoria:', { id, novoStatus });
            
            const { data, error } = await client
                .from('melhorias')
                .update({ status: novoStatus })
                .eq('id', id)
                .select();
            
            console.log('Resultado update:', { data, error });
            
            if (error) {
                log(`‚ùå Erro ao alterar melhoria: ${error.message}`);
                alert(`Erro: ${error.message}\n\nVerifique se o RLS est√° desabilitado na tabela 'melhorias' no Supabase.`);
                carregarMelhorias();
                return;
            }
            
            if (!data || data.length === 0) {
                log(`‚ö†Ô∏è Nenhuma linha foi atualizada. Verifique o RLS no Supabase!`);
                alert('Nenhuma linha foi atualizada!\n\nV√° em Supabase > Table Editor > melhorias > RLS Policies e desabilite ou adicione uma policy.');
                carregarMelhorias();
                return;
            }
            
            const statusLabel = { bloqueada: 'bloqueada', disponivel: 'dispon√≠vel', adquirida: 'adquirida' };
            log(`‚öôÔ∏è Melhoria agora est√° ${statusLabel[novoStatus]}`);
        }

        // Inicializar dados do bando
        function initBando() {
            carregarDadosBando();
            carregarMembros();
            carregarNoticias();
            carregarMelhorias();
        }

        client.channel('gm-dashboard').on('postgres_changes', { event: '*', schema: 'public', table: 'Fichas' }, 
            (payload) => {
                const index = allPlayers.findIndex(p => p.id === payload.new.id);
                if (index !== -1) allPlayers[index] = payload.new;
                else allPlayers.push(payload.new);
                renderTable();
                atualizarSelectAlvos();
            }).subscribe();

        fetchPlayers();
        initBando();
        log("Sistema conectado.");
    </script>
</body>
</html>