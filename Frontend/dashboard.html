<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mestre ‚Äî A √öltima Dose</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg-dark: #1a1411; --panel-bg: #2b221e; --text-light: #e6dccf; --gold: #ffcc80; --red: #ff5555; --green: #55ff55; }
        body { background-color: var(--bg-dark); color: var(--text-light); font-family: 'Courier Prime', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { font-family: 'Rye', serif; color: var(--gold); text-align: center; border-bottom: 2px solid var(--gold); padding-bottom: 10px; width: 100%; max-width: 1000px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 350px; gap: 20px; width: 100%; max-width: 1200px; margin-top: 20px; }
        
        /* PAINEL JOGADORES */
        .players-panel { background: var(--panel-bg); border: 2px solid #5d4037; padding: 15px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-family: 'Rye'; color: var(--gold); border-bottom: 1px solid #555; padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #333; }
        .status-ok { color: var(--green); font-weight: bold; }
        .status-bad { color: var(--red); font-weight: bold; }
        .status-neutral { color: #aaa; }
        .btn-mini-xp { background: var(--gold); color: #000; border: none; font-family: 'Rye'; cursor: pointer; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; }
        .btn-mini-xp:hover { background: #ffaa00; }

        /* PAINEL CONTROLES */
        .controls-panel { display: flex; flex-direction: column; gap: 20px; }
        .control-box { background: var(--panel-bg); border: 2px solid #5d4037; padding: 20px; border-radius: 8px; text-align: center; }
        .control-box h3 { font-family: 'Rye'; margin: 0 0 15px 0; color: var(--gold); }
        .gm-select { width: 100%; padding: 10px; margin-bottom: 10px; background: #1a1411; color: var(--gold); border: 1px solid #5d4037; font-family: 'Rye'; font-size: 1rem; cursor: pointer; }
        .gm-btn { width: 100%; padding: 15px; font-family: 'Rye'; font-size: 1.2rem; cursor: pointer; border: none; border-radius: 5px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.1s; }
        .gm-btn:active { transform: translateY(2px); }
        .btn-day { background: #2e4053; color: #fff; border: 2px solid #5d6d7e; } .btn-day:hover { background: #34495e; }
        .btn-damage { background: #641e16; color: #fff; border: 2px solid #922b21; } .btn-damage:hover { background: #7b241c; }
        .btn-roll { background: #7d6608; color: #fff; border: 2px solid #b7950b; }

        /* LOG */
        .log-box { background: #000; color: #0f0; font-family: monospace; padding: 10px; height: 200px; overflow-y: auto; border: 1px solid #333; font-size: 0.9rem; text-align: left; margin-top: 10px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px dashed #333; padding-bottom: 2px; }
        .log-time { color: #666; margin-right: 5px; }

        /* MODAL XP */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-xp { background: url('assets/paper-bg.jpg') center/cover; padding: 30px; border: 4px solid var(--gold); width: 90%; max-width: 500px; text-align: left; color: #1a1a1a; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .modal-xp h2 { font-family: 'Rye'; margin: 0 0 20px 0; border-bottom: 2px solid #1a1a1a; padding-bottom: 10px; text-align: center; }
        
        .xp-question { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 5px; cursor: pointer; }
        .xp-question:hover { background: rgba(255,255,255,0.8); }
        .xp-question input { width: 20px; height: 20px; margin-top: 3px; cursor: pointer; }
        .xp-question label { font-family: 'Courier Prime'; font-size: 1.1rem; cursor: pointer; font-weight: bold; line-height: 1.4; flex: 1; }
        
        .xp-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm-xp { flex: 1; background: #2e7d32; color: #fff; padding: 12px; font-family: 'Rye'; border: none; cursor: pointer; font-size: 1.1rem; }
        .btn-cancel-xp { flex: 1; background: #555; color: #fff; padding: 12px; font-family: 'Rye'; border: none; cursor: pointer; font-size: 1.1rem; }

        .btn-lvl-set {
            flex: 1; background: #333; color: #aaa; border: 1px solid #555;
            cursor: pointer; padding: 5px; font-family: 'Courier Prime'; font-size: 0.8rem;
        }
        .btn-lvl-set:hover { background: #444; color: #fff; border-color: #fff; }
        
        /* Bot√£ozinho de editar ao lado do XP */
        .btn-edit-mini {
            background: transparent; border: none; cursor: pointer; font-size: 1rem;
            opacity: 0.5; transition: 0.2s;
        }
        .btn-edit-mini:hover { opacity: 1; transform: scale(1.2); }

        @media (max-width: 800px) { .dashboard-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <h1>DASHBOARD DO MESTRE</h1>

    <div class="dashboard-grid">
        
        <div class="players-panel">
            <h3>Vis√£o Geral do Bando</h3>
            <table id="players-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>XP (N√≠vel)</th> <th>Vida/Dor</th>
                        <th>Status</th>
                        <th>A√ß√µes</th> </tr>
                </thead>
                <tbody id="players-body">
                    <tr><td colspan="5">Procurando fugitivos...</td></tr>
                </tbody>
            </table>
        </div>


        <div class="modal-overlay" id="modal-edit-xp">
            <div class="modal-xp" style="border-color: #555;">
                <h2>üõ†Ô∏è Ajuste Manual</h2>
                <p style="text-align:center;">Editando: <b id="edit-target-name">...</b></p>
                
                <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:5px; margin-bottom:15px;">
                    <label style="display:block; color:#aaa; font-size:0.8rem;">XP ATUAL:</label>
                    <input type="number" id="input-manual-xp" style="width:100%; padding:10px; font-family:'Rye'; font-size:1.5rem; text-align:center; background:#222; color:#fff; border:1px solid #555;">
                </div>

                <div style="display:flex; justify-content:space-between; gap:5px; margin-bottom:20px;">
                    <button onclick="setNivelManual(1)" class="btn-lvl-set">Lv.1</button>
                    <button onclick="setNivelManual(2)" class="btn-lvl-set">Lv.2</button>
                    <button onclick="setNivelManual(3)" class="btn-lvl-set">Lv.3</button>
                    <button onclick="setNivelManual(4)" class="btn-lvl-set">Lv.4</button>
                    <button onclick="setNivelManual(5)" class="btn-lvl-set">Lv.5</button>
                    <button onclick="setNivelManual(6)" class="btn-lvl-set">Lv.6</button>
                </div>

                <div class="xp-actions">
                    <button class="btn-cancel-xp" onclick="document.getElementById('modal-edit-xp').style.display='none'">Cancelar</button>
                    <button class="btn-confirm-xp" onclick="salvarManualXP()">Salvar</button>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            
            <div class="control-box">
                <h3>Passagem de Tempo</h3>
                <p style="font-size: 0.8rem; color: #aaa;">Consome ra√ß√£o ou causa Dor.</p>
                <button class="gm-btn btn-day" onclick="virarODia()">
                    üåô Virar o Dia
                </button>
            </div>

            <div class="control-box">
                <h3>Caos & Destrui√ß√£o</h3>
                <label style="display:block; text-align:left; font-size:0.8rem; color:#aaa; margin-bottom:5px;">Alvo da Avaria:</label>
                <select id="alvo-avaria" class="gm-select">
                    <option value="random">üé≤ Aleat√≥rio (Sorte)</option>
                </select>

                <button class="gm-btn btn-damage" onclick="causarAvaria()">
                    üß• Causar Avaria
                </button>
                <button class="gm-btn btn-roll" onclick="rolarEncontro()">
                    üé≤ Encontro (d6)
                </button>
            </div>

            <div class="log-box" id="gm-log">
                <div class="log-entry">> Sistema iniciado.</div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="modal-xp">
        <div class="modal-xp">
            <h2>Sess√£o Encerrada</h2>
            <p style="text-align:center; margin-bottom:20px;">Avaliando: <b id="xp-target-name">...</b></p>
            
            <div class="xp-question" onclick="toggleCheck('xp1')">
                <input type="checkbox" id="xp1">
                <label for="xp1">1. Seu PJ chegou vivo ao final da sess√£o?</label>
            </div>
            <div class="xp-question" onclick="toggleCheck('xp2')">
                <input type="checkbox" id="xp2">
                <label for="xp2">2. Seu PJ tem mais dinheiro do que no come√ßo?</label>
            </div>
            <div class="xp-question" onclick="toggleCheck('xp3')">
                <input type="checkbox" id="xp3">
                <label for="xp3">3. Seu PJ ajudou o bando de alguma forma?</label>
            </div>
            <div class="xp-question" onclick="toggleCheck('xp4')">
                <input type="checkbox" id="xp4">
                <label for="xp4">4. Seu PJ resolveu o problema de algu√©m?</label>
            </div>
            <div class="xp-question" onclick="toggleCheck('xp5')">
                <input type="checkbox" id="xp5">
                <label for="xp5">5. Terminou com alguma Carta de Sina?</label>
            </div>

            <div class="xp-actions">
                <button class="btn-cancel-xp" onclick="fecharModalXP()">Cancelar</button>
                <button class="btn-confirm-xp" onclick="confirmarXP()">Confirmar XP</button>
            </div>
        </div>
    </div>

    <script>
        let allPlayers = [];
        let xpSession = { targetId: null, targetName: null }; // Guarda quem vai ganhar XP

        // 1. CARREGAR DADOS
        async function fetchPlayers() {
            const { data, error } = await client.from('Fichas').select('*').order('nome_personagem');
            if (error) { log(`Erro: ${error.message}`); return; }
            allPlayers = data;
            renderTable();
            atualizarSelectAlvos();
        }

        // 2. RENDERIZAR TABELA (ATUALIZADO)
        function renderTable() {
            const tbody = document.getElementById('players-body');
            tbody.innerHTML = '';

            allPlayers.forEach(player => {
                const attr = player.atributos || {};
                const rec = attr.recursos || { racoes: 0, alimentadoHoje: false };
                const vest = attr.vestimentas || [];
                const avarias = vest.filter(v => v.estado && v.estado !== 'bom').length;
                
                // Calcula XP e N√≠vel para exibir
                const xpAtual = attr.xp || 0;
                let nivel = 1;
                if(xpAtual >= 10) nivel = 2;
                if(xpAtual >= 20) nivel = 3;
                if(xpAtual >= 30) nivel = 4;
                if(xpAtual >= 45) nivel = 5;
                if(xpAtual >= 65) nivel = 6;

                let foodStatus = rec.alimentadoHoje ? '<span class="status-ok">OK</span>' : '<span class="status-bad">FOME</span>';
                if(avarias > 0) foodStatus += ` | ‚ö†Ô∏è ${avarias} avarias`;


                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold; color:var(--gold)">${player.nome_personagem}</td>
                    <td>
                        Lv.${nivel} (${xpAtual} XP)
                        <button class="btn-edit-mini" onclick="abrirEditManual('${player.id}', '${player.nome_personagem}', ${xpAtual})" title="Editar Manualmente">‚úèÔ∏è</button>
                    </td>
                    <td>üíÄ ${attr.vida || 0} / ü©∏ ${attr.dor || 0}</td>
                    <td>${foodStatus}</td>
                    <td>
                        <button class="btn-mini-xp" onclick="abrirModalXP('${player.id}', '${player.nome_personagem}')">
                            ‚òÖ DAR XP
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 3. L√ìGICA DE XP (NOVO)
        function abrirModalXP(id, nome) {
            xpSession.targetId = id;
            xpSession.targetName = nome;
            
            // Reseta modal
            document.getElementById('xp-target-name').innerText = nome;
            for(let i=1; i<=5; i++) document.getElementById(`xp${i}`).checked = false;
            
            document.getElementById('modal-xp').style.display = 'flex';
        }

        function fecharModalXP() {
            document.getElementById('modal-xp').style.display = 'none';
        }

        // Helper para clicar na div e marcar o checkbox
        function toggleCheck(id) {
            // Se clicar direto no input, n√£o faz nada (evento padr√£o j√° resolve)
            // Se clicar na div, inverte o input
            // (Na verdade o evento onclick na div j√° pega tudo, mas precisamos evitar duplo toggle se clicar no label)
        }

        async function confirmarXP() {
            let totalXP = 0;
            for(let i=1; i<=5; i++) {
                if(document.getElementById(`xp${i}`).checked) totalXP++;
            }

            if(totalXP === 0) {
                if(!confirm("Nenhum ponto marcado. Confirmar 0 XP?")) return;
            }

            // Busca o jogador atualizado do array local
            const player = allPlayers.find(p => p.id == xpSession.targetId);
            if(player) {
                const attr = player.atributos;
                const xpAntigo = attr.xp || 0;
                const xpNovo = xpAntigo + totalXP;
                attr.xp = xpNovo;

                // Salva no banco
                await client.from('Fichas').update({ atributos: attr }).eq('id', player.id);
                
                log(`üåü XP: ${player.nome_personagem} ganhou +${totalXP} XP (Total: ${xpNovo}).`);
                fecharModalXP();
            }
        }

        // ... (Outras fun√ß√µes existentes: atualizarSelectAlvos, virarODia, causarAvaria, rolarEncontro, log) ...
        
        function atualizarSelectAlvos() {
            const select = document.getElementById('alvo-avaria');
            const valorAtual = select.value;
            select.innerHTML = '<option value="random">üé≤ Aleat√≥rio (Sorte)</option>';
            allPlayers.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.innerText = p.nome_personagem;
                select.appendChild(option);
            });
            if (valorAtual && valorAtual !== 'random') select.value = valorAtual;
        }

        async function virarODia() {
            if(!confirm("Virar o dia?")) return;
            log("--- NOVO DIA ---");
            for (let player of allPlayers) {
                let attr = player.atributos;
                if (!attr.recursos) attr.recursos = { racoes: 0, alimentadoHoje: false };
                let msg = "";
                if (attr.recursos.alimentadoHoje) {
                    attr.recursos.alimentadoHoje = false;
                    msg = `‚úÖ ${player.nome_personagem} ok.`;
                } else {
                    attr.dor = (attr.dor || 0) + 1;
                    msg = `‚ùå ${player.nome_personagem} FOME (+1 Dor)`;
                    if (attr.dor >= 6) {
                        attr.dor = 0; attr.vida = (attr.vida || 0) + 1;
                        msg += " -> üí• FERIMENTO!";
                    }
                }
                log(msg);
                await client.from('Fichas').update({ atributos: attr }).eq('id', player.id);
            }
        }

        // TABELA DE XP (Para setar n√≠vel r√°pido)
        const XP_POR_NIVEL = { 1: 0, 2: 10, 3: 20, 4: 30, 5: 45, 6: 65 };
        let editSession = { id: null };

        function abrirEditManual(id, nome, xpAtual) {
            editSession.id = id;
            document.getElementById('edit-target-name').innerText = nome;
            document.getElementById('input-manual-xp').value = xpAtual;
            document.getElementById('modal-edit-xp').style.display = 'flex';
        }

        function setNivelManual(nivel) {
            // Preenche o input com o XP base daquele n√≠vel
            document.getElementById('input-manual-xp').value = XP_POR_NIVEL[nivel];
        }

        async function salvarManualXP() {
            const novoXP = parseInt(document.getElementById('input-manual-xp').value) || 0;
            const player = allPlayers.find(p => p.id == editSession.id);
            
            if(player) {
                const attr = player.atributos;
                attr.xp = novoXP; // Sobrescreve direto

                await client.from('Fichas').update({ atributos: attr }).eq('id', player.id);
                log(`üõ†Ô∏è AJUSTE: ${player.nome_personagem} definido para ${novoXP} XP.`);
                document.getElementById('modal-edit-xp').style.display = 'none';
            }
        }


        async function causarAvaria() {
            if (allPlayers.length === 0) return;
            const select = document.getElementById('alvo-avaria');
            const targetId = select.value;
            let targetPlayer;
            if (targetId === 'random') {
                const randIndex = Math.floor(Math.random() * allPlayers.length);
                targetPlayer = allPlayers[randIndex];
            } else {
                targetPlayer = allPlayers.find(p => p.id == targetId);
            }
            if (!targetPlayer) { log("Erro: Jogador n√£o encontrado."); return; }
            const attr = targetPlayer.atributos;
            if (!attr.vestimentas || attr.vestimentas.length === 0) {
                log(`ü§∑‚Äç‚ôÇÔ∏è ${targetPlayer.nome_personagem} n√£o tem roupas.`);
                return;
            }
            const validClothes = attr.vestimentas.map((v, i) => ({ ...v, index: i })).filter(v => v.nome && v.estado !== 'destruido');
            if (validClothes.length === 0) {
                log(`‚ò†Ô∏è ${targetPlayer.nome_personagem} j√° est√° com tudo destru√≠do!`);
                return;
            }
            const randClothIndex = Math.floor(Math.random() * validClothes.length);
            const targetCloth = validClothes[randClothIndex];
            const originalIndex = targetCloth.index;
            const estados = ['bom', 'usado', 'rasgado', 'destruido'];
            const currentStateIndex = estados.indexOf(targetCloth.estado || 'bom');
            const newState = estados[currentStateIndex + 1] || 'destruido';
            attr.vestimentas[originalIndex].estado = newState;
            log(`üí• ${targetPlayer.nome_personagem}: '${targetCloth.nome}' agora est√° [${newState.toUpperCase()}]!`);
            await client.from('Fichas').update({ atributos: attr }).eq('id', targetPlayer.id);
        }

        function rolarEncontro() {
            const tab = ["Sil√™ncio...", "Rastros frescos.", "Animal selvagem.", "Mudan√ßa de clima.", "Viajante/Comerciante.", "‚ö†Ô∏è EMBOSCADA!"];
            const d6 = Math.floor(Math.random() * 6);
            log(`üé≤ (d6=${d6+1}): ${tab[d6]}`);
        }

        function log(msg) {
            const box = document.getElementById('gm-log');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            box.innerHTML = `<div class="log-entry"><span class="log-time">[${time}]</span> ${msg}</div>` + box.innerHTML;
        }

        // REALTIME
        client.channel('gm-dashboard').on('postgres_changes', { event: '*', schema: 'public', table: 'Fichas' }, 
            (payload) => {
                const index = allPlayers.findIndex(p => p.id === payload.new.id);
                if (index !== -1) allPlayers[index] = payload.new;
                else allPlayers.push(payload.new);
                renderTable();
                atualizarSelectAlvos();
            })
            .subscribe();

        fetchPlayers();
        log("Sistema conectado.");

    </script>
</body>
</html>