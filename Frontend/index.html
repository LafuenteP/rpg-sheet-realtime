<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ficha ‚Äî A √öltima Dose</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Rye&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
:root {
    --ink: #2b1b12;
    --gold: #ffcc80;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    padding: 0;
    background: #1a1411;
    font-family: 'Courier Prime', monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
}

/* ===== MENU DE NAVEGA√á√ÉO ===== */
.western-nav {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 15px;
    background: rgba(43, 27, 18, 0.95);
    border-bottom: 2px solid #5d4037;
    width: 100%;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    flex-shrink: 0;
}

.western-nav a {
    color: #aaa;
    text-decoration: none;
    font-family: 'Rye', serif;
    font-size: 1rem;
    padding: 5px 10px;
    border: 1px solid transparent;
    transition: all 0.2s;
    text-transform: uppercase;
}

.western-nav a:hover {
    color: var(--gold);
    border-color: var(--gold);
}

.western-nav a.active {
    color: var(--gold);
    border-bottom: 2px solid var(--gold);
}

/* ===== FICHA ===== */
.sheet {
    display: grid;
    grid-template-columns: 38% 62%;
    width: min(98%, 1600px);
    background: url("assets/paper-bg.jpg") no-repeat center;
    background-size: cover;
    padding: clamp(20px, 3vw, 40px);
    gap: clamp(15px, 2vw, 25px);
    box-shadow: 0 0 40px rgba(0,0,0,.8);
    min-height: min(85vh, 900px);
    max-height: 1200px;
}

/* ===== ESQUERDA ===== */
.sheet-left {
    display: flex;
    flex-direction: column;
    gap: 20px;
    justify-content: flex-start;
    position: relative;
}

.portrait-frame {
    background: url("assets/portrait-frame.png") no-repeat center;
    background-size: contain;
    padding: 5px;
    padding-left: 0px;
    width: 140%;
}

.portrait-frame img {
    width: 100%;
    display: block;
}

.name-banner {
    background: url("assets/name-banner.png") no-repeat center;
    background-size: 100% 100%;
    width: 100%;
    height: clamp(650px, 20vh, 200px);
    position: absolute;
    bottom: -190px;
    left: 10%;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
}


.name-banner h1 {
    margin: 0;
    padding-bottom: 80px;
    font-family: 'Rye';
    letter-spacing: 3.5px;
    font-size: clamp(1.2rem, 3.5vw, 3.5rem);
}

/* Garante que o SVG ocupe o espa√ßo do banner */
.name-banner svg {
    width: 100%;
    height: 100%;
    overflow: visible;
}

/* Estilo do texto dentro do SVG */
.texto-curvado {
    font-family: 'Rye', serif;
    font-size: clamp(0.5rem, 2.5vw, 2.5rem);
    fill: #2b1b12;
    letter-spacing: 4px;
    text-transform: uppercase;
    font-weight: bold;
}

/* ===== DIREITA ===== */
.sheet-right {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: clamp(10px, 2vw, 25px);
}

.wanted-strip {
    text-align: center;
    font-family: 'Rye';
    letter-spacing: 3px;
    border-bottom: 2px solid var(--ink);
    padding-bottom: 10px;
    font-size: clamp(0.8rem, 1.5vw, 1.2rem);
}

/* ===== ATRIBUTOS ===== */
.attributes {
    display: flex;
    gap: clamp(1px, 0.3vw, 6px);
    justify-content: right;
    flex-wrap: wrap;
}

.attribute-card {
    background: url("assets/wanted-card.png") no-repeat center;
    background-size: contain;
    width: clamp(40px, 10vw, 200px);
    aspect-ratio: 3 / 4;
    text-align: center;
    padding-top: 5%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.attribute-card:nth-child(1) {
    transform: rotate(-3deg);
}

.attribute-card:nth-child(2) {
    transform: rotate(2deg);
}

.attribute-card:nth-child(3) {
    transform: rotate(-2deg);
}

.attribute-card:nth-child(4) {
    transform: rotate(3deg);
}

.attribute-card label {
    display: block;
    font-family: 'Rye';
    font-size: clamp(1rem, 2vw, 1.6rem);
    margin-top: -50px;
}

.attribute-card input {
    width: 80%;
    border: none;
    background: transparent;
    font-size: clamp(1.9rem, 3.3vw, 3.4rem);
    font-family: 'Rye', serif;
    text-align: center;
    color: var(--ink);
    margin-left: 10%;
    margin-top: 30%;
}

/* ===== SE√á√ÉO VITAIS (VIDA E DOR) ===== */
.vitals-section {
    display: flex;
    flex-direction: column;
    gap: clamp(1px, 1.5vw, 15px);
    padding: 0px 130px;
    flex-shrink: 0;
}

.vital-row {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: clamp(8px, 1.5vw, 15px);
    flex-wrap: nowrap;
}

.vital-row label {
    font-family: 'Rye';
    font-size: clamp(1.6rem, 2vw, 2.0rem);
    color: var(--ink);
    text-transform: uppercase;
    white-space: nowrap;
    flex-shrink: 0;
}

.track {
    display: flex;
    gap: 6px;
    flex-wrap: nowrap;
    align-items: center;
    max-width: 350px;
}

.track img {
    width: 40px;
    min-width: 20px;
    flex: 1 1 auto;
    opacity: 0.2;
    cursor: pointer;
    transition: transform 0.1s, opacity 0.2s;
}

.track img:hover {
    transform: scale(1.2);
}

.track img.active {
    opacity: 1;
}

/* ===== BANNER DE A√á√ïES ===== */
.acoes-antecedentes-row {
    display: flex;
    gap: 20px;
    align-items: center;
}

.acoes-banner {
    background: url("assets/acoes.png") no-repeat center center;
    background-size: contain;
    width: 55%;
    height: clamp(150px, 20vh, 260px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5% 18% 5% 18%;
    flex-shrink: 0;
    margin-left: 6%;

}

.acoes-banner input {
    width: 60px;
    border: none;
    background: transparent;
    font-size: clamp(2.3rem, 3.9vw, 3.3rem);
    font-family: 'Rye', serif;
    text-align: center;
    color: var(--ink);
    pointer-events: none;
    -moz-appearance: textfield;
    appearance: textfield;
}

.acoes-banner input::-webkit-outer-spin-button,
.acoes-banner input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* ===== MODAL DE CONDI√á√ÉO ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal-condicao {
    background: url("assets/fundodor.png") no-repeat center;
    background-size: cover;
    padding: 40px 50px;
    border: 4px solid #2b1b12;
    box-shadow: 0 0 30px rgba(0,0,0,0.9);
    text-align: center;
    max-width: 500px;
    transform: scale(0.8);
    transition: transform 0.3s;
}

.modal-overlay.show .modal-condicao {
    transform: scale(1);
}

.modal-condicao h2 {
    font-family: 'Rye';
    color: #8b0000;
    margin: 0 0 10px 0;
    font-size: 2.2rem;
}

.modal-condicao .condicao-nome {
    font-family: 'Rye';
    color: var(--ink);
    font-size: 2rem;
    margin: 15px 0;
}

.modal-condicao .condicao-efeito {
    font-family: 'Courier Prime';
    color: var(--ink);
    font-size: 1.4rem;
    line-height: 1.5;
}

.modal-condicao button {
    margin-top: 20px;
    padding: 12px 35px;
    font-family: 'Rye';
    font-size: 1.3rem;
    border: none;
    background: #5d4037;
    color: #e6dccf;
    cursor: pointer;
}

.modal-condicao button:hover {
    background: #6d5047;
}

/* ===== BOX DE ANOTA√á√ïES ===== */
.anotacoes-box {
    width: 88%;
    margin-top: -20px;
    margin-left: auto;
}

.anotacoes-box h4 {
    font-family: 'Rye';
    color: var(--ink);
    margin: 0 0 8px 0;
    font-size: clamp(1rem, 1.4vw, 1.3rem);
}

.anotacoes-box textarea {
    width: 100%;
    height: clamp(120px, 18vh, 200px);
    padding: 10px;
    font-family: 'Courier Prime', monospace;
    font-size: clamp(0.9rem, 1.2vw, 1.1rem);
    color: var(--ink);
    background: rgba(255, 250, 240, 1);
    border: 2px solid var(--ink);
    border-radius: 5px;
    resize: none;
}

.anotacoes-box textarea::placeholder {
    color: rgba(43, 27, 18, 1);
    font-style: italic;
}

.anotacoes-box textarea:focus {
    outline: none;
    border-color: #5d4037;
    background: rgba(255, 250, 240, 1);
}



/* ===== ANTECEDENTES ===== */
.antecedentes-section {
    flex: 1;
}

.antecedentes-section h3 {
    font-family: 'Rye';
    color: var(--ink);
    margin: 0 62px 10px 0;
    font-size: clamp(1.2rem, 1.8vw, 1.6rem);
    text-align: center;
}

.skills-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 5px;
    max-width: 400px;
    margin: 0;
    margin-right: auto;
    margin-left: -20px;
}

.skill-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.skill-item label {
    font-family: 'Rye';
    font-size: clamp(0.9rem, 1.4vw, 1.2rem);
    color: var(--ink);
    white-space: nowrap;
}

.skill-item input {
    width: 40px;
    border: none;
    background: transparent;
    font-size: clamp(1.2rem, 1.6vw, 1.5rem);
    font-family: 'Rye', serif;
    text-align: center;
    color: var(--ink);
}

.skill-item::after {
    content: '';
    display: inline-block;
    width: 25px;
    height: 25px;
    background: url('assets/halteres.png') no-repeat center;
    background-size: contain;
}

/* ===== STATUS INDICATOR ===== */
.status-indicator {
    position: fixed;
    bottom: 10px;
    right: 10px;
    color: #fff;
    opacity: 0.7;
    font-size: 0.8rem;
    transition: opacity 0.3s;
}

/* =========================================
   RESPONSIVIDADE MOBILE
   ========================================= */

/* Tablets e telas m√©dias */
@media (max-width: 1024px) {
    .sheet {
        width: 98%;
        grid-template-columns: 35% 65%;
        background: url("assets/fundomob.jpg") no-repeat center;
        background-size: cover;
    }
    
    .acoes-banner {
        width: 50%;
    }
}

/* Celulares */
@media (max-width: 768px) {
    
    /* Layout geral - coluna √∫nica */
    .sheet {
        display: flex;
        flex-direction: column;
        width: 100%;
        padding: 15px;
        min-height: auto;
        max-height: none;
        gap: 20px;
        background: url("assets/fundomob.jpg") no-repeat center;
        background-size: cover;
    }

    /* Se√ß√£o esquerda (foto e nome) */
    .sheet-left {
        width: 100%;
        align-items: center;
    }

    .portrait-frame {
        width: 80%;
        max-width: 300px;
        margin: 0 auto;
    }

    .name-banner {
        position: relative;
        bottom: auto;
        left: auto;
        width: 95%;
        height: 600px;
        margin-top: -400px;
    }
    
    .texto-curvado {
        font-size: 32px;
    }

    /* Se√ß√£o direita */
    .sheet-right {
        width: 100%;
    }

    .wanted-strip {
        font-size: 1rem;
        text-align: center;
    }

    /* Atributos (cartas) */
    .attributes {
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
    }

    .attribute-card {
        width: 130px;
        transform: none !important;
    }
    
    .attribute-card label {
        font-size: 1.1rem;
        margin-top: -20px;
    }
    
    .attribute-card input {
        font-size: 2.2rem;
        margin-top: 18%;
        margin-left: 20px;
    }

    /* Vida e Dor */
    .vitals-section {
        padding: 0 10px;
    }

    .vital-row {
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .vital-row label {
        font-size: 1.1rem;
        text-align: center;
    }

    .track {
        justify-content: center;
        max-width: 100%;
    }

    .track img {
        width: 30px;
        min-width: 22px;
    }

    /* A√ß√µes e Antecedentes */
    .acoes-antecedentes-row {
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }

    .acoes-banner {
        width: 95%;
        max-width: 350px;
        height: 160px;
        margin-left: 0;
        padding: 6% 14%;
    }
    
    .acoes-banner input {
        font-size: 2.2rem;
    }

    .antecedentes-section {
        width: 100%;
    }

    .antecedentes-section h3 {
        margin: 0 0 10px 0;
        text-align: center;
    }

    .skills-grid {
        max-width: 100%;
        margin: 0 auto;
        gap: 10px 15px;
    }

    .skill-item {
        justify-content: center;
    }

    .skill-item label {
        font-size: 0.85rem;
    }

    .skill-item input {
        width: 35px;
        font-size: 1.1rem;
    }

    .skill-item::after {
        width: 20px;
        height: 20px;
    }

    /* Anota√ß√µes */
    .anotacoes-box {
        width: 100%;
        margin: 0;
    }

    .anotacoes-box textarea {
        height: 100px;
    }

    /* Menu de Navega√ß√£o */
    .western-nav {
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
    }
    
    .western-nav a {
        font-size: 0.85rem;
        padding: 5px 8px;
    }
    
    /* Modal */
    .modal-condicao {
        max-width: 90%;
        padding: 25px 20px;
    }
    
    .modal-condicao h2 {
        font-size: 1.6rem;
    }
    
    .modal-condicao .condicao-nome {
        font-size: 1.4rem;
    }
    
    .modal-condicao .condicao-efeito {
        font-size: 1.1rem;
    }
}

/* Celulares pequenos */
@media (max-width: 480px) {
    .sheet {
        padding: 10px;
    }

    .portrait-frame {
        width: 90%;
    }

    .attribute-card {
        width: 85px;
    }
    
    .attribute-card label {
        font-size: 0.95rem;
    }
    
    .attribute-card input {
        font-size: 1.8rem;
    }

    .track img {
        width: 25px;
        min-width: 18px;
    }

    .skills-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .western-nav a {
        font-size: 0.85rem;
        padding: 5px 8px;
    }
}

</style>
</head>

<body>

<nav class="western-nav">
    <a href="index.html" class="active">Ficha</a>
    <a href="habilidades.html">Habilidades</a>
    <a href="montaria.html">Montaria</a>
    <a href="inventario.html">Invent√°rio</a>
</nav>

<div class="sheet" id="ficha-container">

    <div class="sheet-left">
        <div class="portrait-frame">
            <img src="assets/portrait.png" alt="Personagem">
        </div>

        <div class="name-banner">
            <svg viewBox="0 0 400 120">
                <path id="curve" d="M40,83 Q200,44 360,68" fill="transparent"/>
                <text width="400">
                    <textPath xlink:href="#curve" startOffset="50%" text-anchor="middle" class="texto-curvado">
                        Trinity
                    </textPath>
                </text>
            </svg>
        </div>
    </div>

    <div class="sheet-right">

        <div class="wanted-strip">WANTED ‚Äî DEAD OR ALIVE</div>

        <div class="attributes">
            <div class="attribute-card">
                <label>FOR</label>
                <input id="forca" type="number" min="0" max="4">
            </div>
            <div class="attribute-card">
                <label>VEL</label>
                <input id="vel" type="number" min="0" max="4">
            </div>
            <div class="attribute-card">
                <label>INT</label>
                <input id="int" type="number" min="0" max="4">
            </div>
            <div class="attribute-card">
                <label>COR</label>
                <input id="cor" type="number" min="0" max="4">
            </div>
        </div>

        <div class="vitals-section">
            <div class="vital-row">
                <label>Pontos de Vida:</label>
                <div class="track vida-track">
                    <!-- Gerado dinamicamente pelo JS -->
                </div>
            </div>

            <div class="vital-row">
                <label>Pontos de Dor:</label>
                <div class="track dor-track">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                </div>
            </div>
        </div>
        
        <div class="acoes-antecedentes-row">
            <div class="acoes-banner">
                <input id="movimento" type="number" min="0" value="2" readonly>
                <input id="combate" type="number" min="0" value="1" readonly>
            </div>

            <div class="antecedentes-section">
                <h3>ANTECEDENTES:</h3>
                <div class="skills-grid">
                    <div class="skill-item">
                        <label>ATEN√á√ÉO:</label>
                        <input type="number" id="atencao" value="0">
                    </div>
                    <div class="skill-item">
                        <label>MEDICINA:</label>
                        <input type="number" id="medicina" value="0">
                    </div>
                    <div class="skill-item">
                        <label>MONTARIA:</label>
                        <input type="number" id="montaria" value="0">
                    </div>
                    <div class="skill-item">
                        <label>NEG√ìCIOS:</label>
                        <input type="number" id="negocios" value="0">
                    </div>

                    <div class="skill-item">
                        <label>ROUBO:</label>
                        <input type="number" id="roubo" value="0">
                    </div>
                    <div class="skill-item">
                        <label>SUOR:</label>
                        <input type="number" id="suor" value="0">
                    </div>
                    <div class="skill-item">
                        <label>TRADI√á√ÉO:</label>
                        <input type="number" id="tradicao" value="0">
                    </div>
                    <div class="skill-item">
                        <label>VIOL√äNCIA:</label>
                        <input type="number" id="violencia" value="0">
                    </div>
                </div>
            </div>
        </div>

        <div class="anotacoes-box">
            <h4>ANOTA√á√ïES:</h4>
            <textarea id="anotacoes" placeholder="Escreva suas anota√ß√µes aqui..."></textarea>
        </div>

    </div>
</div>

<!-- Modal de Condi√ß√£o -->
<div class="modal-overlay" id="modal-condicao">
    <div class="modal-condicao">
        <h2>‚ö† FERIMENTO! ‚ö†</h2>
        <div class="condicao-nome" id="condicao-nome"></div>
        <div class="condicao-efeito" id="condicao-efeito"></div>
        <button onclick="fecharModal()">Entendido</button>
    </div>
</div>
<div id="status" class="status-indicator"></div>

<script>
// Vari√°veis Globais
let dadosLocais = { vida: 0, dor: 0 };
const CONDICOES = [
    { nome: 'Atordoamento', efeito: '-1 A√ß√£o de Combate na pr√≥xima rodada.' },
    { nome: 'Queda', efeito: 'Gaste um Movimento para se levantar.' },
    { nome: 'Distra√ß√£o', efeito: 'N√£o pode atacar esse mesmo alvo no pr√≥ximo ataque.' },
    { nome: 'Sangramento', efeito: '1 de dano adicional por turno at√© o fim do combate.' },
    { nome: 'Intimida√ß√£o', efeito: '√â preciso se afastar do atacante na pr√≥xima rodada.' },
    { nome: 'Desorienta√ß√£o', efeito: '-1 em Testes de Viol√™ncia no pr√≥ximo turno.' }
];

// Helper para pegar valor de ID
const val = (id) => {
    const el = document.getElementById(id);
    return el ? (parseInt(el.value) || 0) : 0;
};

// 1. GERA√á√ÉO DE VIDA E A√á√ïES
function gerarCaveirasVida() {
    const forca = val('forca');
    const totalVida = 6 + forca;
    
    const vidaTrack = document.querySelector('.vida-track');
    vidaTrack.innerHTML = ''; 
    
    for (let i = 0; i < totalVida; i++) {
        const img = document.createElement('img');
        img.src = 'assets/skull.png';
        img.onclick = () => {
            const novoValor = i + 1;
            dadosLocais.vida = (dadosLocais.vida === novoValor) ? 0 : novoValor;
            atualizarVisual();
            salvarFicha();
        };
        vidaTrack.appendChild(img);
    }
    if (dadosLocais.vida > totalVida) dadosLocais.vida = totalVida;
    atualizarVisual();
}

function atualizarAcoes() {
    const vel = val('vel');
    const cor = val('cor');
    document.getElementById('movimento').value = 1 + vel;
    document.getElementById('combate').value = 1 + cor;
}

function atualizarVisual() {
    document.querySelectorAll('.vida-track img').forEach((s, i) => {
        s.classList.toggle('active', i < dadosLocais.vida);
    });
    document.querySelectorAll('.dor-track img').forEach((f, i) => {
        f.classList.toggle('active', i < dadosLocais.dor);
    });
}

// 2. FUN√á√ïES DE SUPABASE

// BUSCAR DADOS
async function buscarDados() {
    const { data, error } = await client
        .from('Fichas')
        .select('*')
        .eq('nome_personagem', NOME_PERSONAGEM)
        .single();

    if (data) preencherTela(data.atributos);
    else if (error) console.error(error);
}

// PREENCHER TELA
function preencherTela(attr) {
    if (!attr) return;

    // Atributos B√°sicos
    document.getElementById('forca').value = attr.for || 0;
    document.getElementById('int').value = attr.int || 0;
    document.getElementById('vel').value = attr.vel || 0;
    document.getElementById('cor').value = attr.cor || 0;

    // Vitais
    dadosLocais.vida = attr.vida || 0;
    dadosLocais.dor = attr.dor || 0;

    // Antecedentes (Verifica se existe o objeto, se n√£o p√µe 0)
    const ant = attr.antecedentes || {};
    document.getElementById('atencao').value = ant.atencao || 0;
    document.getElementById('medicina').value = ant.medicina || 0;
    document.getElementById('montaria').value = ant.montaria || 0;
    document.getElementById('negocios').value = ant.negocios || 0;
    document.getElementById('roubo').value = ant.roubo || 0;
    document.getElementById('suor').value = ant.suor || 0;
    document.getElementById('tradicao').value = ant.tradicao || 0;
    document.getElementById('violencia').value = ant.violencia || 0;

    // Anota√ß√µes
    document.getElementById('anotacoes').value = attr.anotacoes || '';

    // Atualiza l√≥gica derivada
    gerarCaveirasVida();
    atualizarAcoes();
    atualizarVisual();
    
    statusMsg('‚Ä¢ Sincronizado ‚Ä¢');
}

// SALVAR FICHA (AGORA COMPLETO)
async function salvarFicha() {
    statusMsg('Salvando...');

    const novosAtributos = {
        for: val('forca'),
        int: val('int'),
        vel: val('vel'),
        cor: val('cor'),
        vida: dadosLocais.vida,
        dor: dadosLocais.dor,
        // Agrupando Antecedentes
        antecedentes: {
            atencao: val('atencao'),
            medicina: val('medicina'),
            montaria: val('montaria'),
            negocios: val('negocios'),
            roubo: val('roubo'),
            suor: val('suor'),
            tradicao: val('tradicao'),
            violencia: val('violencia')
        },
        // Anota√ß√µes
        anotacoes: document.getElementById('anotacoes').value
    };

    // Pega o cache atual pra n√£o perder Habilidades/Montaria/Invent√°rio
    const { data: currentData } = await client
        .from('Fichas').select('atributos').eq('nome_personagem', NOME_PERSONAGEM).single();
        
    let finalPayload = novosAtributos;
    if(currentData && currentData.atributos) {
        // Mistura o que tem no banco (Habilidades, Montaria) com o que editamos agora
        finalPayload = { ...currentData.atributos, ...novosAtributos };
    }

    const { error } = await client
        .from('Fichas')
        .update({ atributos: finalPayload })
        .eq('nome_personagem', NOME_PERSONAGEM);

    if (!error) {
        statusMsg('‚Ä¢ Salvo ‚Ä¢');
    } else {
        statusMsg('Erro ao salvar!');
        console.error(error);
    }
}

// 3. AUTO-SAVE
function setupAutoSave() {
    // Pega todos os inputs num√©ricos e o textarea
    const inputs = document.querySelectorAll('input[type="number"]:not([readonly]), textarea');
    
    inputs.forEach(input => {
        // Quando mudar e sair do campo, salva
        input.addEventListener('change', () => {
            if(input.id === 'forca' || input.id === 'vel' || input.id === 'cor') {
                gerarCaveirasVida();
                atualizarAcoes();
            }
            salvarFicha();
        });
    });

    // Configura Dor (Cliques)
    const fists = document.querySelectorAll('.dor-track img');
    fists.forEach((img, index) => {
        img.onclick = () => {
            const novoValor = index + 1;
            dadosLocais.dor = (dadosLocais.dor === novoValor) ? 0 : novoValor;
            atualizarVisual();
            salvarFicha();
            if (dadosLocais.dor >= 6) converterDorEmVida();
        };
    });
}

function statusMsg(msg) {
    const el = document.getElementById('status');
    if(el) {
        el.innerText = msg;
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0.5, 2000);
    }
}

// L√≥gica de Condi√ß√£o (Dor -> Vida)
function converterDorEmVida() {
    dadosLocais.dor = 0;
    dadosLocais.vida += 1;
    sortearCondicao();
    atualizarVisual();
    salvarFicha();
}

function sortearCondicao() {
    const d6 = Math.floor(Math.random() * 6);
    const condicao = CONDICOES[d6];
    document.getElementById('condicao-nome').innerText = `üé≤ ${d6 + 1} - ${condicao.nome}`;
    document.getElementById('condicao-efeito').innerText = condicao.efeito;
    document.getElementById('modal-condicao').classList.add('show');
}
function fecharModal() {
    document.getElementById('modal-condicao').classList.remove('show');
}

// 4. REALTIME
client.channel('sala-western')
.on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'Fichas' }, 
    p => {
        if(p.new.nome_personagem === NOME_PERSONAGEM) {
            preencherTela(p.new.atributos);
        }
    }
).subscribe();

// INICIALIZA√á√ÉO
setupAutoSave();
buscarDados();

</script>

</body>
</html>