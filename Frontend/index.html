<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ficha ‚Äî A √öltima Dose</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Rye&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<script>
    // 1. Configura√ß√£o das Senhas
    const SENHAS = {
        'Trinity': 'trinity123',
        'Josue': 'pantufa',
        'Januario': 'morena<3',
        'Mateus': 'junin123',
        'Geraldo': 'ph123',
        'Lucian': 'matheus123',

    };

    // 2. Verifica se j√° tem permiss√£o SALVA antes de mostrar a tela
    function checkAuth() {
        // Se o personagem n√£o precisa de senha, libera
        if (!SENHAS[NOME_PERSONAGEM]) return true;

        // Tenta pegar a permiss√£o salva no navegador
        const authKey = `auth_${NOME_PERSONAGEM}`; // ex: auth_Trinity
        const authData = JSON.parse(localStorage.getItem(authKey));
        
        // Se tem permiss√£o e ela √© recente (menos de 24h)
        if (authData && (Date.now() - authData.time < 86400000)) {
            return true; // Liberado
        }
        return false; // Bloqueado
    }

    // Se N√ÉO estiver autorizado, adiciona a classe 'locked' no corpo assim que poss√≠vel
    if (!checkAuth()) {
        document.documentElement.classList.add('locked');
    }

    // Fun√ß√£o para o bot√£o "Entrar"
    function tentarDesbloquear() {
        const input = document.getElementById('pass-input');
        const erro = document.getElementById('pass-error');
        
        if (input.value === SENHAS[NOME_PERSONAGEM]) {
            // Salva a permiss√£o
            localStorage.setItem(`auth_${NOME_PERSONAGEM}`, JSON.stringify({ time: Date.now() }));
            // Remove o bloqueio
            document.documentElement.classList.remove('locked');
            document.getElementById('tela-senha').style.display = 'none';

            setTimeout(verificarTutorial, 500);

        } else {
            erro.style.display = 'block';
            input.value = '';
        }
    }
</script>


<style>


/* ESTILO DA LISTA DE ALIMENTOS */
/* SUBSTITUA A REGRA ANTIGA POR ESTA */
.lista-alimentos-container {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(255, 250, 240, 0.95); /* Fundo CLARO e OPACO para leitura */
    border: 2px solid var(--ink);
    border-radius: 4px;
    margin-bottom: 15px;
    text-align: left;
    padding: 10px;
    min-height: 60px; /* Garante que a caixa tenha tamanho mesmo vazia */
}

/* Garante que o texto dentro seja escuro e leg√≠vel */
.alimento-option {
    color: #2b1b12; 
    font-weight: bold;
    display: flex;
    align-items: center;
    padding: 8px;
    border-bottom: 1px dashed rgba(43, 27, 18, 0.3);
    cursor: pointer;
}

.alimento-option:hover {
    background: rgba(255, 255, 255, 0.5);
}

.alimento-option input[type="radio"] {
    margin-right: 10px;
    width: 20px !important; /* Sobrescreve estilo global */
    height: 20px;
    accent-color: #5d4037;
    cursor: pointer;
}

.aviso-vazio {
    padding: 20px;
    text-align: center;
    color: #888;
    font-style: italic;
}

/* CSS PARA O BLOQUEIO */
html.locked body > *:not(#tela-senha) {
    display: none !important; /* Esconde tudo que n√£o for a tela de senha */
}

html.locked body {
    background: #1a1411;
    overflow: hidden;
}

#tela-senha {
    display: none; /* Escondido por padr√£o */
}

html.locked #tela-senha {
    display: flex !important; /* Aparece s√≥ quando bloqueado */
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #1a1411; z-index: 9999;
    justify-content: center; align-items: center; flex-direction: column;
}

:root {
    --ink: #2b1b12;
    --gold: #ffcc80;
}

* {
    box-sizing: border-box;
}

html {
    overflow-x: hidden;
}

body {
    margin: 0;
    padding: 0;
    padding-top: 60px; /* Espa√ßo para o menu fixo */
    background: #1a1411;
    font-family: 'Courier Prime', monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    overflow-x: hidden;
}

.painel-arma-equipada {
    margin-left: auto;
}

/* ===== TELA DE SENHA ===== */
.password-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #1a1411;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.password-screen.hidden {
    display: none;
}

.password-box {
    background: url("assets/paper-bg.jpg") no-repeat center;
    background-size: cover;
    padding: 40px;
    border: 4px solid #2b1b12;
    box-shadow: 0 0 60px rgba(0,0,0,0.9);
    text-align: center;
    max-width: 400px;
    width: 90%;
}

.password-box h2 {
    font-family: 'Rye';
    color: var(--ink);
    margin: 0 0 10px 0;
    font-size: 1.8rem;
}

.password-box .char-name {
    font-family: 'Rye';
    color: #8b6914;
    font-size: 1.4rem;
    margin-bottom: 25px;
}

.password-box input {
    width: 100%;
    padding: 15px;
    font-family: 'Courier Prime';
    font-size: 1.2rem;
    border: 2px solid var(--ink);
    background: rgba(255,250,240,0.9);
    color: var(--ink);
    border-radius: 8px;
    text-align: center;
    margin-bottom: 15px;
}

.password-box input:focus {
    outline: none;
    border-color: #8b6914;
}

.password-box button {
    width: 100%;
    padding: 15px 30px;
    font-family: 'Rye';
    font-size: 1.1rem;
    border: 2px solid #2b1b12;
    background: #5d4037;
    color: #e6dccf;
    cursor: pointer;
    border-radius: 8px;
    transition: background 0.2s;
}

.password-box button:hover {
    background: #6d5047;
}

.password-error {
    color: #8b0000;
    font-family: 'Courier Prime';
    font-size: 0.95rem;
    margin-top: 10px;
    display: none;
}

.password-error.show {
    display: block;
}

/* Esconde conte√∫do enquanto n√£o autenticado */
body.locked .western-nav,
body.locked .sheet,
body.locked .floating-buttons,
body.locked #status {
    display: none;
}

/* ===== MENU DE NAVEGA√á√ÉO ===== */
.western-nav {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 15px;
    background: #2b1b12;
    border-bottom: 2px solid #5d4037;
    width: 100%;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    flex-shrink: 0;
}

.western-nav a {
    color: #aaa;
    text-decoration: none;
    font-family: 'Rye', serif;
    font-size: 1rem;
    padding: 5px 10px;
    border: 1px solid transparent;
    transition: color 0.2s, border-color 0.2s;
    text-transform: uppercase;
}

.western-nav a:hover {
    color: var(--gold);
    border-color: var(--gold);
}

.western-nav a.active {
    color: var(--gold);
    border-bottom: 2px solid var(--gold);
}

/* ===== FICHA ===== */
.sheet {
    display: grid;
    grid-template-columns: 38% 62%;
    width: min(98%, 1600px);
    background: url("assets/paper-bg.jpg") no-repeat center;
    background-size: cover;
    padding: clamp(20px, 3vw, 40px);
    gap: clamp(15px, 2vw, 25px);
    box-shadow: 0 0 20px rgba(0,0,0,.6);
    min-height: min(85vh, 900px);
    contain: layout style paint;
    will-change: transform;
}

/* ===== ESQUERDA ===== */
.sheet-left {
    display: flex;
    flex-direction: column;
    gap: 20px;
    justify-content: flex-start;
    position: relative;
    overflow: visible;
}

.portrait-frame {
    background: url("assets/portrait-frame.png") no-repeat center;
    background-size: contain;
    padding: 5px;
    padding-left: 0px;
    width: 100%;
    max-width: 100%;
}

.portrait-frame img {
    width: 100%;
    display: block;
}

.name-banner {
    background: url("assets/name-banner.png") no-repeat center;
    background-size: 100% 100%;
    width: 100%;
    height: clamp(650px, 20vh, 200px);
    position: absolute;
    bottom: clamp(-150px, -15vw, -190px);
    left: 5%;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
}


.name-banner h1 {
    margin: 0;
    padding-bottom: 80px;
    font-family: 'Rye';
    letter-spacing: 3.5px;
    font-size: clamp(1.2rem, 3.5vw, 3.5rem);
}

/* Garante que o SVG ocupe o espa√ßo do banner */
.name-banner svg {
    width: 100%;
    height: 100%;
    overflow: visible;
}

/* Estilo do texto dentro do SVG */
.texto-curvado {
    font-family: 'Rye', serif;
    font-size: clamp(0.5rem, 2.5vw, 2.5rem);
    fill: #2b1b12;
    letter-spacing: 4px;
    text-transform: uppercase;
    font-weight: bold;
}

/* ===== DIREITA ===== */
.sheet-right {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: clamp(10px, 2vw, 25px);
    overflow: hidden;
    max-width: 100%;
}

.wanted-strip {
    text-align: center;
    font-family: 'Rye';
    letter-spacing: 3px;
    border-bottom: 2px solid var(--ink);
    padding-bottom: 10px;
    font-size: clamp(0.8rem, 1.5vw, 1.2rem);
     /* --- MUDAN√áAS AQUI --- */
    width: 85%;        /* Encurta a barra (100% seria total) */
    margin-left: auto; /* Empurra ela para a direita */
    /* --------------------- */
}

/* ===== ATRIBUTOS ===== */
.attributes {
    display: flex;
    gap: clamp(1px, 0.5vw, 8px);
    justify-content: flex-end;
    flex-wrap: nowrap;
    max-width: 100%;
    overflow: hidden;
}

.attribute-card {
    background: url("assets/wanted-card.png") no-repeat center;
    background-size: contain;
    width: clamp(40px, 9vw, 160px);
    aspect-ratio: 3 / 4;
    text-align: center;
    padding-top: 5%;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
}

.attribute-card:nth-child(1) {
    transform: rotate(-3deg);
}

.attribute-card:nth-child(2) {
    transform: rotate(2deg);
}

.attribute-card:nth-child(3) {
    transform: rotate(-2deg);
}

.attribute-card:nth-child(4) {
    transform: rotate(3deg);
}

.attribute-card label {
    display: block;
    font-family: 'Rye';
    font-size: clamp(1rem, 2vw, 1.6rem);
    margin-top: -50px;
}

.attribute-card input {
    width: 80%;
    border: none;
    background: transparent;
    font-size: clamp(1.9rem, 3.3vw, 3.4rem);
    font-family: 'Rye', serif;
    text-align: center;
    color: var(--ink);
    margin-left: 10%;
    margin-top: 30%;
}

/* ===== SE√á√ÉO VITAIS (VIDA E DOR) ===== */
.vitals-section {
    display: flex;
    flex-direction: column;
    gap: clamp(1px, 1.5vw, 15px);
    padding: 0px clamp(20px, 8vw, 130px);
    flex-shrink: 0;
}

.vital-row {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: clamp(8px, 1.5vw, 15px);
    flex-wrap: nowrap;
}

.vital-row label {
    font-family: 'Rye';
    font-size: clamp(1.6rem, 2vw, 2.0rem);
    color: var(--ink);
    text-transform: uppercase;
    white-space: nowrap;
    flex-shrink: 0;
}

.track {
    display: flex;
    gap: 6px;
    flex-wrap: nowrap;
    align-items: center;
    max-width: 350px;
}

.track img {
    width: 40px;
    min-width: 20px;
    flex: 1 1 auto;
    opacity: 0.2;
    cursor: pointer;
    transition: transform 0.1s, opacity 0.2s;
}

.track img:hover {
    transform: scale(1.2);
}

.track img.active {
    opacity: 1;
}

/* ===== BANNER DE A√á√ïES ===== */
.acoes-antecedentes-row {
    display: flex;
    gap: 20px;
    align-items: center;
}

.acoes-banner {
    background: url("assets/acoes.png") no-repeat center center;
    background-size: contain;
    width: 55%;
    height: clamp(150px, 20vh, 260px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5% 18% 5% 18%;
    flex-shrink: 0;
    margin-left: 6%;

}

.acoes-banner input {
    width: 60px;
    border: none;
    background: transparent;
    font-size: clamp(2.3rem, 3.9vw, 3.3rem);
    font-family: 'Rye', serif;
    text-align: center;
    color: var(--ink);
    pointer-events: none;
    -moz-appearance: textfield;
    appearance: textfield;
}

.acoes-banner input::-webkit-outer-spin-button,
.acoes-banner input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

#input-dinheiro {
    background: rgba(0, 0, 0, 0.1);
    border: none;
    border-bottom: 2px solid #2e7d32; /* Verde D√≥lar */
    border-radius: 0;
}
#input-dinheiro:focus {
    outline: none;
    background: rgba(46, 125, 50, 0.1);
}


/* ===== MODAL DE CONDI√á√ÉO ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal-condicao {
    background: url("assets/fundodor.png") no-repeat center;
    background-size: cover;
    padding: 40px 50px;
    border: 4px solid #2b1b12;
    box-shadow: 0 0 30px rgba(0,0,0,0.9);
    text-align: center;
    max-width: 500px;
    transform: scale(0.8);
    transition: transform 0.3s;
}

.modal-overlay.show .modal-condicao {
    transform: scale(1);
}

.modal-condicao h2 {
    font-family: 'Rye';
    color: #8b0000;
    margin: 0 0 10px 0;
    font-size: 2.2rem;
}

.modal-condicao .condicao-nome {
    font-family: 'Rye';
    color: var(--ink);
    font-size: 2rem;
    margin: 15px 0;
}

.modal-condicao .condicao-efeito {
    font-family: 'Courier Prime';
    color: var(--ink);
    font-size: 1.4rem;
    line-height: 1.5;
}

.modal-condicao button {
    margin-top: 20px;
    padding: 12px 35px;
    font-family: 'Rye';
    font-size: 1.3rem;
    border: none;
    background: #5d4037;
    color: #e6dccf;
    cursor: pointer;
}

.modal-condicao button:hover {
    background: #6d5047;
}

/* modal de tutorial */

.modal-tutor {
    background: url("assets/tutor.png") no-repeat center;
    background-size: cover;
    padding: 40px 50px;
    border: 4px solid #2b1b12;
    box-shadow: 0 0 30px rgba(0,0,0,0.9);
    text-align: center;
    max-width: 500px;
    transform: scale(0.8);
    transition: transform 0.3s;
}

.modal-overlay.show .modal-tutor {
    transform: scale(1);
}

.modal-tutor h2 {
    font-family: 'Rye';
    color: #8b0000;
    margin: 0 0 10px 0;
    font-size: 2.2rem;
}

.modal-tutor .condicao-nome {
    font-family: 'Rye';
    color: var(--ink);
    font-size: 2rem;
    margin: 15px 0;
}

.modal-tutor .condicao-efeito {
    font-family: 'Courier Prime';
    color: var(--ink);
    font-size: 1.4rem;
    line-height: 1.5;
}

.modal-tutor button {
    margin-top: 20px;
    padding: 12px 35px;
    font-family: 'Rye';
    font-size: 1.3rem;
    border: none;
    background: #5d4037;
    color: #e6dccf;
    cursor: pointer;
}

.modal-tutor button:hover {
    background: #6d5047;
}

/* ===== BOX DE ANOTA√á√ïES ===== */
.anotacoes-box {
    width: 88%;
    margin-top: -20px;
    margin-left: auto;
}

.anotacoes-box h4 {
    font-family: 'Rye';
    color: var(--ink);
    margin: 0 0 8px 0;
    font-size: clamp(1rem, 1.4vw, 1.3rem);
}

.anotacoes-box textarea {
    width: 100%;
    height: clamp(120px, 18vh, 200px);
    padding: 10px;
    font-family: 'Courier Prime', monospace;
    font-size: clamp(0.9rem, 1.2vw, 1.1rem);
    color: var(--ink);
    background: rgba(255, 250, 240, 1);
    border: 2px solid var(--ink);
    border-radius: 5px;
    resize: none;
}

.anotacoes-box textarea::placeholder {
    color: rgba(43, 27, 18, 1);
    font-style: italic;
}

.anotacoes-box textarea:focus {
    outline: none;
    border-color: #5d4037;
    background: rgba(255, 250, 240, 1);
}



/* ===== ANTECEDENTES ===== */
.antecedentes-section {
    flex: 1;
}

.antecedentes-section h3 {
    font-family: 'Rye';
    color: var(--ink);
    margin: 0 62px 10px 0;
    font-size: clamp(1.2rem, 1.8vw, 1.6rem);
    text-align: center;
}

.skills-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 5px;
    max-width: 400px;
    margin: 0;
    margin-right: auto;
    margin-left: -20px;
}

.skill-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.skill-item label {
    font-family: 'Rye';
    font-size: clamp(0.9rem, 1.4vw, 1.2rem);
    color: var(--ink);
    white-space: nowrap;
}

.skill-item input {
    width: 40px;
    border: none;
    background: transparent;
    font-size: clamp(1.2rem, 1.6vw, 1.5rem);
    font-family: 'Rye', serif;
    text-align: center;
    color: var(--ink);
}

.skill-item::after {
    content: '';
    display: inline-block;
    width: 25px;
    height: 25px;
    background: url('assets/halteres.png') no-repeat center;
    background-size: contain;
}

/* ===== STATUS INDICATOR ===== */
.status-indicator {
    position: fixed;
    bottom: 10px;
    right: 10px;
    color: #fff;
    opacity: 0.7;
    font-size: 0.8rem;
    transition: opacity 0.3s;
}

/* ===== BOT√ïES FLUTUANTES ===== */
.floating-buttons {
    position: fixed;
    bottom: 80px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 99;
}

.btn-float {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    border: 2px solid #5d4037;
    background: rgba(43, 27, 18, 0.95);
    color: #e6dccf;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    transition: transform 0.2s, background 0.2s, border-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-float:hover {
    transform: scale(1.1);
    background: #5d4037;
    border-color: var(--gold);
}

.btn-float.fed {
    background: #2d5a2d;
    border-color: #4a4;
}

/* ===== POPUP GEN√âRICO ===== */
.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

.popup-overlay.show {
    opacity: 1;
    visibility: visible;
}

.popup-content {
    background: url("assets/fundofome.jpg") no-repeat center;
    background-size: cover;
    padding: 30px;
    border: 4px solid #2b1b12;
    box-shadow: 0 0 40px rgba(0,0,0,0.9);
    max-width: 500px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    transform: scale(0.8);
    transition: transform 0.3s;
}

.popup-overlay.show .popup-content {
    transform: scale(1);
}

.popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid var(--ink);
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.popup-header h2 {
    font-family: 'Rye';
    color: var(--ink);
    margin: 0;
    font-size: 1.6rem;
}

.btn-close-popup {
    background: #8b0000;
    border: none;
    color: #fff;
    font-size: 1.4rem;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
}

.btn-close-popup:hover {
    background: #a00;
    transform: scale(1.1);
}

/* ===== POPUP RECURSOS ===== */
.recursos-section {
    text-align: center;
    margin-bottom: 25px;
}

.recursos-section h3 {
    font-family: 'Rye';
    color: var(--ink);
    font-size: 1.2rem;
    margin: 0 0 15px 0;
}

.recursos-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 15px;
}

.recursos-display input {
    width: 80px;
    padding: 10px;
    font-family: 'Rye';
    font-size: 2rem;
    text-align: center;
    border: 2px solid var(--ink);
    background: rgba(255,250,240,0.9);
    color: var(--ink);
    border-radius: 8px;
}

.recursos-display span {
    font-family: 'Courier Prime';
    font-size: 1.1rem;
    color: var(--ink);
}

.btn-alimentar {
    padding: 15px 30px;
    font-family: 'Rye';
    font-size: 1.1rem;
    border: 2px solid #2d5a2d;
    background: #3a7a3a;
    color: #fff;
    cursor: pointer;
    border-radius: 8px;
    transition: transform 0.2s, background 0.2s;
    margin-top: 10px;
}

.btn-alimentar:hover {
    background: #4a8a4a;
    transform: scale(1.05);
}

.btn-alimentar:disabled {
    background: #666;
    border-color: #444;
    cursor: not-allowed;
    opacity: 0.7;
}

.btn-alimentar:disabled:hover {
    transform: none;
}

.status-alimentado {
    font-family: 'Courier Prime';
    font-size: 1rem;
    margin-top: 10px;
    padding: 8px;
    border-radius: 5px;
}

.status-alimentado.sim {
    background: rgba(45, 90, 45, 0.3);
    color: #2d5a2d;
}

.status-alimentado.nao {
    background: rgba(139, 0, 0, 0.2);
    color: #8b0000;
}

/* ===== POPUP VESTIMENTAS ===== */
.vestimentas-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.vestimenta-item {
    background: rgba(255,250,240,0.9);
    border: 2px solid var(--ink);
    border-radius: 8px;
    padding: 12px;
}

.vestimenta-header {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 8px;
}

.vestimenta-header input {
    flex: 1;
    padding: 8px;
    font-family: 'Courier Prime';
    font-size: 1rem;
    border: 1px solid #5d4037;
    background: transparent;
    color: var(--ink);
    border-radius: 4px;
}

.vestimenta-header select {
    padding: 8px;
    font-family: 'Courier Prime';
    font-size: 0.9rem;
    border: 1px solid #5d4037;
    background: #fff;
    color: var(--ink);
    border-radius: 4px;
    cursor: pointer;
}

.vestimenta-desc {
    width: 100%;
    min-height: 40px;
    padding: 8px;
    font-family: 'Courier Prime';
    font-size: 0.9rem;
    border: 1px dashed rgba(43, 27, 18, 0.4);
    background: transparent;
    color: var(--ink);
    border-radius: 4px;
    resize: vertical;
}

/* Estados das vestimentas */
.vestimenta-item.estado-bom {
    border-left: 4px solid #4a4;
}

.vestimenta-item.estado-usado {
    border-left: 4px solid #cc0;
}

.vestimenta-item.estado-rasgado {
    border-left: 4px solid #f80;
}

.vestimenta-item.estado-destruido {
    border-left: 4px solid #a00;
    opacity: 0.7;
}

/* Background espec√≠fico do popup de vestimentas */
#popup-vestimentas .popup-content {
    background: url("assets/fundoroupa.jpg") no-repeat center;
    background-size: cover;
}

/* Background espec√≠fico do popup de reden√ß√£o */
#popup-redencao .popup-content {
    background: url("assets/fundorend.jpg") no-repeat center;
    background-size: cover;
    max-width: 600px;
}

/* ===== POPUP REDEN√á√ÉO ===== */
.redencao-tipo-selector {
    margin-bottom: 20px;
}

.redencao-tipo-selector label {
    font-family: 'Rye';
    color: var(--ink);
    font-size: 1.1rem;
    display: block;
    margin-bottom: 8px;
}

.redencao-tipo-selector select {
    width: 100%;
    padding: 12px;
    font-family: 'Rye';
    font-size: 1.1rem;
    border: 2px solid var(--ink);
    background: rgba(255,250,240,0.95);
    color: var(--ink);
    border-radius: 8px;
    cursor: pointer;
}

.redencao-descricao {
    background: rgba(43, 27, 18, 0.15);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid var(--ink);
}

.redencao-descricao p {
    font-family: 'Courier Prime';
    color: var(--ink);
    margin: 0;
    font-size: 0.95rem;
    font-style: italic;
    line-height: 1.5;
}

.redencao-passos {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.passo-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    background: rgba(255,250,240,0.9);
    padding: 12px 15px;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: border-color 0.2s;
    cursor: pointer;
}

.passo-item:hover {
    border-color: var(--ink);
}

.passo-item.completo {
    background: rgba(45, 90, 45, 0.2);
    border-color: #4a4;
}

.passo-item.completo .passo-texto {
    text-decoration: line-through;
    opacity: 0.7;
}

.passo-checkbox {
    width: 24px;
    height: 24px;
    min-width: 24px;
    border: 2px solid var(--ink);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    background: rgba(255,250,240,0.9);
    transition: background 0.2s, border-color 0.2s;
}

.passo-item.completo .passo-checkbox {
    background: #3a7a3a;
    border-color: #2d5a2d;
    color: #fff;
}

.passo-numero {
    font-family: 'Rye';
    color: var(--ink);
    font-size: 0.9rem;
    min-width: 60px;
}

.passo-texto {
    font-family: 'Courier Prime';
    color: var(--ink);
    font-size: 0.95rem;
    line-height: 1.4;
    flex: 1;
}

.redencao-progresso {
    margin-top: 20px;
    text-align: center;
    padding: 15px;
    background: rgba(43, 27, 18, 0.1);
    border-radius: 8px;
}

.redencao-progresso span {
    font-family: 'Rye';
    color: var(--ink);
    font-size: 1.2rem;
}

.progresso-bar {
    height: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    margin-top: 10px;
    overflow: hidden;
}

.progresso-fill {
    height: 100%;
    background: linear-gradient(90deg, #5d4037, #8b6914);
    border-radius: 6px;
    transition: width 0.3s;
}

/* Efeito visual de Exaust√£o/Fome */
body.status-faminto {
    box-shadow: inset 0 0 100px rgba(100, 0, 0, 0.4);
    filter: grayscale(0.8); /* Tira a cor da vida, deixa tudo cinza */
}

/* Estado de Fome: Borda vermelha pulsante e tela levemente cinza */
body.faminto {
    box-shadow: inset 0 0 80px rgba(139, 0, 0, 0.5);
    filter: sepia(0.2);
}

/* Indicador de Limite de Dor */
.dor-limit-indicator {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #000;
    border: 4px solid #d32f2f;
    color: #ff5555;
    padding: 20px;
    font-family: 'Rye';
    font-size: 1.5rem;
    z-index: 9999;
    text-align: center;
    display: none;
    box-shadow: 0 0 50px rgba(0,0,0,0.9);
}

#aviso-fome {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    border: 4px solid #8b0000;
    color: #ff5555;
    padding: 20px;
    font-family: 'Rye';
    font-size: 2rem;
    z-index: 9999;
    text-align: center;
}

/* ESTILO DA BARRA DE N√çVEL */
/* ESTILO DA BARRA DE N√çVEL (ATUALIZADO) */
.level-strip {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(43, 27, 18, 0.1);
    border: 2px solid var(--ink);
    padding: 5px 15px;
    border-radius: 4px;
    font-family: 'Rye';
    color: var(--ink);
    margin-bottom: -10px;
    
    /* --- MUDAN√áAS AQUI --- */
    width: 85%;        /* Encurta a barra (100% seria total) */
    margin-left: auto; /* Empurra ela para a direita */
    /* --------------------- */
}

.xp-bar-container {
    flex-grow: 1;
    margin: 0 15px;
    background: rgba(0,0,0,0.2);
    height: 10px;
    border-radius: 5px;
    position: relative;
    overflow: hidden;
}

.xp-bar-fill {
    background: var(--ink);
    height: 100%;
    width: 0%;
    transition: width 0.5s ease-in-out;
}


/* ===== ESTILO PREMIUM DA CARTEIRA ===== */

/* Container do Valor Principal */
.wallet-display-container {
    background: rgba(20, 10, 5, 0.6);
    border: 3px double #ffcc80; /* Borda dupla dourada */
    border-radius: 12px;
    padding: 20px;
    margin: 20px auto;
    width: 80%;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

#input-dinheiro {
    background: transparent !important;
    border: none !important;
    color: #ffcc80 !important; /* Texto Dourado */
    font-family: 'Rye', serif !important;
    font-size: 3.5rem !important;
    text-align: center;
    text-shadow: 2px 2px 0px #000, 0 0 10px rgba(255, 204, 128, 0.3);
    width: 180px !important;
    border-bottom: 2px dashed rgba(255, 204, 128, 0.3) !important;
}

#input-dinheiro:focus {
    outline: none;
    border-bottom: 2px solid #ffcc80 !important;
}

/* √Årea dos Bot√µes (Moedas/Fichas) */
.wallet-actions {
    display: flex;
    justify-content: space-around;
    align-items: flex-start;
    margin-top: 20px;
    gap: 20px;
}

.wallet-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    background: rgba(255, 250, 240, 0.05);
    padding: 15px;
    border-radius: 10px;
    border: 1px solid rgba(93, 64, 55, 0.3);
    width: 45%;
}

.wallet-group h4 {
    font-family: 'Rye';
    color: #e6dccf;
    margin: 0 0 10px 0;
    font-size: 1rem;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Estilo das "Moedas" (Bot√µes) */
.coin-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    font-family: 'Rye';
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 0 rgba(0,0,0,0.5), 0 5px 10px rgba(0,0,0,0.3);
    position: relative;
    border: 2px dashed rgba(0,0,0,0.3);
}

.coin-btn:active {
    transform: translateY(4px);
    box-shadow: 0 0 0 rgba(0,0,0,0.5);
}

.coin-btn:hover {
    filter: brightness(1.2);
    transform: scale(1.05) translateY(-2px);
}

/* Moedas de Ganho (Douradas/Verdes) */
.coin-gain {
    background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
    color: #2b1b12;
    border-color: #8b6508;
    text-shadow: 0 1px 0 rgba(255,255,255,0.4);
}

/* Moedas de Gasto (Cobre/Vermelhas) */
.coin-loss {
    background: radial-gradient(circle at 30% 30%, #e57373, #b71c1c);
    color: #fff;
    border-color: #7f0000;
    text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
}

.coin-value {
    pointer-events: none;
}

/* Responsividade para carteira */
@media (max-width: 480px) {
    .wallet-actions {
        flex-direction: column;
        align-items: center;
    }
    .wallet-group {
        width: 100%;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
    }
    .wallet-group h4 {
        width: 100%;
    }
}

/* =========================================
   TELAS GRANDES (1920x1080 e similares)
   ========================================= */
@media (min-width: 1025px) {
    .sheet {
        width: min(95%, 1400px); /* Limita largura m√°xima */
    }
    
    .sheet-left {
        overflow: visible;
    }
    
    .portrait-frame {
        width: 100%; /* Mant√©m dentro do container */
        max-width: 100%;
    }
    
    .name-banner {
        width: 100%;
        left: 0%;
        bottom: -150px;
    }
    
    .vitals-section {
        padding: 0px clamp(20px, 5vw, 80px); /* Padding responsivo */
    }
    
    .acoes-banner {
        width: clamp(45%, 50vw, 55%);
        margin-left: 3%;
    }
    
    .attributes {
        gap: clamp(8px, 2vw, 25px); /* Gap menor para caber na tela */
        justify-content: flex-end;
        flex-wrap: nowrap; /* Impede quebra de linha */
    }
    
    .attribute-card {
        width: clamp(90px, 8vw, 150px); /* Tamanho menor para caber */
        flex-shrink: 0;
    }

    .attribute-card input {
        margin-top: 20%; /* Subir o input */
    }
}

/* Telas muito grandes (1920px+) */
@media (min-width: 1920px) {
    .sheet {
        width: min(90%, 1500px);
    }
    
    .attributes {
        gap: 20px;
    }
    
    .attribute-card {
        width: 140px; /* Tamanho fixo para telas grandes */
    }
    
    .attribute-card label {
        font-size: 1.3rem;
    }
    
    .attribute-card input {
        font-size: 2.8rem;
    }
}

/* =========================================
   RESPONSIVIDADE MOBILE
   ========================================= */

/* Tablets e telas m√©dias */
@media (max-width: 1024px) {
    .sheet {
        width: 98%;
        grid-template-columns: 35% 65%;
        background: url("assets/fundomob.jpg") no-repeat center;
        background-size: cover;
    }
    
    .acoes-banner {
        width: 50%;
    }

    /* --- ADICIONE ISTO AQUI PARA CONSERTAR AS BARRAS --- */
    .wanted-strip, 
    .level-strip {
        width: 100% !important;   /* Ocupa a largura toda */
        margin-left: 0 !important; /* Remove o recuo para a direita */
        margin-bottom: 10px;       /* Mant√©m um espa√ßamento embaixo */
    }

    

}

/* Celulares */
@media (max-width: 768px) {
    
    /* Evita scroll interno que trava */
    .lista-alimentos-container {
        max-height: 150px;
    }
    
    /* Layout geral - coluna √∫nica */
    .sheet {
        display: flex;
        flex-direction: column;
        width: 100%;
        padding: 15px;
        min-height: auto;
        max-height: none;
        gap: 20px;
        background: url("assets/fundomob.jpg") no-repeat center;
        background-size: cover;
        overflow: visible;
    }

    /* Se√ß√£o esquerda (foto e nome) */
    .sheet-left {
        width: 100%;
        align-items: center;
    }

    .portrait-frame {
        width: 80%;
        max-width: 300px;
        margin: 0 auto;
    }

    .name-banner {
        position: relative;
        bottom: auto;
        left: auto;
        width: 95%;
        height: 600px;
        margin-top: -400px;
    }
    
    .texto-curvado {
        font-size: 32px;
    }

    /* Se√ß√£o direita */
    .sheet-right {
        width: 100%;
    }

    .wanted-strip {
        font-size: 1rem;
        text-align: center;
    }

   /* Atributos (cartas) - MODO GRID 2x2 */
/* Atributos (cartas) - MODO LINHA √öNICA */
    .attributes {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* For√ßa 4 colunas */
        gap: 5px;  /* Gap MUITO pequeno para caber no celular */
        width: 100%;
        padding: 0 5px; /* Margem de seguran√ßa nas bordas */
    }

    .attribute-card {
        width: 100% !important;
        transform: none !important;
    }
    
    .attribute-card label {
        font-size: 1.1rem;
        margin-top: -20px;
    }
    
/* O AJUSTE DOS N√öMEROS */
    .attribute-card input {
        width: 100%;
        text-align: center;
        border: none;
        background: transparent;
        margin: 0; 
        
        /* TRUQUE 1: Tamanho da fonte baseado na largura da tela (vw) */
        /* Isso garante que o n√∫mero sempre caiba na caixa de 1/4 da tela */
        font-size: 6vw !important; 
        
        /* TRUQUE 2: Empurrar para baixo para alinhar no centro do background */
        /* Ajuste este padding-top at√© o n√∫mero cair na posi√ß√£o exata */
        padding-top: 60px;
        
        height: auto;
        line-height: 1; /* Remove espa√ßamento extra de linha */
    }

    /* Vida e Dor */
    .vitals-section {
        padding: 0 10px;
    }

    .vital-row {
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .vital-row label {
        font-size: 1.1rem;
        text-align: center;
    }

    .track {
        justify-content: center;
        max-width: 100%;
    }

    .track img {
        width: 30px;
        min-width: 22px;
    }

    /* A√ß√µes e Antecedentes */
    .acoes-antecedentes-row {
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }

    .acoes-banner {
        width: 95%;
        max-width: 350px;
        height: 160px;
        margin-left: 0;
        padding: 6% 14%;
    }
    
    .acoes-banner input {
        font-size: 2.2rem;
    }

    .antecedentes-section {
        width: 100%;
    }

    .antecedentes-section h3 {
        margin: 0 0 10px 0;
        text-align: center;
    }

    .skills-grid {
        max-width: 100%;
        margin: 0 auto;
        gap: 10px 15px;
    }

    .skill-item {
        justify-content: center;
    }

    .skill-item label {
        font-size: 0.85rem;
    }

    .skill-item input {
        width: 35px;
        font-size: 1.1rem;
    }

    .skill-item::after {
        width: 20px;
        height: 20px;
    }

    /* Anota√ß√µes */
    .anotacoes-box {
        width: 100%;
        margin: 0;
    }

    .anotacoes-box textarea {
        height: 100px;
    }

    /* Menu de Navega√ß√£o */
    .western-nav {
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
    }
    
    .western-nav a {
        font-size: 0.85rem;
        padding: 5px 8px;
    }
    
    /* Modal */
    .modal-condicao {
        max-width: 90%;
        padding: 25px 20px;
    }
    
    .modal-condicao h2 {
        font-size: 1.6rem;
    }
    
    .modal-condicao .condicao-nome {
        font-size: 1.4rem;
    }
    
    .modal-condicao .condicao-efeito {
        font-size: 1.1rem;
    }
}

/* Celulares pequenos */
@media (max-width: 480px) {
    .sheet {
        padding: 10px;
    }

    .portrait-frame {
        width: 90%;
    }

    
    .attribute-card label {
        font-size: 0.95rem;
    }
    
    .attribute-card input {
        font-size: 1.8rem;
    }

    .track img {
        width: 25px;
        min-width: 18px;
    }

    .skills-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .western-nav a {
        font-size: 0.85rem;
        padding: 5px 8px;
    }
    
    /* Popups responsivos */
    .floating-buttons {
        bottom: 60px;
        right: 10px;
    }
    
    .btn-float {
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
    }
    
    .popup-content {
        padding: 20px;
        max-height: 80vh;
    }
    
    .popup-header h2 {
        font-size: 1.3rem;
    }
    
    .recursos-display input {
        width: 60px;
        font-size: 1.5rem;
    }
    
    .vestimenta-header {
        flex-direction: column;
    }
    
    .vestimenta-header select {
        width: 100%;
    }
}

/* Estilo Especial para Reden√ß√£o Completa */
.modal-redencao-full {
    background: url("assets/redenconc.jpg") center/cover !important; /* Fundo de papel */
    border: 4px solid #ffcc80 !important; /* Borda Dourada */
    box-shadow: 0 0 50px rgba(255, 204, 128, 0.5) !important;
}
.modal-redencao-full h2 { color: #8b6914 !important; text-shadow: 1px 1px 0 #fff; }
.modal-redencao-full .condicao-efeito { color: #2b1b12 !important; font-weight: bold; white-space: pre-line; }

</style>
</head>

<body>


<div id="tela-senha">
    <div style="background:url('assets/locked.jpg') center center/contain no-repeat, #1a1411; padding:40px; border:5px solid #2b1b12; text-align:center; max-width:400px; border-radius:8px;">
        <h2 style="font-family:'Rye'; margin-top:0;">üîí ACESSO RESTRITO</h2>
        <p style="font-family:'Courier Prime';">Ficha de <b id="nome-lock">Personagem</b></p>
        
        <input type="password" id="pass-input" placeholder="Senha..." 
               style="padding:10px; font-size:1.2rem; text-align:center; width:100%; margin-bottom:15px; font-family:'Courier Prime';"
               onkeypress="if(event.key==='Enter') tentarDesbloquear()">
        
        <button onclick="tentarDesbloquear()" 
                style="padding:10px 30px; font-family:'Rye'; cursor:pointer; background:#5d4037; color:#fff; border:none; font-size:1.1rem;">
            ABRIR FICHA
        </button>
        
        <p id="pass-error" style="color:red; display:none; margin-top:10px;">Senha Incorreta!</p>
    </div>
    <script>
        // Atualiza o nome na tela de bloqueio
        document.getElementById('nome-lock').innerText = NOME_PERSONAGEM || 'Desconhecido';
    </script>
</div>

<div id="aviso-fragil" class="dor-limit-indicator">
    üíÄ FOME üíÄ<br>
    <span style="font-size:1rem; font-family:'Courier Prime'; color:#ccc;">
        Seu limite de Dor caiu para 3.
    </span>
</div>

<nav class="western-nav">
    <a href="index.html" class="active">Ficha</a>
    <a href="habilidades.html">Habilidades</a>
    <a href="montaria.html">Montaria</a>
    <a href="inventario.html">Invent√°rio</a>
    <a href="bando.html">Bando</a>
</nav>

<div class="sheet" id="ficha-container">

    <div class="sheet-left">
        <div class="portrait-frame">
            <img id="char-photo" src="assets/portrait.png" alt="Personagem" onerror="this.src='assets/portrait.png'">
        </div>

        <div class="name-banner">
            <svg viewBox="0 0 400 120">
                <path id="curve" d="M40,83 Q200,44 360,68" fill="transparent"/>
                <text width="400">
                    <textPath id="nome-personagem-texto" xlink:href="#curve" startOffset="50%" text-anchor="middle" class="texto-curvado">
                        Carregando...
                    </textPath>
                </text>
            </svg>
        </div>
    </div>

    <div class="sheet-right">

        <div class="wanted-strip">WANTED ‚Äî DEAD OR ALIVE</div>

        <div class="level-strip">
            <span id="level-display">N√çVEL 1</span>
            
            <div class="xp-bar-container">
                <div class="xp-bar-fill" id="xp-fill"></div>
            </div>
            
            <span id="xp-text" style="font-size: 0.9rem;">0 / 10 XP</span>
        </div>

        <div class="attributes">
            <div class="attribute-card">
                <label>FOR</label>
                <input id="forca" type="number" min="0" max="4">
            </div>
            <div class="attribute-card">
                <label>VEL</label>
                <input id="vel" type="number" min="0" max="4">
            </div>
            <div class="attribute-card">
                <label>INT</label>
                <input id="int" type="number" min="0" max="4">
            </div>
            <div class="attribute-card">
                <label>COR</label>
                <input id="cor" type="number" min="0" max="4">
            </div>
        </div>

        <div class="vitals-section">
            <div class="vital-row">
                <label>Pontos de Vida:</label>
                <div class="track vida-track">
                    <!-- Gerado dinamicamente pelo JS -->
                </div>
            </div>

            <div class="vital-row">
                <label>Pontos de Dor:</label>
                <div class="track dor-track">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                    <img src="assets/fist.png" onerror="this.src='assets/skull.png'">
                </div>
            </div>
        </div>
        
        <div class="acoes-antecedentes-row">
            <div class="acoes-banner">
                <input id="movimento" type="number" min="0" value="2" readonly>
                <input id="combate" type="number" min="0" value="1" readonly>
            </div>


            
            <div class="antecedentes-section">
                <h3>ANTECEDENTES:</h3>
                <div class="skills-grid">
                    <div class="skill-item">
                        <label>ATEN√á√ÉO:</label>
                        <input type="number" id="atencao" value="0">
                    </div>
                    <div class="skill-item">
                        <label>MEDICINA:</label>
                        <input type="number" id="medicina" value="0">
                    </div>
                    <div class="skill-item">
                        <label>MONTARIA:</label>
                        <input type="number" id="montaria" value="0">
                    </div>
                    <div class="skill-item">
                        <label>NEG√ìCIOS:</label>
                        <input type="number" id="negocios" value="0">
                    </div>

                    <div class="skill-item">
                        <label>ROUBO:</label>
                        <input type="number" id="roubo" value="0">
                    </div>
                    <div class="skill-item">
                        <label>SUOR:</label>
                        <input type="number" id="suor" value="0">
                    </div>
                    <div class="skill-item">
                        <label>TRADI√á√ÉO:</label>
                        <input type="number" id="tradicao" value="0">
                    </div>
                    <div class="skill-item">
                        <label>VIOL√äNCIA:</label>
                        <input type="number" id="violencia" value="0">
                    </div>
                </div>
            </div>
        </div>

        <div id="painel-armas" style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
            </div>

        <div class="anotacoes-box">
            <h4>ANOTA√á√ïES:</h4>
            <textarea id="anotacoes" placeholder="Escreva suas anota√ß√µes aqui..."></textarea>
        </div>

    </div>
</div>

<!-- Modal de Condi√ß√£o -->
<div class="modal-overlay" id="modal-condicao">
    <div class="modal-condicao">
        <h2>‚ö† ATEN√á√ÉO! ‚ö†</h2>
        <div class="condicao-nome" id="condicao-nome"></div>
        <div class="condicao-efeito" id="condicao-efeito"></div>
        <button onclick="fecharModal()">Entendido</button>
    </div>
</div>

<div class="modal-overlay" id="modal-levelup">
    <div class="modal-condicao" style="border: 4px solid #ffd700; background: url('assets/redenconc.jpg') center/cover; box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);">
        <h2 style="color: #b8860b; font-size: 2.2rem; text-shadow: 1px 1px 0 #000;">üåü SUBIU DE N√çVEL! üåü</h2>
        
        <div style="font-family: 'Rye'; font-size: 1.8rem; color: #2b1b12; margin: 10px 0;">
            Agora voc√™ √© N√≠vel <span id="lvl-novo-numero" style="font-size:2.5rem; color:#b8860b;">2</span>
        </div>

        <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="font-family:'Rye'; margin-top:0; color:#2b1b12;">RECOMPENSAS:</p>
            <div id="lvl-recompensas" style="font-family:'Courier Prime'; font-size: 1.2rem; color: #2b1b12; white-space: pre-line; font-weight:bold; line-height: 1.6;">
                </div>
        </div>

        <button onclick="fecharLevelUp()" style="background: #b8860b; color: #fff; border: 2px solid #8b6508; width: 100%;">
            REIVINDICAR
        </button>
    </div>
</div>


<div class="modal-overlay" id="modal-morte">
    <div class="modal-condicao" style="background: #000; border: 4px solid #8b0000;">
        <h2 style="color: #ff0000; font-size: 2.2rem; text-shadow: 0 0 10px #8b0000;">üíÄ MORTE! üíÄ</h2>
        
        <div class="condicao-efeito" style="color: #ccc; font-size: 1.3rem; margin: 20px 0;">
            Voc√™ marcou sua √∫ltima caveira.<br>
            <b style="color:#fff;">Role um teste de vida no Discord!</b>
        </div>

        <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
            <button onclick="morteFalha()" style="background: #b71c1c; border: 2px solid #ff0000; color: #fff;">
                FALHA ‚úù
            </button>
            <button onclick="morteSucesso()" style="background: #2e7d32; border: 2px solid #4caf50; color: #fff;">
                SUCESSO ‚ù§
            </button>
        </div>
    </div>
</div>

<!-- Bot√µes Flutuantes -->
<div class="floating-buttons">
    <button class="btn-float" id="btn-recursos" onclick="abrirPopupRecursos()" title="Recursos / Alimenta√ß√£o">
        üçñ
    </button>
    <button class="btn-float" id="btn-vestimentas" onclick="abrirPopupVestimentas()" title="Vestimentas">
        üëî
    </button>
    <button class="btn-float" id="btn-redencao" onclick="abrirPopupRedencao()" title="Reden√ß√£o">
        ‚õ™
    </button>

    <button class="btn-float" id="btn-carteira" onclick="abrirPopupCarteira()" title="Carteira">
        üí∞
    </button>

</div>

<!-- Popup de Recursos/Alimenta√ß√£o -->
<div class="popup-overlay" id="popup-recursos">
    <div class="popup-content">
        <div class="popup-header">
            <h2>üçñ SUPRIMENTOS</h2>
            <button class="btn-close-popup" onclick="fecharPopupRecursos()">‚úï</button>
        </div>
        
        <div class="recursos-section">
            <h3 style="font-size: 1rem; margin-bottom: 5px;">ESCOLHA O QUE COMER:</h3>
            
            <div id="lista-alimentos" class="lista-alimentos-container">
                </div>
            
            <button class="btn-alimentar" id="btn-alimentar" onclick="seAlimentar()">
                üç¥ Comer Item Selecionado
            </button>
            
            <div class="status-alimentado" id="status-alimentado">
                </div>
        </div>
    </div>
</div>

<!-- Popup de Vestimentas -->
<div class="popup-overlay" id="popup-vestimentas">
    <div class="popup-content">
        <div class="popup-header">
            <h2>üëî VESTIMENTAS</h2>
            <button class="btn-close-popup" onclick="fecharPopupVestimentas()">‚úï</button>
        </div>
        
        <div class="vestimentas-list" id="vestimentas-list">
            <!-- Gerado via JS -->
        </div>
    </div>
</div>

<!-- Popup de Reden√ß√£o -->
<div class="popup-overlay" id="popup-redencao">
    <div class="popup-content">
        <div class="popup-header">
            <h2>‚õ™ REDEN√á√ÉO</h2>
            <button class="btn-close-popup" onclick="fecharPopupRedencao()">‚úï</button>
        </div>
        
        <div class="redencao-tipo-selector">
            <label>Tipo de Reden√ß√£o:</label>
            <select id="redencao-tipo" onchange="mudarTipoRedencao()">
                <option value="vinganca">Vingan√ßa</option>
                <option value="fuga">Fuga</option>
                <option value="divida">D√≠vida</option>
                <option value="remorso">Remorso</option>
                <option value="recomeco">Recome√ßo</option>
                <option value="ambicao">Ambi√ß√£o</option>
                <option value="culpa">Culpa</option>
            </select>
        </div>
        
        <div class="redencao-descricao" id="redencao-descricao">
            <p><!-- Preenchido via JS --></p>
        </div>
        
        <div class="redencao-passos" id="redencao-passos">
            <!-- Gerado via JS -->
        </div>
        
        <div class="redencao-progresso">
            <span id="progresso-texto">0 / 6 passos</span>
            <div class="progresso-bar">
                <div class="progresso-fill" id="progresso-fill" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>


<div class="popup-overlay" id="popup-carteira">
    <div class="popup-content" style="background: linear-gradient(rgba(20, 10, 5, 0.9), rgba(20, 10, 5, 0.9)), url('assets/fundocarteira.png') center/cover; border-color: #8b6914;">
        
        <div class="popup-header" style="border-bottom-color: #8b6914;">
            <h2 style="color: #ffcc80; text-shadow: 2px 2px 0 #000;">üí∞ CARTEIRA</h2>
            <button class="btn-close-popup" onclick="fecharPopupCarteira()">‚úï</button>
        </div>
        
        <div class="recursos-section">
            
            <div class="wallet-display-container">
                <span style="font-size: 3rem; font-family: 'Rye'; color: #b8860b; text-shadow: 1px 1px 0 #000;">$</span>
                <input type="number" id="input-dinheiro" 
                    value="0" 
                    oninput="interacaoManualDinheiro(this.value)"
                    placeholder="0">
            </div>

            <div style="font-family: 'Courier Prime'; color: #ccc; font-size: 0.9rem; margin-bottom: 20px; font-style: italic;">
                "O dinheiro fala, a p√≥lvora sussurra."
            </div>

            <div class="wallet-actions">
                
                <div class="wallet-group">
                    <h4>LUCRO</h4>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="somarDinheiro(1)" class="coin-btn coin-gain" title="Ganhar $1">
                            +$1
                        </button>
                        <button onclick="somarDinheiro(10)" class="coin-btn coin-gain" title="Ganhar $10">
                            +$10
                        </button>
                        <button onclick="somarDinheiro(50)" class="coin-btn coin-gain" title="Ganhar $50">
                            +$50
                        </button>
                    </div>
                </div>

                <div class="wallet-group">
                    <h4>DESPESA</h4>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="somarDinheiro(-1)" class="coin-btn coin-loss" title="Gastar $1">
                            -$1
                        </button>
                        <button onclick="somarDinheiro(-10)" class="coin-btn coin-loss" title="Gastar $10">
                            -$10
                        </button>
                        <button onclick="somarDinheiro(-50)" class="coin-btn coin-loss" title="Gastar $50">
                            -$50
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>



<div class="modal-overlay" id="modal-tutorial">
    <div class="modal-tutor" style="max-width: 550px;">
        <h2 id="tut-titulo" style="color:var(--ink); margin-bottom:15px;">BEM-VINDO AO OESTE</h2>
        
        <div id="tut-conteudo" style="font-family:'Courier Prime'; font-size:1.1rem; text-align:left; min-height:120px; line-height:1.4;">
            </div>

        <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #5d4037; padding-top:15px;">
            <button onclick="pularTutorial()" style="background:transparent; border:none; color:#5d4037; font-family:'Courier Prime'; font-size:0.9rem; text-decoration:underline; padding:0;">
                Pular Tutorial
            </button>
            
            <div style="font-family:'Rye'; color:#888; font-size:0.9rem;">
                <span id="tut-passo">1</span>/3
            </div>

            <button id="btn-prox-tut" onclick="proximoPasso()" style="margin-top:0; padding:8px 20px; font-size:1rem;">
                Pr√≥ximo ‚ûî
            </button>
        </div>
    </div>
</div>



<div id="status" class="status-indicator"></div>

<script>
// Vari√°veis Globais
let dadosLocais = { vida: 0, dor: 0, xp: 0 };
let inventarioGlobal = { items: [], weapons: [], municao: {} };
let itemAlimentoSelecionadoIndex = null; // Para saber qual √≠ndice apagar
let dinheiroAtual = 0;
let timeoutDinheiro = null;
let atributosCache = null; // Cache dos atributos para b√¥nus de habilidades

const TABELA_NIVEL = [
    { nivel: 1, xp: 0 },
    { nivel: 2, xp: 10 },
    { nivel: 3, xp: 20 },
    { nivel: 4, xp: 30 },
    { nivel: 5, xp: 45 },
    { nivel: 6, xp: 65 }
];

// TABELA DE RECOMPENSAS POR N√çVEL
const RECOMPENSAS_NIVEL = {
    2: "‚Ä¢ +1 Vida para cada ponto em F√≠sico (min. 1)\n‚Ä¢ +1 Ponto de Antecedente\n‚Ä¢ +1 Habilidade",
    3: "‚Ä¢ +1 Ponto de Atributo\n‚Ä¢ +1 Habilidade",
    4: "‚Ä¢ +1 Vida para cada ponto em F√≠sico (min. 1)\n‚Ä¢ +1 Ponto de Atributo\n‚Ä¢ +1 Habilidade",
    5: "‚Ä¢ +1 Vida para cada ponto em F√≠sico (min. 1)\n‚Ä¢ +1 Ponto de Atributo",
    6: "‚Ä¢ +3 Vida\n‚Ä¢ +1 Ponto de Atributo\n‚Ä¢ +1 Habilidade"
};

// Vari√°vel para evitar popup assim que abre a ficha
let primeiraCarga = true;

const CONDICOES = [
    { nome: 'Atordoamento', efeito: '-1 A√ß√£o de Combate na pr√≥xima rodada.' },
    { nome: 'Queda', efeito: 'Gaste um Movimento para se levantar.' },
    { nome: 'Distra√ß√£o', efeito: 'N√£o pode atacar esse mesmo alvo no pr√≥ximo ataque.' },
    { nome: 'Sangramento', efeito: '1 de dano adicional por turno at√© o fim do combate.' },
    { nome: 'Intimida√ß√£o', efeito: '√â preciso se afastar do atacante na pr√≥xima rodada.' },
    { nome: 'Desorienta√ß√£o', efeito: '-1 em Testes de Viol√™ncia no pr√≥ximo turno.' }
];

// Helper para pegar valor de ID
const val = (id) => {
    const el = document.getElementById(id);
    return el ? (parseInt(el.value) || 0) : 0;
};

// 1. GERA√á√ÉO DE VIDA E A√á√ïES
// Substitua a fun√ß√£o antiga por esta vers√£o turbinada
function gerarCaveirasVida() {
    const forca = val('forca');
    const xp = dadosLocais.xp || 0;
    
    // Calcula o n√≠vel atual baseado no XP
    const nivel = calcularNivel(xp);

    // 1. Vida Base (N√≠vel 1)
    let totalVida = 6 + forca;

    // 2. B√¥nus de N√≠vel (Acumulativo conforme a tabela)
    // A regra diz: +1 para cada ponto em F√≠sico (m√≠nimo 1)
    const bonusPorFisico = Math.max(1, forca); 

    if (nivel >= 2) totalVida += bonusPorFisico; // Ganha no N√≠vel 2
    if (nivel >= 4) totalVida += bonusPorFisico; // Ganha no N√≠vel 4
    if (nivel >= 5) totalVida += bonusPorFisico; // Ganha no N√≠vel 5
    if (nivel >= 6) totalVida += 3;              // Ganha +3 fixo no N√≠vel 6
    
    // 3. B√¥nus de Habilidades (ex: Parrudeza d√° +2üíÄ)
    if (atributosCache && atributosCache.bonusVidaHabilidades) {
        totalVida += atributosCache.bonusVidaHabilidades;
    }

    // 3. Renderiza√ß√£o das Caveiras
    const vidaTrack = document.querySelector('.vida-track');
    vidaTrack.innerHTML = ''; 
    
    for (let i = 0; i < totalVida; i++) {
        const img = document.createElement('img');
        img.src = 'assets/skull.png';
        
        img.onclick = () => {
            const novoValor = i + 1;
            // Se clicar na mesma, zera (ou desmarca)
            dadosLocais.vida = (dadosLocais.vida === novoValor) ? 0 : novoValor;
            
            atualizarVisual();
            salvarFicha();

            // Check de Morte
            if (dadosLocais.vida >= totalVida) {
                document.getElementById('modal-morte').classList.add('show');
            }
        };
        vidaTrack.appendChild(img);
    }

    // 4. Seguran√ßa ao "Descer de N√≠vel"
    // Se o jogador tinha 10 de dano e desceu de n√≠vel (agora max √© 8),
    // reduzimos o dano atual para 8 para n√£o bugar o visual.
    if (dadosLocais.vida > totalVida) {
        dadosLocais.vida = totalVida;
        salvarFicha(); // Salva a corre√ß√£o silenciosamente
    }
    
    atualizarVisual();
}

function atualizarAcoes() {
    const vel = val('vel');
    const cor = val('cor');
    document.getElementById('movimento').value = 1 + vel;
    document.getElementById('combate').value = 1 + cor;
}

function atualizarXPVisual() {
    const xpAtual = dadosLocais.xp || 0;
    let nivelAtual = 1;
    let proxNivelXP = 10;
    let xpBaseNivel = 0;

    // Calcula em que n√≠vel o personagem est√°
    for (let i = 0; i < TABELA_NIVEL.length; i++) {
        if (xpAtual >= TABELA_NIVEL[i].xp) {
            nivelAtual = TABELA_NIVEL[i].nivel;
            xpBaseNivel = TABELA_NIVEL[i].xp;
            
            // Define o pr√≥ximo alvo (se houver)
            if (i < TABELA_NIVEL.length - 1) {
                proxNivelXP = TABELA_NIVEL[i+1].xp;
            } else {
                proxNivelXP = xpAtual; // N√≠vel m√°ximo atingido
            }
        }
    }

    // Calcula a porcentagem da barra (apenas o progresso do n√≠vel atual)
    const range = proxNivelXP - xpBaseNivel;
    const progresso = xpAtual - xpBaseNivel;
    // Evita divis√£o por zero no n√≠vel m√°ximo
    const pct = range > 0 ? (progresso / range) * 100 : 100;

    // Atualiza o HTML
    document.getElementById('level-display').innerText = `N√çVEL ${nivelAtual}`;
    document.getElementById('xp-text').innerText = `${xpAtual} / ${proxNivelXP} XP`;
    document.getElementById('xp-fill').style.width = `${pct}%`;
}

function atualizarVisual() {
    document.querySelectorAll('.vida-track img').forEach((s, i) => {
        s.classList.toggle('active', i < dadosLocais.vida);
    });
    document.querySelectorAll('.dor-track img').forEach((f, i) => {
        f.classList.toggle('active', i < dadosLocais.dor);
    });

    atualizarXPVisual();
}

// 2. FUN√á√ïES DE SUPABASE

// BUSCAR DADOS
async function buscarDados() {
    const { data, error } = await client
        .from('Fichas')
        .select('*')
        .eq('nome_personagem', NOME_PERSONAGEM)
        .single();

    if (data) preencherTela(data.atributos);
    else if (error) console.error(error);
}

// PREENCHER TELA (ATUALIZADA)
function preencherTela(attr) {
    if (!attr) return;
    
    // Salva os atributos no cache global para uso em gerarCaveirasVida
    atributosCache = attr;

    // === NOVO: CHECK DE LEVEL UP ===
    const xpNovo = attr.xp || 0;
    const xpAntigo = dadosLocais.xp || 0;

    // Se o XP aumentou E n√£o √© a primeira vez que abrimos a p√°gina
    if (xpNovo > xpAntigo && !primeiraCarga) {
        const nivelAntigo = calcularNivel(xpAntigo);
        const nivelNovo = calcularNivel(xpNovo);

        // Se mudou de n√≠vel (ex: 1 para 2)
        if (nivelNovo > nivelAntigo) {
            document.getElementById('lvl-novo-numero').innerText = nivelNovo;
            document.getElementById('lvl-recompensas').innerText = RECOMPENSAS_NIVEL[nivelNovo] || "Recompensas n√£o listadas.";
            document.getElementById('modal-levelup').classList.add('show');
        }
    }
    primeiraCarga = false; // Marca que j√° carregou
    // ===============================

    // === NOVO C√ìDIGO DA FOTO ===
    const imgEl = document.getElementById('char-photo');
    if (attr.fotoUrl) {
        imgEl.src = attr.fotoUrl;
    } else {
        imgEl.src = `assets/${NOME_PERSONAGEM}.png`;
    }

    if (attr.inventario) {
        // Garante que sempre haja um array de items, weapons e objeto municao
        inventarioGlobal = {
            items: Array.isArray(attr.inventario.items) ? attr.inventario.items : [],
            weapons: Array.isArray(attr.inventario.weapons) ? attr.inventario.weapons : [],
            municao: attr.inventario.municao || {}
        };
    }

    if (attr.dinheiro !== undefined) {
        dinheiroAtual = parseInt(attr.dinheiro);
        document.getElementById('input-dinheiro').value = dinheiroAtual;
    }
    

    // Atributos B√°sicos
    document.getElementById('forca').value = attr.for || 0;
    document.getElementById('int').value = attr.int || 0;
    document.getElementById('vel').value = attr.vel || 0;
    document.getElementById('cor').value = attr.cor || 0;

    // Vitais
    dadosLocais.vida = attr.vida || 0;
    dadosLocais.dor = attr.dor || 0;
    dadosLocais.xp = attr.xp || 0; // Atualiza o XP local

    // Antecedentes
    const ant = attr.antecedentes || {};
    document.getElementById('atencao').value = ant.atencao || 0;
    document.getElementById('medicina').value = ant.medicina || 0;
    document.getElementById('montaria').value = ant.montaria || 0;
    document.getElementById('negocios').value = ant.negocios || 0;
    document.getElementById('roubo').value = ant.roubo || 0;
    document.getElementById('suor').value = ant.suor || 0;
    document.getElementById('tradicao').value = ant.tradicao || 0;
    document.getElementById('violencia').value = ant.violencia || 0;

    // Anota√ß√µes
    document.getElementById('anotacoes').value = attr.anotacoes || '';

    // Recursos
    // Recursos
    if (attr.recursos) {
        recursosData = attr.recursos;
        atualizarBotaoRecursos();
        
        // ATUALIZA√á√ÉO: Checa se est√° faminto
        if (recursosData.faminto) {
            document.body.classList.add('faminto');
            
            // CORRE√á√ÉO: S√≥ mostra o popup na primeira carga, n√£o a cada salvamento
            if (primeiraCarga) { 
                const aviso = document.getElementById('aviso-fragil');
                if(aviso) {
                    aviso.style.display = 'block';
                    setTimeout(() => aviso.style.display = 'none', 3000);
                }
            }
        } else {
            document.body.classList.remove('faminto');
        }
    }
    
    // Vestimentas e Reden√ß√£o
    if (attr.vestimentas) vestimentasData = attr.vestimentas;
    if (attr.redencao) redencaoData = attr.redencao;

    // Atualiza l√≥gica derivada
    gerarCaveirasVida();
    atualizarAcoes();
    atualizarVisual(); 

    // ATUALIZA√á√ÉO: RENDERIZAR ARMAS EQUIPADAS
    const containerArmas = document.getElementById('painel-armas');
    if(containerArmas) {
        containerArmas.innerHTML = '';
        if (attr.inventario && attr.inventario.weapons) {
            const armasEquipadas = attr.inventario.weapons.filter(w => w.equipado);
            armasEquipadas.forEach((arma) => {
                const indexReal = attr.inventario.weapons.indexOf(arma);
                const temMunicao = arma.balasMax > 0;
                const div = document.createElement('div');
                div.className = "painel-arma-equipada";
                
                // MUDAN√áA AQUI: justify-content: flex-start (para alinhar tudo na esquerda)
                div.style.cssText = "background: rgba(43,27,18,0.92); padding: 5px 8px; border: 2px solid #ffcc80; border-radius: 8px; display: flex; justify-content: flex-start; align-items: center; color: #fff; gap: 10px; max-width: 750px; width: 100%; min-width: 0; box-sizing: border-box; margin-bottom: 5px;";
                
                let painelBotoes = ''; // Mudei o nome de painelDireito para painelBotoes
                
                if (temMunicao) {
                    // Bot√µes de tiro
                    painelBotoes = `
                        <div style="text-align:center; min-width:70px; display:flex; flex-direction:column; align-items:center;">
                            <button onclick="darTiro(${indexReal})" style="background:#8b0000; color:#fff; border:2px solid #000; padding:4px 8px; font-family:'Rye'; cursor:pointer; font-size:0.9rem; border-radius:5px; margin-bottom:3px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);">ATIRAR!</button>
                            <div style="font-family:'Courier Prime'; font-size:0.85rem; color:#ffcc80;">${arma.balasAtual}/${arma.balasMax}</div>
                            <button onclick="recarregar(${indexReal})" style="font-size:0.7rem; background:none; border:none; color:#ccc; cursor:pointer; text-decoration:underline;">Recarregar</button>
                        </div>`;
                } else {
                    // √çcone de espada
                    painelBotoes = `
                        <div style="text-align:center; min-width:70px;">
                            <div style="font-size:1.4rem;">‚öîÔ∏è</div>
                        </div>`;
                }

                // MUDAN√áA AQUI: Inverti a ordem. Primeiro painelBotoes, depois o Texto.
                div.innerHTML = `
                    ${painelBotoes}
                    <div style="min-width:0; border-left: 1px solid rgba(255,204,128,0.3); padding-left: 10px;">
                        <div style="font-family:'Rye'; font-size:1rem; color:#ffcc80; word-break:break-word; line-height:1.1;">${arma.nome}</div>
                        <div style="font-size:0.8rem; font-family:'Courier Prime'; color:#ccc; word-break:break-word; line-height:1.2; margin-top:2px;">Dano: ${arma.dano} <br><i>${arma.descricao}</i></div>
                    </div>`;
                    
                containerArmas.appendChild(div);
            });
        }
    }
    statusMsg('‚Ä¢ Sincronizado ‚Ä¢');
}

// 4. NOVAS FUN√á√ïES PARA O POPUP DE RECURSOS

function abrirPopupRecursos() {
    document.getElementById('popup-recursos').classList.add('show');
    renderizarListaAlimentos();
    atualizarStatusAlimentacao();
}

function renderizarListaAlimentos() {
    const container = document.getElementById('lista-alimentos');
    if (!container) {
        console.error("ERRO: N√£o encontrei a div 'lista-alimentos' no HTML.");
        return;
    }

    container.innerHTML = ''; // Limpa a lista
    itemAlimentoSelecionadoIndex = null;
    let contador = 0;

    // 1. DIAGN√ìSTICO: Verifica se o invent√°rio existe
    if (!inventarioGlobal) {
        container.innerHTML = '<div style="padding:10px; color:red;">ERRO: O Invent√°rio n√£o foi carregado do banco de dados. Recarregue a p√°gina (F5).</div>';
        return;
    }

    // 2. DIAGN√ìSTICO: Verifica se existe a lista de itens
    if (!inventarioGlobal.items || !Array.isArray(inventarioGlobal.items)) {
        // Se n√£o tiver items, inicializa como array vazio para n√£o travar
        inventarioGlobal.items = [];
        container.innerHTML = '<div class="aviso-vazio">Invent√°rio vazio ou formato inv√°lido.</div>';
        return;
    }

    // 3. RENDERIZA√á√ÉO
    inventarioGlobal.items.forEach((item, index) => {
        // Aceita true, "true", 1, "1" para a flag alimento
        if (item && item.nome && (item.alimento === true || item.alimento === "true" || item.alimento === 1 || item.alimento === "1")) {
            contador++;
            const div = document.createElement('div');
            div.className = 'alimento-option';
            div.style.cssText = "display:flex; align-items:center; padding:8px; border-bottom:1px dashed #5d4037; cursor:pointer; color:#2b1b12;";
            div.onclick = function() {
                const radio = this.querySelector('input');
                radio.checked = true;
                itemAlimentoSelecionadoIndex = index;
            };
            div.innerHTML = `
                    <input type="radio" name="food_selection" value="${index}" style="margin-right:10px; width:20px; height:20px;">
                    <div style="display:flex; flex-direction:column;">
                        <span style="color:#2b1b12; font-weight:bold; font-size:1.1rem;">
                            üçó ${item.nome} ${item.usos > 1 ? `<span style="color:#d32f2f;">(x${item.usos})</span>` : ''}
                        </span>
                        <span style="color:#666; font-size:0.8rem;">Peso: ${item.espaco || 0} kg</span>
                    </div>
                `;
            container.appendChild(div);
        }
    });

    // 4. FEEDBACK SE N√ÉO ACHOU NADA
    if (contador === 0) {
        container.innerHTML = `
            <div class="aviso-vazio" style="text-align:center; padding:20px; color:#5d4037;">
                <p>Nenhum item marcado como "Alimento" encontrado.</p>
                <small style="color:#a00;">V√° na aba <b>Invent√°rio</b>, marque a caixinha ‚òë ao lado do item e espere salvar.</small>
            </div>`;
    }
}

async function seAlimentar() {
    // 1. Verifica se j√° comeu
    if (recursosData.alimentadoHoje) {
        alert('Voc√™ j√° est√° satisfeito por hoje!');
        return;
    }

    // 2. Verifica se selecionou algo
    if (itemAlimentoSelecionadoIndex === null) {
        alert('Selecione um item da lista para comer.');
        return;
    }

    const item = inventarioGlobal.items[itemAlimentoSelecionadoIndex];

    // 3. EFEITO DE COMER
    if(confirm(`Comer ${item.nome}?`)) {
        
        // Verifica se tem quantidade (usos) maior que 1
        if (item.usos && item.usos > 1) {
            // Apenas diminui um uso
            item.usos -= 1;
            statusMsg(`Comeu 1. Restam ${item.usos}.`);
        } else {
            // Se for 1 ou n√£o tiver o campo, remove o item
            inventarioGlobal.items[itemAlimentoSelecionadoIndex] = { 
                nome: '', 
                espaco: 0, 
                descricao: '', 
                alimento: false,
                usos: 1
            };
            statusMsg("Voc√™ comeu a √∫ltima por√ß√£o.");
        }

        // Marca como alimentado
        recursosData.alimentadoHoje = true;

        // Atualiza UI e Salva
        renderizarListaAlimentos(); 
        atualizarStatusAlimentacao();
        atualizarBotaoRecursos();
        
        await salvarFicha(); 
    }
}


// SALVAR FICHA (AGORA COMPLETO)
async function salvarFicha() {
    statusMsg('Salvando...');

    const novosAtributos = {
        // ... todos os seus atributos existentes (for, int, vida, etc)...
        for: val('forca'),
        int: val('int'),
        vel: val('vel'),
        cor: val('cor'),
        vida: dadosLocais.vida,
        dor: dadosLocais.dor,
        xp: dadosLocais.xp,
        
        antecedentes: {
            atencao: val('atencao'),
            medicina: val('medicina'),
            montaria: val('montaria'),
            negocios: val('negocios'),
            roubo: val('roubo'),
            suor: val('suor'),
            tradicao: val('tradicao'),
            violencia: val('violencia')
        },
        anotacoes: document.getElementById('anotacoes').value,
        recursos: recursosData,
        vestimentas: vestimentasData,
        redencao: redencaoData,

        // ADI√á√ÉO IMPORTANTE: Envia o invent√°rio modificado junto!
        inventario: inventarioGlobal,
        dinheiro: dinheiroAtual 
    };

    // Pega o cache atual pra n√£o perder Habilidades/Montaria/Invent√°rio
    const { data: currentData } = await client
        .from('Fichas').select('atributos').eq('nome_personagem', NOME_PERSONAGEM).single();
        
    let finalPayload = novosAtributos;
    if(currentData && currentData.atributos) {
        // Mistura o que tem no banco (Habilidades, Montaria) com o que editamos agora
        finalPayload = { ...currentData.atributos, ...novosAtributos };
    }

    const { error } = await client
        .from('Fichas')
        .update({ atributos: finalPayload })
        .eq('nome_personagem', NOME_PERSONAGEM);

    if (!error) {
        statusMsg('‚Ä¢ Salvo ‚Ä¢');
    } else {
        statusMsg('Erro ao salvar!');
        console.error(error);
    }
}



// 3. AUTO-SAVE
function setupAutoSave() {
    // Pega todos os inputs num√©ricos e o textarea
    const inputs = document.querySelectorAll('input[type="number"]:not([readonly]), textarea');
    
    inputs.forEach(input => {
        // Quando mudar e sair do campo, salva
        input.addEventListener('change', () => {
            // Valida√ß√£o de atributos (FOR, VEL, INT, COR)
            if(['forca', 'vel', 'int', 'cor'].includes(input.id)) {
                let valor = parseInt(input.value) || 0;
                if(valor > 4) {
                    alert('Valor m√°ximo permitido √© 4!');
                    input.value = 4;
                } else if(valor < 0) {
                    alert('Valor m√≠nimo permitido √© 0!');
                    input.value = 0;
                }
                gerarCaveirasVida();
                atualizarAcoes();
            }
            salvarFicha();
        });
    });

    // Configura Dor (Cliques)
    const fists = document.querySelectorAll('.dor-track img');
    fists.forEach((img, index) => {
        img.onclick = () => {
            const novoValor = index + 1;
            // Toggle: Se clicar no atual, zera
            dadosLocais.dor = (dadosLocais.dor === novoValor) ? 0 : novoValor;
            
            // --- NOVA MEC√ÇNICA DE FOME ---
            // Se estiver faminto, o limite √© 3. Se n√£o, √© 6.
            const limiteDor = (recursosData.faminto === true) ? 3 : 6;

            atualizarVisual();
            salvarFicha();

            // Se atingiu o limite (3 ou 6 dependendo da fome)
            if (dadosLocais.dor >= limiteDor) {
                converterDorEmVida();
                // Aviso extra pro jogador entender pq tomou dano com pouca dor
                if(limiteDor === 3) alert("Por estar FAMINTO, 3 de Dor foram suficientes para ferir voc√™!");
            }
        };
    });
}

function statusMsg(msg) {
    const el = document.getElementById('status');
    if(el) {
        el.innerText = msg;
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0.5, 2000);
    }
}

// L√≥gica de Condi√ß√£o (Dor -> Vida)
function converterDorEmVida() {
    dadosLocais.dor = 0;
    dadosLocais.vida += 1;
    sortearCondicao();
    atualizarVisual();
    salvarFicha();
}

function sortearCondicao() {
    const d6 = Math.floor(Math.random() * 6);
    const condicao = CONDICOES[d6];
    document.getElementById('condicao-nome').innerText = `üé≤ ${d6 + 1} - ${condicao.nome}`;
    document.getElementById('condicao-efeito').innerText = condicao.efeito;
    document.getElementById('modal-condicao').classList.add('show');
}

// ATUALIZE SUA FUN√á√ÉO fecharModal PARA ESTA:
function fecharModal() {
    const modal = document.getElementById('modal-condicao');
    modal.classList.remove('show');
    
    // Remove o estilo dourado (limpeza) para n√£o bugar os pr√≥ximos avisos normais
    setTimeout(() => {
        modal.querySelector('.modal-condicao').classList.remove('modal-redencao-full');
    }, 300);
}

// 4. REALTIME
client.channel('sala-western')
.on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'Fichas' }, 
    p => {
        if(p.new.nome_personagem === NOME_PERSONAGEM) {
            preencherTela(p.new.atributos);
        }
    }
).subscribe();

// ===== RECURSOS E VESTIMENTAS =====
let recursosData = { racoes: 0, alimentadoHoje: false };
let vestimentasData = [
    { nome: '', estado: 'bom', descricao: '' },
    { nome: '', estado: 'bom', descricao: '' },
    { nome: '', estado: 'bom', descricao: '' },
    { nome: '', estado: 'bom', descricao: '' },
    { nome: '', estado: 'bom', descricao: '' },
    { nome: '', estado: 'bom', descricao: '' }
];

// Abrir/Fechar Popups
async function abrirPopupRecursos() {
    // 1. Abre o modal visualmente primeiro (pra parecer r√°pido)
    document.getElementById('popup-recursos').classList.add('show');
    
    // 2. Coloca um aviso de "Carregando..." enquanto busca no banco
    const container = document.getElementById('lista-alimentos');
    container.innerHTML = '<div style="padding:10px; color:#aaa;">Buscando na mochila...</div>';

    // 3. FOR√áA baixar os dados mais recentes do Supabase
    // Isso garante que se voc√™ acabou de editar o invent√°rio, a ficha vai saber
    await buscarDados(); 

    // 4. Agora que baixou (e atualizou a vari√°vel inventarioGlobal), desenha a lista
    renderizarListaAlimentos();
    atualizarStatusAlimentacao();
}

function fecharPopupRecursos() {
    document.getElementById('popup-recursos').classList.remove('show');
}

function abrirPopupVestimentas() {
    document.getElementById('popup-vestimentas').classList.add('show');
    gerarListaVestimentas();
}

function fecharPopupVestimentas() {
    document.getElementById('popup-vestimentas').classList.remove('show');
}

async function seAlimentar() {
    // 1. Verifica√ß√µes b√°sicas
    if (recursosData.alimentadoHoje) {
        alert('Voc√™ j√° est√° satisfeito por hoje!');
        return;
    }
    if (itemAlimentoSelecionadoIndex === null) {
        alert('Selecione um item da lista para comer.');
        return;
    }

    // Pega o objeto do item
    const item = inventarioGlobal.items[itemAlimentoSelecionadoIndex];

    // 2. Confirma√ß√£o din√¢mica
    if(confirm(`Comer ${item.nome}?`)) {
        
        // --- NOVA L√ìGICA DE QUANTIDADE ---
        if (item.usos && item.usos > 1) {
            // Se tem mais de 1, apenas diminui
            item.usos = parseInt(item.usos) - 1;
            statusMsg(`Comeu 1. Restam ${item.usos}.`);
        } else {
            // Se for 1 ou n√£o tiver contagem, apaga o item (reseta o slot)
            inventarioGlobal.items[itemAlimentoSelecionadoIndex] = { 
                nome: '', 
                espaco: 0, 
                descricao: '', 
                alimento: false,
                usos: 1
            };
            statusMsg("Voc√™ comeu a √∫ltima por√ß√£o.");
        }

        // 3. Finaliza√ß√£o
        recursosData.alimentadoHoje = true;

        renderizarListaAlimentos(); 
        atualizarStatusAlimentacao();
        atualizarBotaoRecursos();
        
        await salvarFicha(); 
    }
}

function atualizarStatusAlimentacao() {
    const statusEl = document.getElementById('status-alimentado');
    const btnEl = document.getElementById('btn-alimentar');
    
    if (recursosData.alimentadoHoje) {
        statusEl.className = 'status-alimentado sim';
        statusEl.innerHTML = '‚úì Voc√™ j√° se alimentou hoje';
        btnEl.disabled = true;
        btnEl.textContent = '‚úì Alimentado';
    } else {
        statusEl.className = 'status-alimentado nao';
        statusEl.innerHTML = '‚úó Ainda n√£o se alimentou hoje';
        btnEl.disabled = false;
        btnEl.textContent = 'üç¥ Se Alimentar';
    }
}

function atualizarBotaoRecursos() {
    const btn = document.getElementById('btn-recursos');
    if (recursosData.alimentadoHoje) {
        btn.classList.add('fed');
    } else {
        btn.classList.remove('fed');
    }
}

// Vestimentas
function gerarListaVestimentas() {
    const container = document.getElementById('vestimentas-list');
    container.innerHTML = '';
    
    vestimentasData.forEach((vest, i) => {
        const div = document.createElement('div');
        div.className = `vestimenta-item estado-${vest.estado}`;
        div.innerHTML = `
            <div class="vestimenta-header">
                <input type="text" placeholder="Nome da vestimenta..." 
                       value="${escapeHtmlPopup(vest.nome)}" 
                       onchange="atualizarVestimenta(${i}, 'nome', this.value)">
                <select onchange="atualizarVestimenta(${i}, 'estado', this.value)">
                    <option value="bom" ${vest.estado === 'bom' ? 'selected' : ''}>Bom</option>
                    <option value="usado" ${vest.estado === 'usado' ? 'selected' : ''}>Usado</option>
                    <option value="rasgado" ${vest.estado === 'rasgado' ? 'selected' : ''}>Rasgado</option>
                    <option value="destruido" ${vest.estado === 'destruido' ? 'selected' : ''}>Destru√≠do</option>
                </select>
            </div>
            <textarea class="vestimenta-desc" placeholder="Descri√ß√£o, b√¥nus, prote√ß√£o..."
                      onchange="atualizarVestimenta(${i}, 'descricao', this.value)">${escapeHtmlPopup(vest.descricao)}</textarea>
        `;
        container.appendChild(div);
    });
}

function atualizarVestimenta(index, campo, valor) {
    vestimentasData[index][campo] = valor;
    
    // Atualiza visual do estado
    if (campo === 'estado') {
        const item = document.querySelectorAll('.vestimenta-item')[index];
        item.className = `vestimenta-item estado-${valor}`;
    }
    
    salvarFicha();
}

function escapeHtmlPopup(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}


// ===== REDEN√á√ÉO =====
const REDENCOES = {
    vinganca: {
        titulo: 'Vingan√ßa',
        descricao: 'Preciso me vingar de (nome) que (assassinou/sequestrou) minha/meu (povo/fam√≠lia/terras).',
        passos: [
            'Causar problemas para minha gangue ao menos tr√™s vezes por causa da minha vingan√ßa.',
            'Encontrar e ajudar (nome), a √∫ltima v√≠tima de (nome de quem est√° se vingando).',
            'Ir at√© o √∫ltimo local onde (nome de quem est√° se vingando) foi avistado.',
            'Resolver outro problema que (nome de quem est√° se vingando) causou pelo caminho.',
            'Encontrar o paradeiro de (nome de quem est√° se vingando) e fazer o desafio para um duelo.',
            'Vencer o duelo e completar minha vingan√ßa.'
        ]
    },
    fuga: {
        titulo: 'Fuga',
        descricao: 'Acabei de escapar (da cadeia/dos sagrados/de outra gangue). H√° uma boa recompensa pela minha cabe√ßa.',
        passos: [
            'Usar sua condi√ß√£o de procurado para ajudar a gangue.',
            'Causar problemas para minha gangue ao menos tr√™s vezes por ser procurado.',
            'Sacrificar (algo/algu√©m) importante para mim, em nome da minha liberdade.',
            'Livrar-me do pior ca√ßador de recompensas que estiver atr√°s da minha cabe√ßa.',
            'Juntar o dinheiro necess√°rio para pagar o pre√ßo pela minha cabe√ßa.',
            'Eliminar minha situa√ß√£o de procurado pagando a d√≠vida ou lidando com as autoridades.'
        ]
    },
    divida: {
        titulo: 'D√≠vida',
        descricao: 'Tenho uma d√≠vida com um (mafioso/pol√≠tico) poderoso. Devo quit√°-la ou pagarei com a vida.',
        passos: [
            'Recolher dinheiro da minha gangue para pagar minha d√≠vida.',
            'Causar problemas para minha gangue ao menos tr√™s vezes por causa da minha d√≠vida.',
            'Encontrar um trabalho que d√™ muito dinheiro, mas √© muito mais arriscado do que o normal.',
            'Juntar o valor de metade da minha d√≠vida, ou conseguir um desconto.',
            '(Roubar/enganar) algu√©m que eu amo para conseguir ainda mais dinheiro.',
            'Pagar minha d√≠vida.'
        ]
    },
    remorso: {
        titulo: 'Remorso',
        descricao: 'Cometi um crime imperdo√°vel contra (minha fam√≠lia/meu povo).',
        passos: [
            'N√£o (matar/roubar/andar √† cavalo) como conduta punitiva para meu remorso.',
            'Causar problemas para minha gangue ao menos tr√™s vezes por causa do meu remorso.',
            'Reencontrar aqueles que sofreram por minha causa e fazer um servi√ßo importante para eles.',
            'Encontrar uma forma de compensar (minha gangue/fam√≠lia/meu povo) pelo ato que cometi.',
            'Sacrificar as (minhas posses/vida atual/algu√©m importante) para conseguir o perd√£o.',
            'Expiar o remorso dentro de mim e viver com o cora√ß√£o mais leve.'
        ]
    },
    recomeco: {
        titulo: 'Recome√ßo',
        descricao: 'J√° fui um grande (bandido/xerife/ca√ßador) no passado, me aposentei e perdi minha honra.',
        passos: [
            'Realizar uma fa√ßanha que prove para minha gangue que eu ainda posso ser √∫til.',
            'Encontrar algu√©m do meu passado que ainda se lembre de minha reputa√ß√£o.',
            'Aprender ao menos 2 novas habilidades (isso pode ser conseguido com a evolu√ß√£o do personagem).',
            'Causar problemas para minha gangue ao menos tr√™s vezes pela minha busca por recome√ßo.',
            'Repetir duas fa√ßanhas t√£o √©picas (roubos/salvamentos/capturas) quanto as que fiz no passado.',
            'Recuperar minha honra, gl√≥ria e fama que tinha no passado.'
        ]
    },
    ambicao: {
        titulo: 'Ambi√ß√£o',
        descricao: 'Vou me tornar (maior/melhor/mais r√°pido) (duelista/jogador/bandido) que j√° pisou no Oeste Selvagem.',
        passos: [
            'Encontrar tr√™s outros (duelistas/jogadores/bandidos) para (duelar/jogar/enfrentar).',
            'Causar problemas para minha gangue ao menos tr√™s vezes por causa da minha ambi√ß√£o.',
            'Fazer ao menos tr√™s grandes (duelistas/jogadores/bandidos) conhecerem minha reputa√ß√£o.',
            'Perder algum importante causa da ambi√ß√£o. (Este passo n√£o pode acontecer primeiro).',
            'Fazer amizade com um (rival/xerife/bandido) que tem a mesma ambi√ß√£o que eu.',
            'Vencer o (duelo/jogo/combate) e me tornar (maior/melhor/mais r√°pido) do Oeste Selvagem.'
        ]
    },
    culpa: {
        titulo: 'Culpa',
        descricao: 'Carrego comigo a culpa de ter feito algo terr√≠vel no passado.',
        passos: [
            'N√£o salvar/curar algu√©m por n√£o acreditar que sou capaz.',
            'Causar Problemas para a minha gangue ao menos tres vezes por conta da minha Culpa/Autodesacredita√ß√£o.',
            'Reencontrar/Encontrar algu√©m que sofreu por conta da minhas a√ß√µes ou minha incapacidade, e ajudar a pessoa.',
            'Encontrar uma forma de compensar a minha gangue pelos erros que cometi.',
            'Conseguir salvar algu√©m muito importante na minha vida por conta das minhas a√ß√µes.',
            'Eliminar a culpa das mortes que eu deixei acontecer, e entender que eu tentei o maximo que eu conseguia.'
        ]
    }
};

let redencaoData = {
    tipo: 'vinganca',
    passosCompletos: [false, false, false, false, false, false]
};

function abrirPopupRedencao() {
    document.getElementById('popup-redencao').classList.add('show');
    document.getElementById('redencao-tipo').value = redencaoData.tipo;
    atualizarPopupRedencao();
}

function fecharPopupRedencao() {
    document.getElementById('popup-redencao').classList.remove('show');
}

function mudarTipoRedencao() {
    const novoTipo = document.getElementById('redencao-tipo').value;
    if (novoTipo !== redencaoData.tipo) {
        // Reseta os passos ao mudar de tipo
        redencaoData.tipo = novoTipo;
        redencaoData.passosCompletos = [false, false, false, false, false, false];
        atualizarPopupRedencao();
        salvarFicha();
    }
}

function atualizarPopupRedencao() {
    const tipo = redencaoData.tipo;
    const redencao = REDENCOES[tipo];
    
    // Atualiza descri√ß√£o
    document.querySelector('#redencao-descricao p').textContent = redencao.descricao;
    
    // Gera lista de passos
    const container = document.getElementById('redencao-passos');
    container.innerHTML = '';
    
    redencao.passos.forEach((passo, i) => {
        const completo = redencaoData.passosCompletos[i];
        const div = document.createElement('div');
        div.className = `passo-item ${completo ? 'completo' : ''}`;
        div.onclick = () => togglePasso(i);
        div.innerHTML = `
            <div class="passo-checkbox">${completo ? '‚úì' : ''}</div>
            <span class="passo-numero">Passo ${i + 1}</span>
            <span class="passo-texto">${passo}</span>
        `;
        container.appendChild(div);
    });
    
    atualizarProgressoRedencao();
}

function togglePasso(index) {
    redencaoData.passosCompletos[index] = !redencaoData.passosCompletos[index];
    atualizarPopupRedencao();
    salvarFicha();
    
    // --- NOVO: VERIFICA SE COMPLETOU OS 6 PASSOS ---
    const totalCompletos = redencaoData.passosCompletos.filter(p => p).length;
    
    if (totalCompletos === 6) {
        // Fecha o popup da lista para mostrar o parab√©ns limpo
        fecharPopupRedencao(); 
        
        // Mensagem com quebras de linha (\n)
        const recompensas = "Voc√™ concluiu sua jornada.\n\nVOC√ä GANHOU:\n‚òÖ +1 Habilidade\n‚òÖ +2 de Vida\n‚òÖ Pode tirar uma carta a mais na Iniciativa e escolher a melhor.";
        
        mostrarModalRedencao("REDEN√á√ÉO ALCAN√áADA!", recompensas);
    }
}

// Fun√ß√£o espec√≠fica para abrir o modal com estilo dourado
function mostrarModalRedencao(titulo, mensagem) {
    const modal = document.getElementById('modal-condicao');
    const content = modal.querySelector('.modal-condicao');
    
    // Adiciona a classe de estilo dourado
    content.classList.add('modal-redencao-full');
    
    document.getElementById('condicao-nome').innerText = titulo;
    document.getElementById('condicao-efeito').innerText = mensagem;
    modal.classList.add('show');
}

function atualizarProgressoRedencao() {
    const completos = redencaoData.passosCompletos.filter(p => p).length;
    const total = 6;
    const porcentagem = (completos / total) * 100;
    
    document.getElementById('progresso-texto').textContent = `${completos} / ${total} passos`;
    document.getElementById('progresso-fill').style.width = `${porcentagem}%`;
}

// ========================================================
// SISTEMA DE TIRO E RECARGA (INTEGRADO COM O INVENT√ÅRIO)
// ========================================================

// Fun√ß√£o gen√©rica para avisos (Usa o modal de condi√ß√£o que j√° existe)
function mostrarModalAviso(titulo, mensagem) {
    const modal = document.getElementById('modal-condicao');
    if (!modal) return;
    
    document.getElementById('condicao-nome').innerText = titulo;
    document.getElementById('condicao-efeito').innerText = mensagem;
    modal.classList.add('show');
}

async function darTiro(indexArma) {
    // Busca dados atualizados
    const { data } = await client.from('Fichas').select('atributos').eq('nome_personagem', NOME_PERSONAGEM).single();
    
    if (data && data.atributos && data.atributos.inventario) {
        let weapons = data.atributos.inventario.weapons;
        
        if (weapons[indexArma].balasAtual > 0) {
            // TEM BALA: ATIRA
            weapons[indexArma].balasAtual -= 1;
            
            const payload = { ...data.atributos };
            payload.inventario.weapons = weapons;
            
            // Salva e Atualiza a tela
            await client.from('Fichas').update({ atributos: payload }).eq('nome_personagem', NOME_PERSONAGEM);
            preencherTela(payload);
        } else {
            // SEM BALA NA ARMA
            mostrarModalAviso('‚ö† CLIQUE SECO!', 'Sua arma est√° vazia. Voc√™ precisa recarregar.');
        }
    }
}

async function recarregar(indexArma) {
    // 1. Busca dados do banco para garantir que temos o invent√°rio atualizado
    const { data } = await client.from('Fichas').select('atributos').eq('nome_personagem', NOME_PERSONAGEM).single();
    
    if (data) {
        let inv = data.atributos.inventario;
        let weapons = inv.weapons;
        
        // Pega a muni√ß√£o do invent√°rio (ou cria zerada se n√£o existir pra n√£o dar erro)
        let municao = inv.municao || { tipo: 'bandoleira', qtd: 0 }; 

        const arma = weapons[indexArma];
        const balasFaltando = arma.balasMax - arma.balasAtual;

        // CASO 1: A arma j√° est√° cheia?
        if (balasFaltando <= 0) {
            mostrarModalAviso('‚ö† ARMA CHEIA', 'Essa arma j√° est√° totalmente carregada.');
            return;
        }

        // CASO 2: Tem balas no cinto/bandoleira?
        if (municao.qtd <= 0) {
            mostrarModalAviso('‚ö† CINTUR√ÉO VAZIO!', 'Voc√™ n√£o tem mais balas no seu invent√°rio.');
            return;
        }

        // CASO 3: Recarga (Matem√°tica)
        // Recarrega o que falta OU o que tem dispon√≠vel (o que for menor)
        const quantidadeRecarga = Math.min(balasFaltando, municao.qtd);

        // Enche a arma
        weapons[indexArma].balasAtual += quantidadeRecarga;
        
        // Esvazia o cinto
        municao.qtd -= quantidadeRecarga;

        // Monta o pacote pra salvar
        const payload = { ...data.atributos };
        payload.inventario.weapons = weapons;
        payload.inventario.municao = municao; // Salva a nova quantidade do cinto
        
        // Envia pro Supabase
        await client.from('Fichas').update({ atributos: payload }).eq('nome_personagem', NOME_PERSONAGEM);
        
        // Feedback
        statusMsg(`Recarregou ${quantidadeRecarga} balas`);
        preencherTela(payload);
    }
}


// ========================================================
// SISTEMA DE TUTORIAL (ONBOARDING)
// ========================================================

const passosTutorial = [
    {
        titulo: "SUA FICHA DIGITAL",
        texto: `Esta √© a sua ferramenta de sobreviv√™ncia. Todos os dados (Vida, Atributos, Muni√ß√£o) s√£o <b>salvos automaticamente</b> assim que voc√™ os altera.<br><br>N√£o se preocupe em perder seu progresso.`
    },
    {
        titulo: "SOBREVIV√äNCIA & REDEN√á√ÉO",
        texto: `No canto inferior direito, use os bot√µes flutuantes:<br><br>
        üçñ <b>Recursos:</b> Gerencie sua fome e gaste ra√ß√µes.<br>
        üëî <b>Vestimentas:</b> Cuide do estado das suas roupas.<br>
        ‚õ™ <b>Reden√ß√£o:</b> Acompanhe sua miss√£o pessoal.`
    },
    {
        titulo: "COMBATE E MUNI√á√ÉO",
        texto: `Suas armas aparecem na lista. <br><br>
        üî¥ <b>ATIRAR:</b> Clique no bot√£o vermelho. A bala √© descontada automaticamente.<br>
        üîÑ <b>RECARREGAR:</b> Se a arma esvaziar, clique em Recarregar. O sistema buscar√° muni√ß√£o direto do seu <b>Invent√°rio</b> (Cinto, Bandoleira ou Aljava).`
    }
];

let passoAtual = 0;

// Verifica se o usu√°rio j√° viu o tutorial para esse personagem
function verificarTutorial() {
    const viuTutorial = localStorage.getItem(`tutorial_visto_${NOME_PERSONAGEM}`);
    
    if (!viuTutorial) {
        passoAtual = 0;
        atualizarModalTutorial();
        document.getElementById('modal-tutorial').classList.add('show');
    }
}

function atualizarModalTutorial() {
    const dados = passosTutorial[passoAtual];
    document.getElementById('tut-titulo').innerText = dados.titulo;
    document.getElementById('tut-conteudo').innerHTML = dados.texto;
    document.getElementById('tut-passo').innerText = passoAtual + 1;

    // Muda o texto do bot√£o no √∫ltimo passo
    const btn = document.getElementById('btn-prox-tut');
    if (passoAtual === passosTutorial.length - 1) {
        btn.innerText = "Entendido (Fechar)";
        btn.onclick = fecharTutorialCompleto;
    } else {
        btn.innerText = "Pr√≥ximo ‚ûî";
        btn.onclick = proximoPasso;
    }
}

function proximoPasso() {
    if (passoAtual < passosTutorial.length - 1) {
        passoAtual++;
        atualizarModalTutorial();
    }
}

function fecharTutorialCompleto() {
    // Marca que o usu√°rio j√° viu
    localStorage.setItem(`tutorial_visto_${NOME_PERSONAGEM}`, 'true');
    document.getElementById('modal-tutorial').classList.remove('show');
}

function pularTutorial() {
    // Marca como visto tamb√©m pra n√£o encher o saco depois
    if(confirm("Tem certeza? O tutorial explica como recarregar as armas.")) {
        fecharTutorialCompleto();
    }
}

// FUN√á√ïES DE MORTE
function morteSucesso() {
    // Se tiver sucesso, removemos 1 de dano para o personagem n√£o ficar "marcado como morto" na ficha
    if(dadosLocais.vida > 0) dadosLocais.vida -= 1;
    
    atualizarVisual();
    salvarFicha();
    
    // Fecha o modal de morte e mostra um aviso
    document.getElementById('modal-morte').classList.remove('show');
    mostrarModalAviso("SOBREVIVEU", "Voc√™ estabilizou por pouco. Cuidado.");
}

function morteFalha() {
    document.getElementById('modal-morte').classList.remove('show');
    // Aqui apenas avisamos. Se quiser, podemos adicionar l√≥gica para "travar" a ficha depois.
    mostrarModalAviso("FIM DA LINHA", "Seu personagem sucumbiu aos ferimentos.");
}


// --- FUN√á√ïES DE N√çVEL E POPUP ---

// Calcula n√≠vel baseado no XP (Reutilizando a constante TABELA_NIVEL que voc√™ j√° tem)
function calcularNivel(xp) {
    let nivel = 1;
    for (let i = 0; i < TABELA_NIVEL.length; i++) {
        if (xp >= TABELA_NIVEL[i].xp) {
            nivel = TABELA_NIVEL[i].nivel;
        }
    }
    return nivel;
}

function abrirModalLevelUp(novoNivel) {
    const textoRecompensa = RECOMPENSAS_NIVEL[novoNivel] || "Parab√©ns pela sobreviv√™ncia.";
    
    document.getElementById('lvl-novo-numero').innerText = novoNivel;
    document.getElementById('lvl-recompensas').innerText = textoRecompensa;
    
    document.getElementById('modal-levelup').classList.add('show');
    
    // Efeito sonoro opcional (se quiser)
    // const audio = new Audio('assets/levelup.mp3'); audio.play();
}

function fecharLevelUp() {
    document.getElementById('modal-levelup').classList.remove('show');
}


function abrirPopupCarteira() {
    document.getElementById('popup-carteira').classList.add('show');
}

function fecharPopupCarteira() {
    document.getElementById('popup-carteira').classList.remove('show');
}

// 1. Quando VOC√ä mexe nas setinhas ou digita
function interacaoManualDinheiro(valor) {
    let novoValor = parseInt(valor);
    if (isNaN(novoValor) || novoValor < 0) novoValor = 0;
    
    // Atualiza apenas a mem√≥ria, N√ÉO mexe no input (pois voc√™ j√° est√° mexendo nele)
    dinheiroAtual = novoValor;
    
    agendarSalvamentoDinheiro();
}

// 2. Quando voc√™ clica nos bot√µes coloridos (+ $10, - $50)
function somarDinheiro(quantia) {
    let novoTotal = dinheiroAtual + quantia;
    if (novoTotal < 0) novoTotal = 0;
    
    dinheiroAtual = novoTotal;
    
    // Aqui sim precisamos atualizar o input visualmente
    document.getElementById('input-dinheiro').value = dinheiroAtual;

    // Anima√ß√£ozinha visual
    const input = document.getElementById('input-dinheiro');
    input.style.transform = "scale(1.1)";
    setTimeout(() => input.style.transform = "scale(1)", 100);

    agendarSalvamentoDinheiro();
}

// 3. O "Maestro" do tempo (Debounce)
function agendarSalvamentoDinheiro() {
    // Feedback visual
    const status = document.getElementById('status');
    if(status) {
        status.innerText = 'Contando moedas...';
        status.style.opacity = 1;
    }

    // Cancela o salvamento anterior se voc√™ ainda estiver clicando
    clearTimeout(timeoutDinheiro);

    // Agenda o salvamento real para daqui a 1.5 segundos
    timeoutDinheiro = setTimeout(() => {
        salvarFicha();
    }, 1500); 
}

// Fun√ß√£o atualizada: EXAUST√ÉO
async function passarODia() {
    if (!confirm("Encerrar o dia e descansar?")) return;

    // 1. Verifica alimenta√ß√£o
    if (recursosData.alimentadoHoje) {
        // --- CEN√ÅRIO: ALIMENTADO ---
        statusMsg("Descanso revigorante.");
        
        // Remove status de fome visual
        document.body.classList.remove('status-faminto');
        document.getElementById('aviso-fome').style.display = 'none';

        // RECUPERA√á√ÉO (Regra padr√£o: zera dor ou cura vida?)
        // Vamos assumir que comer limpa a Dor acumulada do dia
        dadosLocais.dor = 0; 

    } else {
        // --- CEN√ÅRIO: FAMINTO (Hardcore) ---
        
        // Efeito Visual
        document.body.classList.add('status-faminto');
        document.getElementById('aviso-fome').style.display = 'block';
        setTimeout(() => document.getElementById('aviso-fome').style.display = 'none', 4000); // Some depois de 4s

        // L√≥gica de Dano: Limite de 3 de Dor
        if (dadosLocais.dor >= 3) {
            // Se j√° tem 3 ou mais de dor, o corpo consome a pr√≥pria vida
            if (dadosLocais.vida > 0) {
                dadosLocais.vida -= 1; // Dano real
                
                // Mostra aviso de dano
                alert("‚ö†Ô∏è FOME EXTREMA!\nSeu corpo n√£o aguenta mais.\n-1 VIDA");
            } else {
                // Se vida j√° era 0 e tomou dano... Check de morte
                document.getElementById('modal-morte').classList.add('show');
            }
        } else {
            // Se tem menos de 3 de dor, ganha +1 de Dor pela fome
            dadosLocais.dor += 1;
            statusMsg("A fome aumenta sua Dor...");
        }
    }

    // Reseta flag de comida
    recursosData.alimentadoHoje = false;
    
    // Atualiza UI e Salva
    atualizarVisual();
    atualizarStatusAlimentacao();
    atualizarBotaoRecursos();
    await salvarFicha();
}


// INICIALIZA√á√ÉO
setupAutoSave();
buscarDados();

// Atualiza o nome no banner
document.getElementById('nome-personagem-texto').textContent = NOME_PERSONAGEM;

if (!document.documentElement.classList.contains('locked')) {
    setTimeout(verificarTutorial, 1000); // Espera 1seg pra carregar o layout antes de mostrar
}

</script>

<script>
    // MANT√âM O USU√ÅRIO AO NAVEGAR
    // Se eu sou a Trinity, clico no invent√°rio e vou para inventario.html?nome=Trinity
    const paramsURL = new URLSearchParams(window.location.search);
    const nomeAtual = paramsURL.get('nome');

    if (nomeAtual) {
        document.querySelectorAll('a').forEach(link => {
            const href = link.getAttribute('href');
            // Se o link √© interno e n√£o tem ?nome ainda
            if (href && !href.startsWith('http') && !href.includes('?')) {
                link.setAttribute('href', `${href}?nome=${nomeAtual}`);
            }
        });
    }
</script>

<!-- BOT√ÉO FLUTUANTE DE FEEDBACK -->
<style>
    .feedback-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b6914, #d4a84b);
        border: 2px solid #ffcc80;
        color: #140d0a;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .feedback-btn:hover {
        filter: brightness(1.1);
    }
    .feedback-modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.85);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }
    .feedback-modal.ativo { display: flex; }
    .feedback-box {
        background: rgba(30, 20, 15, 0.98);
        border: 2px solid #8b6914;
        border-radius: 8px;
        padding: 25px;
        width: 90%;
        max-width: 450px;
        position: relative;
    }
    .feedback-box::before {
        content: '';
        position: absolute; top: -2px; left: -2px;
        width: 15px; height: 15px;
        border-top: 2px solid #ffcc80; border-left: 2px solid #ffcc80;
    }
    .feedback-box::after {
        content: '';
        position: absolute; bottom: -2px; right: -2px;
        width: 15px; height: 15px;
        border-bottom: 2px solid #ffcc80; border-right: 2px solid #ffcc80;
    }
    .feedback-box h3 {
        font-family: 'Rye', serif;
        color: #ffcc80;
        margin: 0 0 20px;
        text-align: center;
    }
    .feedback-box select,
    .feedback-box textarea {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        background: rgba(0,0,0,0.5);
        border: 1px solid #8b6914;
        border-radius: 4px;
        color: #e6dccf;
        font-family: 'Courier Prime', monospace;
        font-size: 1em;
        box-sizing: border-box;
    }
    .feedback-box textarea {
        min-height: 120px;
        resize: vertical;
    }
    .feedback-box select:focus,
    .feedback-box textarea:focus {
        outline: none;
        border-color: #ffcc80;
    }
    .feedback-box button[type="submit"] {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #8b6914, #d4a84b);
        border: none;
        border-radius: 4px;
        color: #140d0a;
        font-family: 'Rye', serif;
        font-size: 1em;
        cursor: pointer;
    }
    .feedback-box button[type="submit"]:hover {
        filter: brightness(1.1);
    }
    .feedback-fechar {
        position: absolute;
        top: 10px; right: 15px;
        background: none;
        border: none;
        color: #ffcc80;
        font-size: 1.3em;
        cursor: pointer;
    }
    .feedback-sucesso {
        text-align: center;
        color: #4caf50;
        padding: 20px;
    }
</style>

<button class="feedback-btn" onclick="document.getElementById('feedbackModal').classList.add('ativo')" title="Enviar Feedback">
    üí¨
</button>

<div class="feedback-modal" id="feedbackModal">
    <div class="feedback-box">
        <button class="feedback-fechar" onclick="document.getElementById('feedbackModal').classList.remove('ativo')">‚úï</button>
        <h3>üìù Enviar Feedback</h3>
        <form id="feedbackForm">
            <select id="feedbackTipo" required>
                <option value="">Selecione o tipo...</option>
                <option value="bug">üêõ Bug / Erro</option>
                <option value="sugestao">üí° Sugest√£o</option>
                <option value="duvida">‚ùì D√∫vida</option>
                <option value="outro">üìå Outro</option>
            </select>
            <textarea id="feedbackMsg" placeholder="Descreva aqui seu feedback..." required></textarea>
            <button type="submit">Enviar</button>
        </form>
        <div class="feedback-sucesso" id="feedbackSucesso" style="display:none;">
            ‚úÖ Feedback enviado com sucesso!<br>Obrigado pela contribui√ß√£o!
        </div>
    </div>
</div>

<script>
    document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const tipo = document.getElementById('feedbackTipo').value;
        const mensagem = document.getElementById('feedbackMsg').value;
        const pagina = window.location.pathname.split('/').pop();
        
        try {
            await client.from('feedbacks').insert({
                tipo: tipo,
                mensagem: mensagem,
                pagina: pagina,
                personagem: typeof NOME_PERSONAGEM !== 'undefined' ? NOME_PERSONAGEM : 'An√¥nimo'
            });
            
            document.getElementById('feedbackForm').style.display = 'none';
            document.getElementById('feedbackSucesso').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('feedbackModal').classList.remove('ativo');
                document.getElementById('feedbackForm').style.display = 'block';
                document.getElementById('feedbackSucesso').style.display = 'none';
                document.getElementById('feedbackForm').reset();
            }, 2000);
        } catch (err) {
            alert('Erro ao enviar feedback. Tente novamente.');
        }
    });
    
    document.getElementById('feedbackModal').addEventListener('click', (e) => {
        if (e.target.id === 'feedbackModal') {
            document.getElementById('feedbackModal').classList.remove('ativo');
        }
    });
</script>

</body>
</html>