<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha: A Última Dose</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="sheet">
  
        <div class="sheet-left">
            <div class="portrait-frame">
            <img src="assets/personagem.png" alt="Personagem">
            </div>

            <div class="name-banner">
            <h1>Trinity</h1>
            </div>
        </div>

        <div class="sheet-right">

            <div class="wanted-strip">
            <span>WANTED</span>
            <span>Dead or Alive</span>
            </div>

            <div class="attributes">
            <!-- FIS / VEL / INT / COR -->
            </div>

            <div class="tracks">
            <!-- Vida / Dor com ícones -->
            </div>

            <div class="skills">
            <!-- Cards de habilidades -->
            </div>

        </div>

    </div>

    <div class="track vida">
        <img src="assets/skull.png">
        <img src="assets/skull.png">
        <img src="assets/skull.png">
    </div>



    <script>
        // ================= CONFIGURAÇÃO =================
        const SUPABASE_URL = 'https://jhktbogzlbjazfeddwla.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impoa3Rib2d6bGJqYXpmZWRkd2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMDA5MTEsImV4cCI6MjA4Mzg3NjkxMX0.7Om5p6w4GB6lOYBODigGuTOWWd3bq6uPBssw4cvFsUg';
        
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const NOME_PERSONAGEM = 'Trinity';

        // ================= LÓGICA =================
        async function buscarDados() {
            const { data, error } = await client
                .from('Fichas')
                .select('*')
                .eq('nome_personagem', NOME_PERSONAGEM)
                .single();

            if (data) atualizarTela(data.atributos);
            else if (error) console.error(error);
        }

        function atualizarVida(valor) {
            const skulls = document.querySelectorAll('.vida img');
            skulls.forEach((s, i) => {
                s.classList.toggle('ativo', i < valor);
            });
        }


        function atualizarTela(atributos) {
            document.getElementById('for').value = atributos.for || 0;
            document.getElementById('vig').value = atributos.vig || 0;
            document.getElementById('agi').value = atributos.agi || 0;
            document.getElementById('vida').value = atributos.vida || 0;
            
            document.getElementById('status').innerText = '• Sincronizado •';
            
            const container = document.getElementById('ficha-container');
            container.classList.remove('flash-update');
            void container.offsetWidth; 
            container.classList.add('flash-update');
        }

        client
            .channel('sala-western')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'Fichas' }, 
            (payload) => {
                if(payload.new.nome_personagem === NOME_PERSONAGEM) {
                    atualizarTela(payload.new.atributos);
                }
            })
            .subscribe();

        async function salvarFicha() {
            document.getElementById('status').innerText = 'Enviando...';
            
            const novosAtributos = {
                for: parseInt(document.getElementById('for').value),
                vig: parseInt(document.getElementById('vig').value),
                agi: parseInt(document.getElementById('agi').value),
                vida: parseInt(document.getElementById('vida').value)
            };

            const { error } = await client
                .from('Fichas')
                .update({ atributos: novosAtributos })
                .eq('nome_personagem', NOME_PERSONAGEM);

            if (!error) {
                document.getElementById('status').innerText = 'Registrado!';
                setTimeout(() => document.getElementById('status').innerText = '• Sincronizado •', 2000);
            }
        }

        buscarDados();
    </script>
</body>
</html>