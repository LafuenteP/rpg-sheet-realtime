<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Invent√°rio ‚Äî A √öltima Dose</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <script>
        // CONFIGURA√á√ÉO DE SENHAS
        const SENHAS = {
            'Trinity': 'trinity123',
            'Josue': 'pantufa',
            'Januario': 'morena<3',
            'Junin': 'junin123',
            'Geraldo': 'ph123',
        };

        // VERIFICA√á√ÉO DE LOGIN
        function checkAuth() {
            if (!SENHAS[NOME_PERSONAGEM]) return true;
            const authKey = `auth_${NOME_PERSONAGEM}`;
            const authData = JSON.parse(localStorage.getItem(authKey));
            if (authData && (Date.now() - authData.time < 86400000)) return true;
            return false;
        }

        // BLOQUEIA IMEDIATAMENTE SE PRECISAR
        if (!checkAuth()) {
            document.documentElement.classList.add('locked');
        }

        function tentarDesbloquear() {
            const input = document.getElementById('pass-input');
            if (input.value === SENHAS[NOME_PERSONAGEM]) {
                localStorage.setItem(`auth_${NOME_PERSONAGEM}`, JSON.stringify({ time: Date.now() }));
                document.documentElement.classList.remove('locked');
                document.getElementById('tela-senha').style.display = 'none';
            } else {
                document.getElementById('pass-error').style.display = 'block';
                input.value = '';
            }
        }

        // FUN√á√ÉO DEBOUNCE (PARA N√ÉO TRAVAR O BANCO)
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // VARIAVEL GLOBAL PARA O SALVAMENTO COM ATRASO
        var acionarSalvarComDelay; 
    </script>

    <style>
        /* CSS DE BLOQUEIO */
        html.locked body > *:not(#tela-senha) { display: none !important; }
        html.locked body { background: #1a1411; overflow: hidden; }
        #tela-senha { display: none; }
        html.locked #tela-senha { display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1411; z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }

        /* ESTILOS GERAIS */
        :root { --ink: #2b1b12; --gold: #ffcc80; --bg-dark: #1a1411; }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; min-height: 100vh; font-family: 'Courier Prime', monospace; background: var(--bg-dark); }
        
        /* BACKGROUND */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url("assets/inventario/backgroundinv.png") no-repeat center;
            background-size: cover; filter: brightness(0.7); z-index: -1;
        }

        /* TELA SENHA */
        .password-box { background:url('assets/locked.jpg') center center/contain no-repeat, #1a1411; padding:40px; border:5px solid #2b1b12; text-align:center; max-width:400px; border-radius:8px; }
        .password-box h2 { font-family: 'Rye'; margin: 0 0 10px 0; color: var(--ink); }
        .password-box input { width: 100%; padding: 10px; margin-bottom: 15px; font-family: 'Courier Prime'; font-size: 1.2rem; text-align: center; }
        .password-box button { width: 100%; padding: 10px; font-family: 'Rye'; font-size: 1.1rem; background: #5d4037; color: #fff; cursor: pointer; border: none; }

        /* LAYOUT NAVBAR (ATUALIZADO) */
        .western-nav { display: flex; justify-content: center; gap: 15px; padding: 15px; background: rgba(43, 27, 18, 0.95); border-bottom: 2px solid #5d4037; width: 100%; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .western-nav a { color: #aaa; text-decoration: none; font-family: 'Rye'; font-size: 1rem; padding: 5px 10px; border: 1px solid transparent; text-transform: uppercase; transition: 0.2s; }
        .western-nav a:hover, .western-nav a.active { color: var(--gold); border-color: var(--gold); }

        .inventory-container { padding: 40px 20px; display: flex; justify-content: center; }
        .inventory-layout { display: flex; gap: 20px; width: 100%; max-width: 1000px; align-items: flex-start; }
        .tables-column { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 0; }

        /* --- LAYOUT DE 3 COLUNAS --- */
        .inventory-layout { 
            display: flex; 
            gap: 15px; 
            width: 100%; 
            max-width: 1200px; /* Aumentei para caber as 3 colunas */
            align-items: flex-start; 
        }

        .tables-column { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            min-width: 0; 
        }

        /* Classe gen√©rica para os pain√©is laterais (Muni√ß√£o e Carga) */
        .side-panel { 
            background: rgba(0, 0, 0, 0.6); 
            padding: 15px; 
            border: 2px solid #5d4037; 
            border-radius: 8px; 
            text-align: center; 
            width: 160px; /* Largura fixa para ficar bonito */
            flex-shrink: 0;
            position: sticky; 
            top: 80px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
        }

        .side-panel h3 { font-family: 'Rye'; color: #e6dccf; margin: 0 0 10px 0; letter-spacing: 1px; font-size: 1rem; }
        
        .space-display { font-family: 'Rye'; font-size: 2.2rem; color: #e6dccf; margin-bottom: 5px; }
        .space-display.over { color: #ff5555; }
        
        /* Inputs estilizados dos pain√©is */
        .panel-input { 
            width: 60px; text-align: center; font-family: 'Rye'; 
            font-size: 1.2rem; margin-top: 5px; 
            background: rgba(255,255,255,0.9); 
            border: 2px solid #5d4037; border-radius: 5px; 
        }

        /* Estilo da caixa de quantidade (Usos) */
        .qtd-wrapper {
            display: flex;
            align-items: center;
            background: rgba(255, 250, 240, 0.8);
            border: 1px solid #5d4037;
            border-radius: 4px;
            margin-left: 5px;
            padding: 0 5px;
            height: 34px; /* Mesma altura dos inputs */
        }

        .qtd-label {
            font-size: 0.7rem;
            font-weight: bold;
            color: #5d4037;
            margin-right: 2px;
            font-family: 'Courier Prime';
        }

        .qtd-input {
            width: 35px !important; /* For√ßa largura pequena */
            text-align: center;
            border: none !important;
            background: transparent !important;
            font-weight: bold;
            font-size: 1.1rem !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Ajuste para inputs do tipo number n√£o terem setinhas feias */
        .qtd-input::-webkit-inner-spin-button, 
        .qtd-input::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* RESPONSIVIDADE (MEDIA QUERIES) */
        
        /* 1. MUDAN√áA NA NAVBAR - Igual √† Montaria */
        @media (max-width: 1024px) {
            /* Layout principal do invent√°rio vira coluna */
            .inventory-layout { 
                flex-direction: column; 
                align-items: stretch; /* Estica para ocupar a largura */
                gap: 15px; 
            }

            /* A tabela vai para baixo */
            .tables-column { 
                width: 100%; 
                order: 3; 
            }
            
            /* M√°gica do Painel (Muni√ß√£o e Carga) */
            .side-panel, .space-panel { 
                width: 100%; /* Ocupa a largura toda */
                max-width: none; 
                margin: 0; 
                position: relative; 
                top: 0; 
                box-sizing: border-box; 
                display: grid;
                grid-template-columns: auto 1fr auto; 
                align-items: center;
                padding: 10px 15px;
                gap: 15px;
            }

            .side-panel h3, .space-panel h3 {
                font-size: 0.9rem;
                margin: 0;
                text-align: left;
                grid-column: 1; 
            }

            .side-panel select {
                width: 100px;
                font-size: 0.8rem;
                margin-top: 5px;
                display: block; 
            }

            .space-display {
                grid-column: 2; 
                font-size: 1.8rem;
                margin: 0;
                text-align: center;
                line-height: 1;
            }

            .panel-input, .space-max input {
                grid-column: 3; 
                width: 50px; 
                height: 40px; 
                margin: 0 !important; 
                font-size: 1rem;
            }

            .side-panel div[style*="font-size:0.7rem"],
            .space-panel div[style*="font-size:0.7rem"] {
                display: none !important;
            }
        }

        /* 2. RESPONSIVIDADE DA NAV IGUAL MONTARIA */
        @media (max-width: 768px) {
            .western-nav {
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px;
            }
            
            .western-nav a {
                font-size: 0.85rem;
                padding: 5px 8px;
            }

            .inventory-container { padding: 20px 5px; }
            .inventory-table { font-size: 0.95rem; }
            .section-header { font-size: 1rem; }
            .section-header.small { font-size: 0.8rem; }
        }

        @media (max-width: 480px) {
            .inventory-container { padding: 10px 2px; }
            .space-panel { padding: 10px; }
            .inventory-table { font-size: 0.9rem; }
            .section-header { font-size: 0.95rem; }
            .section-header.small { font-size: 0.7rem; }
            .space-display { font-size: 1.3rem; }
            
            /* Ajuste extra para a nav em telas muito pequenas */
            .western-nav a {
                font-size: 0.8rem;
                padding: 4px 6px;
            }
        }

        /* Tabelas com rolagem horizontal em telas pequenas */
        .tables-column { overflow-x: auto; }
        .inventory-table { min-width: 320px; }

        /* TABELAS */
        .inventory-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .section-header { font-family: 'Rye'; color: #fff; background: #222; padding: 10px; border-bottom: 2px solid #5d4037; font-size: 1.2rem; letter-spacing: 1px; text-shadow: 1px 1px 0 #000; }
        .section-header.small { font-size: 0.9rem; text-align: center; width: 80px; }
        .inventory-table td { background: rgba(220, 220, 220, 0.93); padding: 8px; border: 1px solid #000; }
        .inventory-table input { width: 100%; background: transparent; border: none; font-family: 'Courier Prime'; font-size: 1rem; outline: none; color: #1a1a1a; padding: 2px 4px; font-weight: bold; }
        .arma-name, .arma-dano, .arma-space {
            color: #222 !important;
            font-weight: bold !important;
            background: #fffbe8;
            border-radius: 3px;
        }
        
        /* DESCRI√á√ÉO */
        .col-expand { width: 30px; padding: 0 !important; text-align: center; background: #3e2723 !important; }
        .btn-expand { background: transparent; border: none; color: #fff; width: 100%; height: 100%; cursor: pointer; font-weight: bold; }
        .desc-row { display: none; }
        .desc-row.show { display: table-row; }
        .desc-row td { background: #fff8e1 !important; padding: 5px !important; }
        .desc-row textarea { width: 100%; min-height: 50px; border: none; background: transparent; font-family: 'Courier Prime'; resize: vertical; outline: none; }

        /* PAINEL CARGA */
        .space-panel { background: rgba(0, 0, 0, 0.6); padding: 20px; border: 2px solid #5d4037; border-radius: 8px; text-align: center; min-width: 150px; position: sticky; top: 80px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-left: 10px; }
        .space-panel h3 { font-family: 'Rye'; color: #e6dccf; margin: 0 0 10px 0; letter-spacing: 1px; }
        .space-display { font-family: 'Rye'; font-size: 2.5rem; color: #e6dccf; margin-bottom: 5px; }
        .space-display.over { color: #ff5555; }
        .space-max input { width: 60px; text-align: center; font-family: 'Rye'; font-size: 1.2rem; margin-top: 10px; background: rgba(255,255,255,0.9); border: 2px solid #5d4037; border-radius: 5px; }
        
        #status { position: fixed; bottom: 10px; right: 10px; color: #fff; opacity: 0.7; font-size: 0.8rem; z-index: 999; }

        /* MODAL DE NOVA ARMA */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }

        .modal-box { 
            background: url('assets/rock.jpg') center/cover, #2b1b12; 
            padding: 25px; 
            border: 4px solid #5d4037; 
            width: 95%; 
            max-width: 500px; 
            max-height: 90vh; /* N√£o deixa o modal ser maior que 90% da tela */
            overflow-y: auto; /* Adiciona scroll se o conte√∫do crescer */
            border-radius: 8px; 
            box-shadow: 0 0 50px rgba(0,0,0,1); 
            color: #e6dccf; /* Cor do texto para contraste */
        }

        .modal-box input, .modal-box select, .modal-box textarea {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #5d4037;
            font-family: 'Courier Prime';
            box-sizing: border-box; /* Essencial para o padding n√£o "empurrar" o input pra fora */
        }

        /* Estilo para a barra de rolagem do modal (estilo envelhecido) */
        .modal-box::-webkit-scrollbar {
            width: 8px;
        }
        .modal-box::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        .modal-box::-webkit-scrollbar-thumb {
            background: #5d4037;
            border-radius: 4px;
        }
        .modal-box h2 { font-family: 'Rye'; margin-top: 0; color: var(--ink); text-align: center; }

        .form-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; /* Faz os campos pularem de linha em telas muito pequenas */
        }

        .form-group { 
            display: flex; 
            flex-direction: column; 
            min-width: 120px; /* Evita que os campos fiquem esmagados */
            flex: 1; 
        }

        .form-group label {
            font-family: 'Rye';
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: #2b1b12; /* Marrom bem escuro (cor de tinta) */
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Corre√ß√£o do Checkbox */
        .food-wrapper {
            display: flex; 
            align-items: center; 
            gap: 4px; 
            margin-right: 8px;
            cursor: pointer;
            background: rgba(0,0,0,0.05);
            padding: 2px 5px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .food-wrapper:hover {
            border-color: #5d4037;
            background: rgba(0,0,0,0.1);
        }

        /* O texto "Alimento" */
        .food-label-text {
            font-size: 0.7rem;
            font-family: 'Rye';
            color: #5d4037;
            text-transform: uppercase;
        }

        /* For√ßa o checkbox a ter tamanho normal e n√£o 100% */
        .food-wrapper input[type="checkbox"] {
            width: auto !important; 
            margin: 0;
            cursor: pointer;
            transform: scale(1.1); /* Levemente maior, mas n√£o gigante */
        }

        /* Estilo da linha quando √© alimento */
        .row-alimento td {
            background-color: #ffe0b2 !important;
        }
    </style>
</head>

<body>

    <div class="modal-overlay" id="modal-arma">
        <div class="modal-box">
            <h2 id="modal-arma-titulo">NOVA ARMA</h2>
            <div class="form-group">
                <label>Nome da Arma</label>
                <input type="text" id="new-nome" placeholder="Ex: Colt Navy">
            </div>
            
            <div class="form-row" style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="form-group" style="flex:1">
                    <label>Tipo de Alcance</label>
                    <select id="new-alcance" onchange="toggleInputMunicao()" style="width:100%; padding:8px;">
                        <option value="distancia">üèπ Dist√¢ncia (Usa Muni√ß√£o)</option>
                        <option value="corpo">‚öîÔ∏è Corpo a Corpo</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1">
                    <label>Tipo de Dano</label>
                    <select id="new-tipo" style="width:100%; padding:8px;">
                        <option value="üíÄ Letal">üíÄ Letal</option>
                        <option value="üëä Dor">üëä Dor</option>
                    </select>
                </div>
            </div>

            <div class="form-row" style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="form-group" style="flex:1">
                    <label>Dano (Ex: 2d6)</label>
                    <input type="text" id="new-dano" value="1">
                </div>
                <div class="form-group" id="container-municao-max" style="flex:1">
                    <label>Muni√ß√£o Max</label>
                    <input type="number" id="new-balas" value="6">
                </div>
                <div class="form-group" style="flex:1">
                    <label>Peso (KG)</label>
                    <input type="number" id="new-espaco" value="1" step="0.5">
                </div>
            </div>

            <div class="form-group">
                <label>Efeito Especial / Descri√ß√£o</label>
                <textarea id="new-desc" rows="3" placeholder="Ex: Cr√≠tico 19-20..."></textarea>
            </div>
            
            <button class="btn-western" id="btn-confirmar-arma" onclick="confirmarNovaArma()" style="width:100%; padding:10px; font-family:'Rye'; font-size:1.1rem; background:#2e7d32; color:#fff; cursor:pointer; border:none; margin-top:10px;">CRIAR ARMA</button>
            <button class="btn-western btn-cancel" style="width:100%; padding:10px; font-family:'Rye'; font-size:1.1rem; background:#444; color:#fff; cursor:pointer; border:none; margin-top:5px;" onclick="fecharModalArma()">CANCELAR</button>
        </div>
    </div>

    <div id="tela-senha">
        <div class="password-box">
            <h2>üîí ACESSO RESTRITO</h2>
            <p>Ficha de <b id="nome-lock">...</b></p>
            <input type="password" id="pass-input" placeholder="Senha..." onkeypress="if(event.key==='Enter') tentarDesbloquear()">
            <button onclick="tentarDesbloquear()">ABRIR</button>
            <p id="pass-error" style="color:red; display:none; margin-top:10px;">Senha Incorreta!</p>
        </div>
        <script>document.getElementById('nome-lock').innerText = NOME_PERSONAGEM || '...';</script>
    </div>

    <nav class="western-nav">
        <a href="index.html">Ficha</a>
        <a href="habilidades.html">Habilidades</a>
        <a href="montaria.html">Montaria</a>
        <a href="inventario.html" class="active">Invent√°rio</a>
    </nav>

<div class="inventory-container">
    <div class="inventory-layout">

        <div class="side-panel">
            <h3>MUNI√á√ÉO</h3>
            
            <div style="text-align: left; font-size: 0.75rem; color: #e6dccf; margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; border: 1px solid #5d4037;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="check-bandoleira" onchange="atualizarLimiteBalas()" style="width: auto;"> Bandoleira (+12)
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="check-cinturao" onchange="atualizarLimiteBalas()" style="width: auto;"> Cintur√£o (+36)
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="check-aljava" onchange="atualizarLimiteBalas()" style="width: auto;"> Aljava (+10)
                </label>
            </div>

            <div class="space-display" id="ammo-display">0</div>
            <div id="ammo-label" style="color:#aaa; font-size:0.7rem; margin-bottom:5px;">CAPACIDADE TOTAL</div>
            
            <input type="number" id="ammo-qtd" class="panel-input" value="0" min="0" onchange="salvarMunicao()">
        </div>

        <div class="tables-column">
            
            <table class="inventory-table">
                <thead><tr><td class="section-header" colspan="2">ITENS GERAIS</td><td class="section-header" style="width:80px; text-align:center;">KG</td></tr></thead>
                <tbody id="items-body"></tbody>
            </table>

            <table class="inventory-table">
                <thead>
                    <tr>
                        <td class="section-header" colspan="2">ARSENAL</td>
                        <td class="section-header" style="width:100px; text-align:center;">EQUIPAR</td>
                    </tr>
                </thead>
                <tbody id="weapons-body"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="padding:10px;">
                            <button class="btn-western" onclick="abrirModalArma()" style="width:100%; padding:10px; font-family:'Rye'; font-size:1rem; background:#5d4037; color:#fff; cursor:pointer; border:none;">+ ADICIONAR ARMA</button>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="side-panel">
            <h3>CARGA</h3>
            <div class="space-display" id="space-current">0</div>
            <div style="color:#aaa; font-size:0.7rem; margin-bottom:5px;">KG / ESPA√áOS</div>
            <input type="number" id="space-max" class="panel-input" value="10" min="1" max="15" onchange="atualizarCargaMax()">
        </div>

    </div>
</div>

    <div id="status">Carregando...</div>

    <script>
            // ==========================================
            // 1. ESTADO E DADOS
            // ==========================================
            let itensData = [];
            let armasData = [];
            let editIndex = null;

            // ==========================================
            // 2. FUN√á√ïES DO MODAL (SIMPLIFICADAS)
            // ==========================================

           function abrirModalArma(index = null) {
                editIndex = index;
                const titulo = document.getElementById('modal-arma-titulo');
                const btn = document.getElementById('btn-confirmar-arma');

                if (index !== null) {
                    // MODO EDI√á√ÉO: Preenche os campos
                    const arma = armasData[index];
                    titulo.innerText = "EDITAR ARMA";
                    btn.innerText = "SALVAR ALTERA√á√ïES";
                    
                    document.getElementById('new-nome').value = arma.nome;
                    document.getElementById('new-dano').value = arma.dano;
                    document.getElementById('new-tipo').value = arma.tipo;
                    document.getElementById('new-alcance').value = arma.balasMax > 0 ? 'distancia' : 'corpo';
                    document.getElementById('new-balas').value = arma.balasMax;
                    document.getElementById('new-espaco').value = arma.espaco;
                    document.getElementById('new-desc').value = arma.descricao;
                } else {
                    // MODO CRIA√á√ÉO: Limpa os campos
                    titulo.innerText = "NOVA ARMA";
                    btn.innerText = "CRIAR ARMA";
                    resetarCamposModal();
                }

                toggleInputMunicao();
                document.getElementById('modal-arma').classList.add('show');
            }

            function resetarCamposModal() {
                document.getElementById('new-nome').value = '';
                document.getElementById('new-dano').value = '1';
                document.getElementById('new-desc').value = '';
                document.getElementById('new-balas').value = '6';
                document.getElementById('new-alcance').value = 'distancia';
            }
            
            function fecharModalArma() { 
                document.getElementById('modal-arma').classList.remove('show'); 
            }

            function toggleInputMunicao() {
                const tipoAlcance = document.getElementById('new-alcance').value;
                const containerMunicao = document.getElementById('container-municao-max');
                const inputBalas = document.getElementById('new-balas');
                
                if (tipoAlcance === 'distancia') {
                    containerMunicao.style.opacity = "1";
                    inputBalas.disabled = false;
                } else {
                    containerMunicao.style.opacity = "0.3";
                    inputBalas.disabled = true;
                    inputBalas.value = 0;
                }
            }

            // ==========================================
            // ATUALIZAR A FUN√á√ÉO: CONFIRMAR NOVA ARMA
            // ==========================================
            async function confirmarNovaArma() {
                const tipoAlcance = document.getElementById('new-alcance').value;
                const qtdBalas = parseInt(document.getElementById('new-balas').value) || 0;

                const armaEditada = {
                    nome: document.getElementById('new-nome').value || 'Arma Sem Nome',
                    dano: document.getElementById('new-dano').value,
                    tipo: document.getElementById('new-tipo').value,
                    balasMax: qtdBalas,
                    balasAtual: (editIndex !== null) ? armasData[editIndex].balasAtual : qtdBalas,
                    espaco: parseFloat(document.getElementById('new-espaco').value) || 1,
                    descricao: document.getElementById('new-desc').value,
                    equipado: (editIndex !== null) ? armasData[editIndex].equipado : false
                };

                if (editIndex !== null) {
                    armasData[editIndex] = armaEditada;
                } else {
                    armasData.push(armaEditada);
                }

                fecharModalArma();
                gerarTabelaArmas();
                await salvarFicha();
            }

            // ==========================================
            // 3. RENDERIZA√á√ÉO
            // ==========================================

            function gerarLinhasItens() {
                const maxEspaco = parseInt(document.getElementById('space-max').value) || 10;
                const tbody = document.getElementById('items-body');
                tbody.innerHTML = '';
                
                for(let i=0; i < maxEspaco; i++) {
                    // Agora inicializamos 'usos' com 1 por padr√£o
                    if(!itensData[i]) itensData[i] = { nome: '', espaco: 0, descricao: '', alimento: false, usos: 1 };
                    const dados = itensData[i];

                    const tr = document.createElement('tr');
                    tr.className = dados.alimento ? 'item-row row-alimento' : 'item-row';
                    
                    // HTML da linha
                    let htmlMeio = `
                        <td style="display: flex; align-items: center;">
                            <label class="food-wrapper" title="Marcar como item consum√≠vel">
                                <input type="checkbox" 
                                    ${dados.alimento ? 'checked' : ''} 
                                    onchange="atualizarItem(${i}, 'alimento', this.checked)">
                                <span class="food-label-text">Alimento</span>
                            </label>

                            <span style="font-size: 1.2rem; margin-right: 5px; display: ${dados.alimento ? 'block' : 'none'}">üçó</span>
                            
                            <input type="text" value="${escapeHtml(dados.nome)}" placeholder="..." onchange="atualizarItem(${i}, 'nome', this.value)" style="flex:1;">
                    `;

                    // SE FOR ALIMENTO, ADICIONA O CAMPO DE USOS
                    if (dados.alimento) {
                        htmlMeio += `
                            <div class="qtd-wrapper" title="Quantidade / Usos">
                                <span class="qtd-label">QTD:</span>
                                <input type="number" class="qtd-input" 
                                    value="${dados.usos || 1}" 
                                    min="1" 
                                    onchange="atualizarItem(${i}, 'usos', this.value)">
                            </div>
                        `;
                    }

                    htmlMeio += `</td>`;

                    tr.innerHTML = `
                        <td class="col-expand"><button class="btn-expand" onclick="toggleDescricao(this, 'desc-item-${i}')">‚ñº</button></td>
                        ${htmlMeio}
                        <td class="col-espaco"><input type="number" value="${dados.espaco}" step="0.5" onchange="atualizarItem(${i}, 'espaco', this.value)"></td>
                    `;
                    
                    tbody.appendChild(tr);
                    
                    // Linha de descri√ß√£o
                    const trDesc = document.createElement('tr');
                    trDesc.className = dados.alimento ? 'desc-row row-alimento' : 'desc-row';
                    trDesc.id = `desc-item-${i}`;
                    trDesc.innerHTML = `<td colspan="3"><textarea placeholder="Descri√ß√£o..." onchange="atualizarItem(${i}, 'descricao', this.value)">${escapeHtml(dados.descricao)}</textarea></td>`;
                    tbody.appendChild(trDesc);
                }
                calcularCarga();
            }

            function gerarTabelaArmas() {
                const tbody = document.getElementById('weapons-body');
                tbody.innerHTML = '';

                armasData.forEach((arma, index) => {
                    const tr = document.createElement('tr');
                    const bg = arma.equipado ? 'rgba(46, 125, 50, 0.2)' : 'transparent';
                    tr.style.background = bg;

                    const textoMunicao = arma.balasMax > 0 
                        ? `(${arma.balasAtual}/${arma.balasMax} üí•)` 
                        : '(Corpo-a-Corpo ‚öîÔ∏è)';

                    tr.innerHTML = `
                        <td colspan="2" style="padding:10px;">
                            <div style="font-family:'Rye'; color:#2b1b12; font-size:1.3rem;">
                                ${escapeHtml(arma.nome)} 
                                <span style="font-size:0.85rem; font-family:'Courier Prime'; color:#8d6e63; font-weight:bold;">
                                    ${textoMunicao}
                                </span>
                            </div>
                            <div style="font-size:0.9rem; color:#3e2723; margin-top:4px;">
                                Dano: <b>${arma.dano}</b> [${arma.tipo}] | ${escapeHtml(arma.descricao)}
                            </div>
                            <div style="margin-top:8px;">
                                <button onclick="abrirModalArma(${index})" style="font-size:0.75rem; color:#2e7d32; background:none; border:none; cursor:pointer; font-weight:bold; margin-right:10px;">[‚úé] Editar</button>
                                <button onclick="removerArma(${index})" style="font-size:0.75rem; color:#c62828; background:none; border:none; cursor:pointer; font-weight:bold;">[X] Descartar</button>
                            </div>
                        </td>
                        <td style="vertical-align:middle; text-align:center;">
                            <button class="btn-equipar ${arma.equipado ? 'equipado' : ''}" onclick="toggleEquipar(${index})" style="padding:5px; font-family:'Rye'; background:${arma.equipado ? '#2e7d32' : '#5d4037'}; color:#fff; border:none; cursor:pointer;">
                                ${arma.equipado ? 'EQUIPADO' : 'EQUIPAR'}
                            </button>
                            <div style="font-size:0.9rem; margin-top:5px; color:#3e2723; font-weight:bold;">
                                ${arma.equipado ? `<s style="opacity:0.5">${arma.espaco} KG</s> (0)` : `${arma.espaco} KG`}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                calcularCarga();
            }

            // ==========================================
            // 4. ATUALIZA√á√ÉO DE DADOS (Handlers)
            // ==========================================

            function atualizarItem(index, campo, valor) {
                if(!itensData[index]) itensData[index] = {};
                
                // L√≥gica para salvar o tipo correto de dado
                if (campo === 'espaco') {
                    itensData[index][campo] = parseFloat(valor);
                } else if (campo === 'usos') {
                    // Garante que usos seja pelo menos 1
                    let qtd = parseInt(valor);
                    if (qtd < 1 || isNaN(qtd)) qtd = 1;
                    itensData[index][campo] = qtd;
                } else {
                    itensData[index][campo] = valor;
                }
                
                // Se mudou o checkbox de alimento, redesenha para mostrar/esconder o campo QTD
                if (campo === 'alimento') {
                    // Se marcou como alimento, garante que usos comece em 1
                    if (valor === true && !itensData[index].usos) {
                        itensData[index].usos = 1;
                    }
                    gerarLinhasItens(); 
                }
                
                calcularCarga();
                salvarFicha();
            }

            function toggleEquipar(index) {
                const arma = armasData[index];

                // Se a arma j√° est√° equipada, apenas desequipa (sem restri√ß√£o)
                if (arma.equipado) {
                    arma.equipado = false;
                } else {
                    // Se quer equipar, verifica quantas j√° est√£o equipadas
                    const quantasEquipadas = armasData.filter(a => a.equipado).length;
                    
                    if (quantasEquipadas >= 2) {
                        alert("‚ö†Ô∏è Voc√™ s√≥ tem duas m√£os! Desequipe uma arma antes.");
                        return; // Para a fun√ß√£o aqui, n√£o equipa
                    }
                    
                    // Se passou na verifica√ß√£o, equipa
                    arma.equipado = true;
                }

                // Atualiza a tela e salva
                gerarTabelaArmas();
                salvarFicha();
            }

            function removerArma(index) {
                if(confirm('Tem certeza que quer jogar essa arma fora?')) {
                    armasData.splice(index, 1);
                    gerarTabelaArmas();
                    salvarFicha();
                }
            }

            // --- VARI√ÅVEIS GLOBAIS ---
            let municaoData = {
                equipados: { bandoleira: false, cinturao: false, aljava: false },
                qtd: 0
            };

            // --- FUN√á√ïES DE MUNI√á√ÉO ---
            function atualizarLimiteBalas() {
                const bando = document.getElementById('check-bandoleira').checked;
                const cinto = document.getElementById('check-cinturao').checked;
                const aljava = document.getElementById('check-aljava').checked;
                const input = document.getElementById('ammo-qtd');

                // Calcula o limite total somando os recipientes marcados
                let maxTotal = 0;
                if (bando) maxTotal += 12;
                if (cinto) maxTotal += 36;
                if (aljava) maxTotal += 10;

                // Se nada estiver equipado, o limite √© 0 (ou voc√™ pode definir um m√≠nimo de "bolso")
                input.max = maxTotal;

                // Se a muni√ß√£o atual estourar o novo limite, reduzimos para o m√°ximo
                if (parseInt(input.value) > maxTotal) {
                    input.value = maxTotal;
                }

                // Atualiza o display visual
                document.getElementById('ammo-display').innerText = input.value;
                
                // Atualiza o objeto global para salvar
                municaoData.equipados = { bandoleira: bando, cinturao: cinto, aljava: aljava };
                municaoData.qtd = parseInt(input.value);

                salvarFicha();
            }

            function salvarMunicao() {
                const input = document.getElementById('ammo-qtd');
                let val = parseInt(input.value) || 0;
                const max = parseInt(input.max) || 0;

                if (val > max) val = max;
                if (val < 0) val = 0;

                input.value = val;
                document.getElementById('ammo-display').innerText = val;
                municaoData.qtd = val;
                salvarFicha();
            }

            function calcularCarga() {
                let total = 0;

                // Soma o peso de todos os itens gerais
                itensData.forEach(i => total += (parseFloat(i?.espaco) || 0));

                // Soma o peso APENAS das armas que N√ÉO est√£o equipadas
                armasData.forEach(a => {
                    if (!a.equipado) { // <--- A MUDAN√áA EST√Å AQUI
                        total += (parseFloat(a.espaco) || 0);
                    }
                });
                
                const max = parseInt(document.getElementById('space-max').value) || 10;
                const el = document.getElementById('space-current');
                
                // Arredonda para evitar problemas com decimais (ex: 1.00000002)
                total = Math.round(total * 100) / 100;

                el.innerText = total;
                el.className = total > max ? 'space-display over' : 'space-display';
            }

            function toggleDescricao(btn, descRowId) {
                const descRow = document.getElementById(descRowId);
                descRow.classList.toggle('show');
                btn.classList.toggle('expanded');
                btn.textContent = descRow.classList.contains('show') ? '‚ñ≤' : '‚ñº';
            }

            function escapeHtml(text) {
                if (!text) return '';
                return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
            }

            // ==========================================
            // 5. SUPABASE (Salvar e Carregar)
            // ==========================================

            async function salvarFicha() {
                const status = document.getElementById('status');
                status.innerText = 'Salvando...';
                
                // 1. Pega dados atuais para n√£o sobrescrever
                const { data: current } = await client.from('Fichas').select('atributos').eq('nome_personagem', NOME_PERSONAGEM).single();
                let payload = current ? current.atributos : {};
                
                // 2. Monta o objeto de invent√°rio
                payload.inventario = {
                    items: itensData,
                    weapons: armasData,
                    maxLoad: document.getElementById('space-max').value,
                    municao: municaoData
                };

                // 3. Envia
                const { error } = await client.from('Fichas').update({ atributos: payload }).eq('nome_personagem', NOME_PERSONAGEM);
                
                if(!error) {
                    status.innerText = '‚Ä¢ Salvo ‚Ä¢';
                    setTimeout(() => status.innerText = '', 2000);
                } else {
                    console.error(error);
                    status.innerText = 'Erro ao salvar!';
                }
            }

            async function carregar() {
                const status = document.getElementById('status');
                status.innerText = 'Carregando...';
                
                const { data } = await client.from('Fichas').select('atributos').eq('nome_personagem', NOME_PERSONAGEM).single();

                if (data && data.atributos && data.atributos.inventario) {
                    const inv = data.atributos.inventario;
                    itensData = inv.items || [];
                    armasData = inv.weapons || []; // Garante que l√™ as armas do banco
                    document.getElementById('space-max').value = inv.maxLoad || 10;
                }

                // Dentro da fun√ß√£o carregar(), localize a parte da muni√ß√£o e substitua:
                if (data.atributos.inventario.municao) {
                    municaoData = data.atributos.inventario.municao;
                    
                    // Seta o estado dos checkboxes
                    document.getElementById('check-bandoleira').checked = !!municaoData.equipados?.bandoleira;
                    document.getElementById('check-cinturao').checked = !!municaoData.equipados?.cinturao;
                    document.getElementById('check-aljava').checked = !!municaoData.equipados?.aljava;
                    
                    document.getElementById('ammo-qtd').value = municaoData.qtd || 0;
                    
                    // Roda a l√≥gica para definir o input.max corretamente
                    atualizarLimiteBalas(); 
                }
                
                gerarLinhasItens();
                gerarTabelaArmas();
                status.innerText = 'Pronto';
            }

            function atualizarCargaMax() {
                const input = document.getElementById('space-max');
                let valor = parseInt(input.value);

                // TRAVA DE SEGURAN√áA: Limite m√°ximo de 15
                if (valor > 15) {
                    alert("‚ö†Ô∏è O limite m√°ximo de invent√°rio √© 15 espa√ßos.");
                    valor = 15;
                    input.value = 15;
                }

                // Impede valores negativos ou zero
                if (valor < 1 || isNaN(valor)) {
                    valor = 1;
                    input.value = 1;
                }

                // 1. Redesenha as linhas da tabela (agora com o limite aplicado)
                gerarLinhasItens(); 
                
                // 2. Recalcula o peso total visualmente
                calcularCarga(); 
                
                // 3. Salva no banco de dados
                salvarFicha(); 
            }

            // Inicializa√ß√£o
            carregar();


        // Realtime
        client.channel('inv-room').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'Fichas' }, 
        (payload) => {
            // Opcional: Atualizar se o mestre mudar algo
        }).subscribe();

    </script>

    <script>
        const paramsURL = new URLSearchParams(window.location.search);
        const nomeAtual = paramsURL.get('nome');
        if (nomeAtual) {
            document.querySelectorAll('a').forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('http') && !href.includes('?')) {
                    link.setAttribute('href', `${href}?nome=${nomeAtual}`);
                }
            });
        }
    </script>

</body>
</html>