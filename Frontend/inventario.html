<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Invent√°rio ‚Äî A √öltima Dose</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <script>
        // CONFIGURA√á√ÉO DE SENHAS
        const SENHAS = {
            'Trinity': 'trinity123',
            'Josue': 'pantufa',
            'Morpheus': 'pilula'
        };

        // VERIFICA√á√ÉO DE LOGIN
        function checkAuth() {
            if (!SENHAS[NOME_PERSONAGEM]) return true;
            const authKey = `auth_${NOME_PERSONAGEM}`;
            const authData = JSON.parse(localStorage.getItem(authKey));
            if (authData && (Date.now() - authData.time < 86400000)) return true;
            return false;
        }

        // BLOQUEIA IMEDIATAMENTE SE PRECISAR
        if (!checkAuth()) {
            document.documentElement.classList.add('locked');
        }

        function tentarDesbloquear() {
            const input = document.getElementById('pass-input');
            if (input.value === SENHAS[NOME_PERSONAGEM]) {
                localStorage.setItem(`auth_${NOME_PERSONAGEM}`, JSON.stringify({ time: Date.now() }));
                document.documentElement.classList.remove('locked');
                document.getElementById('tela-senha').style.display = 'none';
            } else {
                document.getElementById('pass-error').style.display = 'block';
                input.value = '';
            }
        }

        // FUN√á√ÉO DEBOUNCE (PARA N√ÉO TRAVAR O BANCO)
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // VARIAVEL GLOBAL PARA O SALVAMENTO COM ATRASO
        // Ser√° definida corretamente l√° embaixo, quando a fun√ß√£o salvarFicha existir
        var acionarSalvarComDelay; 
    </script>

    <style>
        /* CSS DE BLOQUEIO */
        html.locked body > *:not(#tela-senha) { display: none !important; }
        html.locked body { background: #1a1411; overflow: hidden; }
        #tela-senha { display: none; }
        html.locked #tela-senha { display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1411; z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }

        /* ESTILOS GERAIS */
        :root { --ink: #2b1b12; --gold: #ffcc80; --bg-dark: #1a1411; }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; min-height: 100vh; font-family: 'Courier Prime', monospace; background: var(--bg-dark); }
        
        /* BACKGROUND */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url("assets/inventario/backgroundinv.png") no-repeat center;
            background-size: cover; filter: brightness(0.7); z-index: -1;
        }

        /* TELA SENHA */
        .password-box { background:url('assets/locked.jpg') center center/contain no-repeat, #1a1411; padding:40px; border:5px solid #2b1b12; text-align:center; max-width:400px; border-radius:8px; }
        .password-box h2 { font-family: 'Rye'; margin: 0 0 10px 0; color: var(--ink); }
        .password-box input { width: 100%; padding: 10px; margin-bottom: 15px; font-family: 'Courier Prime'; font-size: 1.2rem; text-align: center; }
        .password-box button { width: 100%; padding: 10px; font-family: 'Rye'; font-size: 1.1rem; background: #5d4037; color: #fff; cursor: pointer; border: none; }

        /* LAYOUT */
        .western-nav { display: flex; justify-content: center; gap: 15px; padding: 15px; background: rgba(43, 27, 18, 0.95); border-bottom: 2px solid #5d4037; width: 100%; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .western-nav a { color: #aaa; text-decoration: none; font-family: 'Rye'; font-size: 1rem; padding: 5px 10px; border: 1px solid transparent; text-transform: uppercase; transition: 0.2s; }
        .western-nav a:hover, .western-nav a.active { color: var(--gold); border-color: var(--gold); }

        .inventory-container { padding: 40px 20px; display: flex; justify-content: center; }
        .inventory-layout { display: flex; gap: 20px; width: 100%; max-width: 1000px; align-items: flex-start; }
        .tables-column { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 0; }

        /* --- LAYOUT DE 3 COLUNAS --- */
        .inventory-layout { 
            display: flex; 
            gap: 15px; 
            width: 100%; 
            max-width: 1200px; /* Aumentei para caber as 3 colunas */
            align-items: flex-start; 
        }

        .tables-column { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            min-width: 0; 
        }

        /* Classe gen√©rica para os pain√©is laterais (Muni√ß√£o e Carga) */
        .side-panel { 
            background: rgba(0, 0, 0, 0.6); 
            padding: 15px; 
            border: 2px solid #5d4037; 
            border-radius: 8px; 
            text-align: center; 
            width: 160px; /* Largura fixa para ficar bonito */
            flex-shrink: 0;
            position: sticky; 
            top: 80px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
        }

        .side-panel h3 { font-family: 'Rye'; color: #e6dccf; margin: 0 0 10px 0; letter-spacing: 1px; font-size: 1rem; }
        
        .space-display { font-family: 'Rye'; font-size: 2.2rem; color: #e6dccf; margin-bottom: 5px; }
        .space-display.over { color: #ff5555; }
        
        /* Inputs estilizados dos pain√©is */
        .panel-input { 
            width: 60px; text-align: center; font-family: 'Rye'; 
            font-size: 1.2rem; margin-top: 5px; 
            background: rgba(255,255,255,0.9); 
            border: 2px solid #5d4037; border-radius: 5px; 
        }

        /* RESPONSIVIDADE */
        @media (max-width: 1024px) {
            .inventory-layout { flex-direction: column; align-items: center; }
            .tables-column { width: 100%; order: 3; } /* Tabela vai pro fim no celular */
            
            /* No celular, os pain√©is ficam um ao lado do outro em cima */
            .side-panel { 
                width: 90%; 
                max-width: 400px;
                position: relative; 
                top: 0; 
                margin-bottom: 10px;
                display: flex;
                flex-direction: row; /* Deita o painel no mobile */
                justify-content: space-around;
                align-items: center;
            }
            .side-panel h3 { margin: 0; margin-right: 10px; }
        }

        /* MODAL DE NOVA ARMA */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: url('assets/rock.jpg') center/cover; padding: 30px; border: 4px solid #5d4037; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .modal-box h2 { font-family: 'Rye'; margin-top: 0; color: var(--ink); text-align: center; }

        /* Responsividade: mobile e tablets */
        @media (max-width: 1024px) {
            .inventory-layout { flex-direction: column; align-items: center; gap: 0; }
            .tables-column { width: 100%; max-width: 750px; }
            .space-panel { position: relative; top: 0; width: 100%; max-width: 750px; margin-bottom: 20px; }
        }
        @media (max-width: 768px) {
            .inventory-container { padding: 20px 5px; }
            .inventory-layout { flex-direction: column; align-items: stretch; gap: 0; }
            .tables-column { width: 100%; max-width: 100%; }
            .space-panel { width: 100%; min-width: unset; max-width: 100%; margin-bottom: 20px; }
            .inventory-table { font-size: 0.95rem; }
            .section-header { font-size: 1rem; }
            .section-header.small { font-size: 0.8rem; }
            .space-display { font-size: 2rem; }
        }
        @media (max-width: 480px) {
            .inventory-container { padding: 10px 2px; }
            .space-panel { padding: 10px; }
            .inventory-table { font-size: 0.9rem; }
            .section-header { font-size: 0.95rem; }
            .section-header.small { font-size: 0.7rem; }
            .space-display { font-size: 1.3rem; }
        }

        /* Tabelas com rolagem horizontal em telas pequenas */
        .tables-column { overflow-x: auto; }
        .inventory-table { min-width: 320px; }

        /* TABELAS */
        .inventory-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .section-header { font-family: 'Rye'; color: #fff; background: #222; padding: 10px; border-bottom: 2px solid #5d4037; font-size: 1.2rem; letter-spacing: 1px; text-shadow: 1px 1px 0 #000; }
        .section-header.small { font-size: 0.9rem; text-align: center; width: 80px; }
        .inventory-table td { background: rgba(220, 220, 220, 0.93); padding: 8px; border: 1px solid #000; }
        .inventory-table input { width: 100%; background: transparent; border: none; font-family: 'Courier Prime'; font-size: 1rem; outline: none; color: #1a1a1a; padding: 2px 4px; font-weight: bold; }
        .arma-name, .arma-dano, .arma-space {
            color: #222 !important;
            font-weight: bold !important;
            background: #fffbe8;
            border-radius: 3px;
        }
        
        /* DESCRI√á√ÉO */
        .col-expand { width: 30px; padding: 0 !important; text-align: center; background: #3e2723 !important; }
        .btn-expand { background: transparent; border: none; color: #fff; width: 100%; height: 100%; cursor: pointer; font-weight: bold; }
        .desc-row { display: none; }
        .desc-row.show { display: table-row; }
        .desc-row td { background: #fff8e1 !important; padding: 5px !important; }
        .desc-row textarea { width: 100%; min-height: 50px; border: none; background: transparent; font-family: 'Courier Prime'; resize: vertical; outline: none; }

        /* PAINEL CARGA */
        .space-panel { background: rgba(0, 0, 0, 0.6); padding: 20px; border: 2px solid #5d4037; border-radius: 8px; text-align: center; min-width: 150px; position: sticky; top: 80px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-left: 10px; }
        .space-panel h3 { font-family: 'Rye'; color: #e6dccf; margin: 0 0 10px 0; letter-spacing: 1px; }
        .space-display { font-family: 'Rye'; font-size: 2.5rem; color: #e6dccf; margin-bottom: 5px; }
        .space-display.over { color: #ff5555; }
        .space-max input { width: 60px; text-align: center; font-family: 'Rye'; font-size: 1.2rem; margin-top: 10px; background: rgba(255,255,255,0.9); border: 2px solid #5d4037; border-radius: 5px; }
        
        #status { position: fixed; bottom: 10px; right: 10px; color: #fff; opacity: 0.7; font-size: 0.8rem; z-index: 999; }

        @media (max-width: 768px) { .inventory-layout { flex-direction: column-reverse; align-items: center; } .space-panel { width: 100%; position: relative; top: 0; } }
    </style>
</head>

<body>

    <div class="modal-overlay" id="modal-arma">
        <div class="modal-box">
            <h2>NOVA ARMA</h2>
            <div class="form-group">
                <label>Nome da Arma</label>
                <input type="text" id="new-nome" placeholder="Ex: Colt Navy">
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:1">
                    <label>Dano</label>
                    <input type="number" id="new-dano" value="1">
                </div>
                <div class="form-group" style="flex:1">
                    <label>Tipo</label>
                    <select id="new-tipo">
                        <option value="üíÄ Letal">üíÄ Letal</option>
                        <option value="üëä Dor">üëä Dor</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:1">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label for="new-balas">Muni√ß√£o Max</label>
                        <input type="checkbox" id="check-usa-municao" checked onchange="toggleInputMunicao()" style="width:auto; transform: scale(1.2);">
                    </div>
                    <input type="number" id="new-balas" value="6">
                </div>

                <div class="form-group" style="flex:1">
                    <label>Espa√ßo (KG)</label>
                    <input type="number" id="new-espaco" value="1" step="0.5">
                </div>
            </div>
            <div class="form-group">
                <label>Efeito Especial / Descri√ß√£o</label>
                <textarea id="new-desc" rows="3" placeholder="Ex: Pode atirar duas vezes..."></textarea>
            </div>
            <button class="btn-western" onclick="confirmarNovaArma()">CRIAR ARMA</button>
            <button class="btn-western btn-cancel" onclick="fecharModalArma()">CANCELAR</button>
        </div>
    </div>

    <div id="tela-senha">
        <div class="password-box">
            <h2>üîí ACESSO RESTRITO</h2>
            <p>Ficha de <b id="nome-lock">...</b></p>
            <input type="password" id="pass-input" placeholder="Senha..." onkeypress="if(event.key==='Enter') tentarDesbloquear()">
            <button onclick="tentarDesbloquear()">ABRIR</button>
            <p id="pass-error" style="color:red; display:none; margin-top:10px;">Senha Incorreta!</p>
        </div>
        <script>document.getElementById('nome-lock').innerText = NOME_PERSONAGEM || '...';</script>
    </div>

    <nav class="western-nav">
        <a href="index.html">Ficha</a>
        <a href="habilidades.html">Habilidades</a>
        <a href="montaria.html">Montaria</a>
        <a href="inventario.html" class="active">Invent√°rio</a>
    </nav>

<div class="inventory-container">
    <div class="inventory-layout">

        <div class="side-panel">
            <h3>MUNI√á√ÉO</h3>
            
            <select id="ammo-type" onchange="atualizarLimiteBalas()" style="width:100%; background:rgba(0,0,0,0.3); color:#e6dccf; border:1px solid #5d4037; font-family:'Courier Prime'; margin-bottom:5px; font-size:0.8rem;">
                <option value="bandoleira">Bandoleira</option>
                <option value="cinturao">Cintur√£o</option>
                <option value="aljava">Aljava</option>
            </select>

            <div class="space-display" id="ammo-display">0</div>
            
            <div style="color:#aaa; font-size:0.7rem; margin-bottom:5px;">BALAS NO CINTO</div>
            
            <input type="number" id="ammo-qtd" class="panel-input" value="0" min="0" onchange="salvarMunicao()">
        </div>

        <div class="tables-column">
            
            <table class="inventory-table">
                <thead><tr><td class="section-header" colspan="2">ITENS GERAIS</td><td class="section-header" style="width:80px; text-align:center;">KG</td></tr></thead>
                <tbody id="items-body"></tbody>
            </table>

            <table class="inventory-table">
                <thead>
                    <tr>
                        <td class="section-header" colspan="2">ARSENAL</td>
                        <td class="section-header" style="width:100px; text-align:center;">EQUIPAR</td>
                    </tr>
                </thead>
                <tbody id="weapons-body"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="padding:10px;">
                            <button class="btn-western" onclick="abrirModalArma()">+ ADICIONAR ARMA</button>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="side-panel">
            <h3>CARGA</h3>
            <div class="space-display" id="space-current">0</div>
            <div style="color:#aaa; font-size:0.7rem; margin-bottom:5px;">KG / ESPA√áOS</div>
            <input type="number" id="space-max" class="panel-input" value="10" onchange="salvarFicha()">
        </div>

    </div>
</div>

    <div id="status">Carregando...</div>

    <script>
            // ==========================================
            // 1. ESTADO E DADOS
            // ==========================================
            let itensData = [];
            let armasData = [];

            // ==========================================
            // 2. FUN√á√ïES DO MODAL (SIMPLIFICADAS)
            // ==========================================
            function abrirModalArma() { 
                document.getElementById('modal-arma').classList.add('show'); 
            }
            
            function fecharModalArma() { 
                document.getElementById('modal-arma').classList.remove('show'); 
            }

            function toggleInputMunicao() {
                const checkbox = document.getElementById('check-usa-municao');
                const inputBalas = document.getElementById('new-balas');
                
                if (checkbox.checked) {
                    inputBalas.disabled = false;
                    inputBalas.style.opacity = "1";
                    if(inputBalas.value == 0) inputBalas.value = 6; // Restaura um valor padr√£o se estiver zerado
                } else {
                    inputBalas.disabled = true;
                    inputBalas.style.opacity = "0.3";
                    inputBalas.value = 0; // Zera visualmente
                }
            }

            // ==========================================
            // ATUALIZAR A FUN√á√ÉO: CONFIRMAR NOVA ARMA
            // ==========================================
            async function confirmarNovaArma() {
                const usaMunicao = document.getElementById('check-usa-municao').checked;
                
                // Se a checkbox estiver marcada, pega o valor do input. Se n√£o, √© 0.
                const qtdBalas = usaMunicao ? (parseInt(document.getElementById('new-balas').value) || 0) : 0;

                // Cria o objeto da arma
                const novaArma = {
                    nome: document.getElementById('new-nome').value || 'Arma Sem Nome',
                    dano: parseInt(document.getElementById('new-dano').value) || 1,
                    tipo: document.getElementById('new-tipo').value,
                    balasMax: qtdBalas,
                    balasAtual: qtdBalas, // J√° come√ßa carregada ou com 0 se n√£o usar muni√ß√£o
                    espaco: parseFloat(document.getElementById('new-espaco').value) || 1,
                    descricao: document.getElementById('new-desc').value,
                    equipado: false
                };

                // 1. Atualiza mem√≥ria
                armasData.push(novaArma);
                
                // 2. Fecha modal
                fecharModalArma();
                
                // 3. Atualiza tela e salva
                gerarTabelaArmas();
                await salvarFicha();
                
                // 4. Limpa campos e reseta o checkbox
                document.getElementById('new-nome').value = '';
                document.getElementById('new-desc').value = '';
                
                // Reseta o estado da muni√ß√£o para o pr√≥ximo uso
                document.getElementById('check-usa-municao').checked = true;
                toggleInputMunicao(); // Garante que o input volta a ficar habilitado
            }

            // ==========================================
            // 3. RENDERIZA√á√ÉO
            // ==========================================

            function gerarLinhasItens() {
                const maxEspaco = parseInt(document.getElementById('space-max').value) || 10;
                const tbody = document.getElementById('items-body');
                tbody.innerHTML = '';
                
                for(let i=0; i<maxEspaco; i++) {
                    // Se n√£o existir, cria objeto vazio na mem√≥ria
                    if(!itensData[i]) itensData[i] = { nome: '', espaco: 0, descricao: '' };
                    const dados = itensData[i];

                    const tr = document.createElement('tr');
                    tr.className = 'item-row';
                    // Note o onchange chamando 'atualizarItem'
                    tr.innerHTML = `
                        <td class="col-expand"><button class="btn-expand" onclick="toggleDescricao(this, 'desc-item-${i}')">‚ñº</button></td>
                        <td><input type="text" value="${escapeHtml(dados.nome)}" placeholder="..." onchange="atualizarItem(${i}, 'nome', this.value)"></td>
                        <td class="col-espaco"><input type="number" value="${dados.espaco}" step="0.5" onchange="atualizarItem(${i}, 'espaco', this.value)"></td>
                    `;
                    tbody.appendChild(tr);
                    
                    const trDesc = document.createElement('tr');
                    trDesc.className = 'desc-row';
                    trDesc.id = `desc-item-${i}`;
                    trDesc.innerHTML = `<td colspan="3"><textarea placeholder="Descri√ß√£o..." onchange="atualizarItem(${i}, 'descricao', this.value)">${escapeHtml(dados.descricao)}</textarea></td>`;
                    tbody.appendChild(trDesc);
                }
                calcularCarga();
            }

            function gerarTabelaArmas() {
                const tbody = document.getElementById('weapons-body');
                tbody.innerHTML = '';

                armasData.forEach((arma, index) => {
                    const tr = document.createElement('tr');
                    
                    // Mant√©m o verde bem suave se estiver equipado
                    const bg = arma.equipado ? 'rgba(46, 125, 50, 0.2)' : 'transparent';
                    tr.style.background = bg;

                    // Verifica muni√ß√£o
                    const textoMunicao = arma.balasMax > 0 
                        ? `(${arma.balasAtual}/${arma.balasMax} üí•)` 
                        : '(Corpo-a-Corpo ‚öîÔ∏è)';

                    tr.innerHTML = `
                        <td colspan="2" style="padding:10px;">
                            <div style="font-family:'Rye'; color:#2b1b12; font-size:1.3rem; text-shadow: 0px 0px 1px rgba(0,0,0,0.1);">
                                ${escapeHtml(arma.nome)} 
                                
                                <span style="font-size:0.85rem; font-family:'Courier Prime'; color:#8d6e63; font-weight:bold;">
                                    ${textoMunicao}
                                </span>
                            </div>

                            <div style="font-size:0.9rem; color:#3e2723; margin-top:4px; font-weight: 600;">
                                Dano: <b>${arma.dano}</b> [${arma.tipo}] | ${escapeHtml(arma.descricao)}
                            </div>

                            <button onclick="removerArma(${index})" style="font-size:0.75rem; color:#c62828; background:none; border:none; cursor:pointer; margin-top:8px; font-weight:bold;">[X] Descartar</button>
                        </td>
                        <td style="vertical-align:middle; text-align:center;">
                            <button class="btn-equipar ${arma.equipado ? 'equipado' : ''}" onclick="toggleEquipar(${index})">
                                ${arma.equipado ? 'EQUIPADO' : 'EQUIPAR'}
                            </button>
                            <div style="font-size:0.9rem; margin-top:5px; color:#3e2723; font-weight:bold;">${arma.espaco} KG</div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                calcularCarga();
            }

            // ==========================================
            // 4. ATUALIZA√á√ÉO DE DADOS (Handlers)
            // ==========================================

            function atualizarItem(index, campo, valor) {
                if(!itensData[index]) itensData[index] = {};
                itensData[index][campo] = campo === 'espaco' ? parseFloat(valor) : valor;
                calcularCarga();
                salvarFicha();
            }

            function toggleEquipar(index) {
                const arma = armasData[index];

                // Se a arma j√° est√° equipada, apenas desequipa (sem restri√ß√£o)
                if (arma.equipado) {
                    arma.equipado = false;
                } else {
                    // Se quer equipar, verifica quantas j√° est√£o equipadas
                    const quantasEquipadas = armasData.filter(a => a.equipado).length;
                    
                    if (quantasEquipadas >= 2) {
                        alert("‚ö†Ô∏è Voc√™ s√≥ tem duas m√£os! Desequipe uma arma antes.");
                        return; // Para a fun√ß√£o aqui, n√£o equipa
                    }
                    
                    // Se passou na verifica√ß√£o, equipa
                    arma.equipado = true;
                }

                // Atualiza a tela e salva
                gerarTabelaArmas();
                salvarFicha();
            }

            function removerArma(index) {
                if(confirm('Tem certeza que quer jogar essa arma fora?')) {
                    armasData.splice(index, 1);
                    gerarTabelaArmas();
                    salvarFicha();
                }
            }

            // --- VARI√ÅVEIS GLOBAIS ---
            let municaoData = { tipo: 'bandoleira', qtd: 0 };

            // --- FUN√á√ïES DE MUNI√á√ÉO ---
            function atualizarLimiteBalas() {
                const tipo = document.getElementById('ammo-type').value;
                const input = document.getElementById('ammo-qtd');
                
                // Define limites baseados no tipo
                let max = 12; // Padr√£o (Bandoleira)
                if (tipo === 'cinturao') max = 24;
                if (tipo === 'aljava') max = 10;

                input.max = max;

                // Se tiver mais muni√ß√£o do que cabe no novo recipiente, corta o excesso
                // Ex: Tinha 24 balas, trocou pra Aljava, cai pra 10.
                if(parseInt(input.value) > max) {
                    input.value = max;
                }
                
                // Atualiza visual
                document.getElementById('ammo-display').innerText = input.value;
                
                // Muda o texto descritivo dependendo do tipo
                const labelTexto = (tipo === 'aljava') ? 'FLECHAS NA ALJAVA' : 'BALAS NO CINTO';
                // Acha a div logo abaixo do display para mudar o texto (opcional, mas fica legal)
                document.getElementById('ammo-display').nextElementSibling.innerText = labelTexto;

                // Atualiza dados globais
                municaoData.tipo = tipo;
                municaoData.qtd = parseInt(input.value);
                
                salvarFicha();
            }

            function salvarMunicao() {
            const input = document.getElementById('ammo-qtd');
            let val = parseInt(input.value);
            const max = parseInt(input.max);

            // Garante que n√£o ultrapasse o limite
            if(val > max) {
                val = max;
                input.value = max;
            }
            if(val < 0) {
                val = 0;
                input.value = 0;
            }

            document.getElementById('ammo-display').innerText = val;
            municaoData.qtd = val;
            salvarFicha();
        }

            function calcularCarga() {
                let total = 0;
                itensData.forEach(i => total += (parseFloat(i?.espaco) || 0));
                armasData.forEach(a => total += (parseFloat(a.espaco) || 0));
                
                const max = parseInt(document.getElementById('space-max').value) || 10;
                const el = document.getElementById('space-current');
                el.innerText = total;
                el.className = total > max ? 'space-display over' : 'space-display';
            }

            function toggleDescricao(btn, descRowId) {
                const descRow = document.getElementById(descRowId);
                descRow.classList.toggle('show');
                btn.classList.toggle('expanded');
                btn.textContent = descRow.classList.contains('show') ? '‚ñ≤' : '‚ñº';
            }

            function escapeHtml(text) {
                if (!text) return '';
                return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
            }

            // ==========================================
            // 5. SUPABASE (Salvar e Carregar)
            // ==========================================

            async function salvarFicha() {
                const status = document.getElementById('status');
                status.innerText = 'Salvando...';
                
                // 1. Pega dados atuais para n√£o sobrescrever
                const { data: current } = await client.from('Fichas').select('atributos').eq('nome_personagem', NOME_PERSONAGEM).single();
                let payload = current ? current.atributos : {};
                
                // 2. Monta o objeto de invent√°rio
                payload.inventario = {
                    items: itensData,
                    weapons: armasData,
                    maxLoad: document.getElementById('space-max').value,
                    municao: municaoData
                };

                // 3. Envia
                const { error } = await client.from('Fichas').update({ atributos: payload }).eq('nome_personagem', NOME_PERSONAGEM);
                
                if(!error) {
                    status.innerText = '‚Ä¢ Salvo ‚Ä¢';
                    setTimeout(() => status.innerText = '', 2000);
                } else {
                    console.error(error);
                    status.innerText = 'Erro ao salvar!';
                }
            }

            async function carregar() {
                const status = document.getElementById('status');
                status.innerText = 'Carregando...';
                
                const { data } = await client.from('Fichas').select('atributos').eq('nome_personagem', NOME_PERSONAGEM).single();

                if (data && data.atributos && data.atributos.inventario) {
                    const inv = data.atributos.inventario;
                    itensData = inv.items || [];
                    armasData = inv.weapons || []; // Garante que l√™ as armas do banco
                    document.getElementById('space-max').value = inv.maxLoad || 10;
                }

                if (data.atributos.inventario.municao) {
                    municaoData = data.atributos.inventario.municao;
                    document.getElementById('ammo-type').value = municaoData.tipo;
                    document.getElementById('ammo-qtd').value = municaoData.qtd;
                    atualizarLimiteBalas(); // Para setar o max correto visualmente
                }
                
                gerarLinhasItens();
                gerarTabelaArmas();
                status.innerText = 'Pronto';
            }

            // Inicializa√ß√£o
            carregar();


        // Realtime
        client.channel('inv-room').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'Fichas' }, 
        (payload) => {
            // Opcional: Atualizar se o mestre mudar algo
        }).subscribe();

    </script>

    <script>
        const paramsURL = new URLSearchParams(window.location.search);
        const nomeAtual = paramsURL.get('nome');
        if (nomeAtual) {
            document.querySelectorAll('a').forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('http') && !href.includes('?')) {
                    link.setAttribute('href', `${href}?nome=${nomeAtual}`);
                }
            });
        }
    </script>

</body>
</html>